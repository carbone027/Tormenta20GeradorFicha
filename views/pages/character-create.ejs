<%- include('../partials/header', { title: 'Criar Personagem' , activePage: 'createCharacter' }) %>

<%
// ===== ADICIONAR A FUNÇÃO AQUI, LOGO APÓS O INCLUDE DO HEADER =====
// Função para gerar ícones de poderes
function getPowerIcon(poder, tipo) {
  const nome = (poder.nome || '').toLowerCase();
  const tipoLower = (tipo || poder.tipo || '').toLowerCase();
  const descricao = (poder.descricao || '').toLowerCase();
  
  // Ícones específicos por palavra-chave no nome
  if (nome.includes('ataque') || nome.includes('golpe')) return '⚔️';
  if (nome.includes('defesa') || nome.includes('proteção')) return '🛡️';
  if (nome.includes('cura') || nome.includes('curar')) return '💚';
  if (nome.includes('fogo') || nome.includes('chamas')) return '🔥';
  if (nome.includes('gelo') || nome.includes('frio')) return '❄️';
  if (nome.includes('raio') || nome.includes('elétrico')) return '⚡';
  if (nome.includes('vento') || nome.includes('ar')) return '💨';
  if (nome.includes('terra') || nome.includes('pedra')) return '🌍';
  if (nome.includes('água') || nome.includes('aquático')) return '💧';
  if (nome.includes('luz') || nome.includes('sagrado')) return '☀️';
  if (nome.includes('trevas') || nome.includes('sombra')) return '🌑';
  if (nome.includes('movimento') || nome.includes('velocidade')) return '🏃';
  if (nome.includes('voo') || nome.includes('voar')) return '🦅';
  if (nome.includes('salto') || nome.includes('pular')) return '🦘';
  if (nome.includes('furtividade') || nome.includes('stealth')) return '👤';
  if (nome.includes('percepção') || nome.includes('visão')) return '👁️';
  if (nome.includes('força') || nome.includes('poder')) return '💪';
  if (nome.includes('garras') || nome.includes('presas')) return '🐾';
  if (nome.includes('asas')) return '🦅';
  if (nome.includes('cauda') || nome.includes('rabo')) return '🦎';
  if (nome.includes('chifres') || nome.includes('cornos')) return '🐂';
  if (nome.includes('pelo') || nome.includes('pelagem')) return '🐺';
  if (nome.includes('escamas') || nome.includes('escamoso')) return '🐍';
  if (nome.includes('veneno') || nome.includes('tóxico')) return '☣️';
  if (nome.includes('maldição') || nome.includes('amaldiçoar')) return '🖤';
  if (nome.includes('bênção') || nome.includes('abençoar')) return '🙏';
  if (nome.includes('sorte') || nome.includes('fortuna')) return '🍀';
  if (nome.includes('conhecimento') || nome.includes('saber')) return '📚';
  if (nome.includes('liderança') || nome.includes('comando')) return '👑';
  if (nome.includes('intimidação') || nome.includes('medo')) return '😠';
  if (nome.includes('persuasão') || nome.includes('convencer')) return '💬';
  if (nome.includes('diplomacia') || nome.includes('negociar')) return '🤝';
  if (nome.includes('tiro') || nome.includes('disparo')) return '🏹';
  if (nome.includes('crítico') || nome.includes('mortal')) return '💀';
  if (nome.includes('regeneração') || nome.includes('recuperar')) return '🌿';
  if (nome.includes('aura') || nome.includes('presença')) return '🌟';
  if (nome.includes('ritual') || nome.includes('cerimônia')) return '🕯️';
  if (nome.includes('runa') || nome.includes('marca')) return '📜';
  if (nome.includes('animal') || nome.includes('besta')) return '🐺';
  if (nome.includes('natureza') || nome.includes('selvagem')) return '🌿';
  if (nome.includes('caça') || nome.includes('rastrear')) return '🏹';
  if (nome.includes('heroico') || nome.includes('épico')) return '🏆';
  if (nome.includes('lendário') || nome.includes('mítico')) return '👑';
  if (nome.includes('tormenta') || nome.includes('corrupção')) return '💀';
  if (nome.includes('investida') || nome.includes('carga')) return '🏇';
  if (nome.includes('combo') || nome.includes('sequência')) return '🌀';
  if (nome.includes('rajada') || nome.includes('múltiplo')) return '💨';
  if (nome.includes('bloqueio') || nome.includes('parar')) return '🚫';
  if (nome.includes('esquiva') || nome.includes('desviar')) return '💨';
  if (nome.includes('absorção') || nome.includes('absorver')) return '🌀';
  if (nome.includes('teleporte') || nome.includes('transportar')) return '⚡';
  if (nome.includes('escalada') || nome.includes('escalar')) return '🧗';
  if (nome.includes('natação') || nome.includes('nadar')) return '🏊';
  if (nome.includes('acrobacia') || nome.includes('acrobático')) return '🤸';
  if (nome.includes('atletismo') || nome.includes('atlético')) return '💪';
  if (nome.includes('investigação') || nome.includes('investigar')) return '🔍';
  if (nome.includes('enganação') || nome.includes('enganar')) return '🎭';
  if (nome.includes('faro') || nome.includes('olfato')) return '👃';
  if (nome.includes('audição') || nome.includes('ouvir')) return '👂';
  
  // Ícones por tipo com variação
  const iconsByType = {
    'combate': ['⚔️', '🗡️', '🏹', '💪', '👊', '🛡️', '💥', '⚡'],
    'magia': ['🔮', '✨', '🪄', '🌟', '⚡', '🔥', '❄️', '💫'],
    'destino': ['🌟', '🎯', '💫', '🍀', '📈', '🎲', '💎', '⭐'],
    'racial': ['🧬', '👁️', '🦅', '🐺', '🌿', '⚡', '🐾', '💪'],
    'geral': ['⚡', '💡', '🔧', '🎯', '📚', '🏃', '💪', '🌟'],
    'concedido': ['⭐', '🙏', '✨', '💫', '🌟', '👑', '💎', '🔸'],
    'tormenta': ['💀', '☠️', '🖤', '👻', '🌑', '⚡', '💥', '🔥']
  };
  
  if (iconsByType[tipoLower]) {
    const icons = iconsByType[tipoLower];
    let hash = 0;
    for (let i = 0; i < nome.length; i++) {
      hash = ((hash << 5) - hash + nome.charCodeAt(i)) & 0xffffffff;
    }
    return icons[Math.abs(hash) % icons.length];
  }
  
  // Análise da descrição
  if (descricao.includes('dano') || descricao.includes('ataque')) return '⚔️';
  if (descricao.includes('cura') || descricao.includes('recupera')) return '💚';
  if (descricao.includes('movimento') || descricao.includes('mover')) return '🏃';
  if (descricao.includes('defesa') || descricao.includes('ca')) return '🛡️';
  if (descricao.includes('magia')) return '🔮';
  if (descricao.includes('perícia')) return '🎯';
  
  // Ícone padrão único
  const fallbackIcons = ['⚡', '✨', '🌟', '💫', '🔸', '🔹', '💎', '🎭', '🎯', '🔧'];
  let charSum = 0;
  for (let i = 0; i < nome.length; i++) {
    charSum += nome.charCodeAt(i);
  }
  return fallbackIcons[charSum % fallbackIcons.length];
}
// ===== FIM DA FUNÇÃO =====
%>

  <section class="content-section active">
    <h2>✨ Criar Novo Personagem</h2>
    <p style="text-align: center; margin-bottom: 2rem; color: #b8b8b8;">
      Dê vida ao seu herói! Preencha as informações abaixo para criar um personagem único e épico para suas aventuras em
      Arton.
    </p>

    <form action="/personagens/criar" method="POST" class="character-form" id="characterForm">
      <!-- Informações Básicas -->
      <div class="form-section">
        <h3>📝 Informações Básicas</h3>
        <div class="card">
          <div class="form-grid">
            <div class="form-group">
              <label for="nome">⚔️ Nome do Personagem *</label>
              <input type="text" id="nome" name="nome" required placeholder="Ex: Alaric Fortaleza, Lyanna Luaverde..."
                maxlength="100">
              <small>Escolha um nome que reflita a personalidade e origem do seu herói</small>
            </div>

            <div class="form-group">
              <label for="nivel">📊 Nível</label>
              <input type="number" id="nivel" name="nivel" value="1" min="1" max="20" required>
              <small>Nível inicial do personagem (geralmente 1)</small>
            </div>
          </div>
        </div>
      </div>

<!-- Atributos -->
      <div class="form-section">
        <h3>💪 Atributos</h3>
        <div class="card">
          <div class="atributos-info" style="display: none;">
            <p>📋 <strong>Sistema Livre:</strong> Você pode distribuir os atributos livremente. <span
                id="pontosRestantes" style="display: none;">27</span></p>
          </div>

          <div
            style="background: rgba(212, 175, 55, 0.1); border: 1px solid var(--accent-gold); border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: center;">
            <p>🎯 <strong>Sistema Livre de Distribuição:</strong> Ajuste os atributos conforme desejar (mínimo 3, máximo
              20).</p>
            <p>💡 <strong>Dica:</strong> Defina primeiro os valores que deseja, depois escolha a raça para aplicar os
              bônus!</p>
            <p>⚡ <strong>Novo Sistema:</strong> Bônus raciais são dobrados (+1 vira +2, +2 vira +4) e você pode ajustar
              livremente!</p>
          </div>

          <div class="atributos-grid">
            <div class="atributo-card">
              <label for="forca">💪 Força</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="forca">-</button>
                <input type="number" id="forca" name="forca" value="10" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="forca">+</button>
              </div>
              <small>Força física, ataques corpo a corpo</small>
              <div class="bonus-display" id="bonus-forca">+0</div>
            </div>

            <div class="atributo-card">
              <label for="destreza">🏃 Destreza</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="destreza">-</button>
                <input type="number" id="destreza" name="destreza" value="10" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="destreza">+</button>
              </div>
              <small>Agilidade, ataques à distância</small>
              <div class="bonus-display" id="bonus-destreza">+0</div>
            </div>

            <div class="atributo-card">
              <label for="constituicao">❤️ Constituição</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="constituicao">-</button>
                <input type="number" id="constituicao" name="constituicao" value="10" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="constituicao">+</button>
              </div>
              <small>Resistência, pontos de vida</small>
              <div class="bonus-display" id="bonus-constituicao">+0</div>
            </div>

            <div class="atributo-card">
              <label for="inteligencia">🧠 Inteligência</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="inteligencia">-</button>
                <input type="number" id="inteligencia" name="inteligencia" value="10" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="inteligencia">+</button>
              </div>
              <small>Raciocínio, magia arcana</small>
              <div class="bonus-display" id="bonus-inteligencia">+0</div>
            </div>

            <div class="atributo-card">
              <label for="sabedoria">🧙 Sabedoria</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="sabedoria">-</button>
                <input type="number" id="sabedoria" name="sabedoria" value="10" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="sabedoria">+</button>
              </div>
              <small>Percepção, magia divina</small>
              <div class="bonus-display" id="bonus-sabedoria">+0</div>
            </div>

            <div class="atributo-card">
              <label for="carisma">😎 Carisma</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="carisma">-</button>
                <input type="number" id="carisma" name="carisma" value="10" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="carisma">+</button>
              </div>
              <small>Personalidade, liderança</small>
              <div class="bonus-display" id="bonus-carisma">+0</div>
            </div>
          </div>
        </div>
      </div>

      

      <!-- Raça, Classe e Deus -->
      <div class="form-section">
        <h3>🧬 Origem e Vocação</h3>
        <div class="card">
          <div class="form-grid-three">
            <div class="form-group">
              <label for="raca_id">🧝 Raça *</label>
              <select id="raca_id" name="raca_id" required>
                <option value="">Escolha uma raça...</option>
                <% if (racas && racas.length> 0) { %>
                  <% racas.forEach(raca=> { %>
                    <option value="<%= raca.id %>" data-bonus='<%= JSON.stringify(raca.bonus_atributos) %>'>
                      <%= raca.nome %>
                    </option>
                    <% }); %>
                      <% } %>
              </select>
              <small>
                Define características físicas e habilidades raciais
                <br><em>⚠️ Bônus raciais são aplicados automaticamente após seleção</em>
              </small>
            </div>

            <div class="form-group">
              <label for="classe_id">⚔️ Classe *</label>
              <select id="classe_id" name="classe_id" required>
                <option value="">Escolha uma classe...</option>
                <% if (classes && classes.length> 0) { %>
                  <% classes.forEach(classe=> { %>
                    <option value="<%= classe.id %>" data-vida="<%= classe.pontos_vida_base %>"
                      data-mana="<%= classe.pontos_mana_base || 0 %>" data-atributo="<%= classe.atributo_principal %>">
                      <%= classe.nome %>
                    </option>
                    <% }); %>
                      <% } %>
              </select>
              <small>Determina habilidades e papel no grupo</small>
            </div>

            <div class="form-group">
              <label for="deus_id">⭐ Deus Patrono *</label>
              <select id="deus_id" name="deus_id" required>
                <option value="">Escolha um deus...</option>
                <% if (deuses && deuses.length> 0) { %>
                  <% deuses.forEach(deus=> { %>
                    <option value="<%= deus.id %>">
                      <%= deus.nome %> - <%= deus.dominio %>
                    </option>
                    <% }); %>
                      <% } %>
              </select>
              <small>
                Divindade que seu personagem venera
                <br><em>⚠️ Obrigatório: Todo herói precisa de fé para enfrentar Arton</em>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Perícias -->
<div class="form-section">
  <h3>🎯 Perícias do Personagem</h3>

  <div class="skills-main-container">
    <!-- Header Principal -->
    <div class="skills-header">
      <h3>
        <span>🎯</span>
        Sistema de Perícias
        <span>🎯</span>
      </h3>
      <p>Gerencie as habilidades e conhecimentos do seu personagem</p>
    </div>

    <!-- Explicação do Sistema -->
    <div class="skills-explanation">
      <div class="card explanation-card">
        <h4>📋 Como Funcionam as Perícias</h4>
        <div class="explanation-grid">
          <div class="explanation-item">
            <h5>🎲 Teste de Perícia</h5>
            <p><strong>1d20 + Metade do Nível + Atributo + Bônus de Treinamento</strong></p>
          </div>
          <div class="explanation-item">
            <h5>💪 Bônus de Treinamento</h5>
            <p>Níveis 1-6: +2 | Níveis 7-14: +4 | Níveis 15+: +6</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Perícias Automáticas de Classe -->
    <div class="class-skills-section" id="classSkillsSection" style="display: none;">
      <div class="class-skills-header">
        <h4 class="class-skills-title">
          <span>⚔️</span>
          Perícias de Classe
        </h4>
        <p class="class-skills-description">
          Estas perícias serão aplicadas automaticamente baseadas na classe escolhida
        </p>
      </div>

      <div id="classSkillsList" class="class-skills-list">
        <!-- Preenchido via JavaScript quando classe for selecionada -->
      </div>
    </div>

    <!-- Perícias por Bônus de Inteligência -->
    <div class="intelligence-skills-section" id="intelligenceSkillsSection" style="display: none;">
      <div class="intelligence-skills-header">
        <h4 class="intelligence-skills-title">
          <span>🧠</span>
          Perícias por Inteligência
        </h4>
        <p class="intelligence-skills-description">
          Escolha <span id="bonusSkillsCount">0</span> perícia(s) adicional(is) pelo seu modificador de Inteligência
        </p>
      </div>

      <div class="intelligence-skills-grid" id="intelligenceSkillsGrid">
        <!-- Preenchido via JavaScript baseado na inteligência -->
      </div>
    </div>

    <!-- Perícias Opcionais da Classe -->
    <div class="optional-skills-section" id="optionalSkillsSection" style="display: none;">
      <div class="optional-skills-header">
        <h4 class="optional-skills-title">
          <span>📚</span>
          Perícias Opcionais da Classe
        </h4>
        <p class="optional-skills-description">
          Escolha perícias adicionais da lista da sua classe
        </p>
      </div>

      <div class="optional-skills-grid" id="optionalSkillsGrid">
        <!-- Preenchido via JavaScript baseado na classe -->
      </div>
    </div>

    <!-- Todas as Perícias Disponíveis -->
    <% if (periciasSistema && Object.keys(periciasSistema).length > 0) { %>
      <div class="all-skills-section">
        <div class="all-skills-header">
          <h4 class="all-skills-title">
            <span>🎯</span>
            Todas as Perícias Disponíveis
          </h4>
          <p class="all-skills-description">
            Visualize todas as perícias do sistema organizadas por categoria
          </p>
        </div>

        <!-- Barra de Busca -->
        <div class="skills-search-container">
          <div class="skills-search-box">
            <span class="skills-search-icon">🔍</span>
            <input type="text" id="skillsSearchInput" class="skills-search-input"
              placeholder="Buscar perícias por nome, atributo ou categoria..." autocomplete="off">
            <div id="skillsSearchResults" class="skills-search-results"></div>
          </div>
        </div>

        <!-- Filtros Rápidos -->
        <div class="skills-quick-filters">
          <div class="quick-filters-title">🎯 Filtros por Atributo</div>
          <div class="quick-filters-buttons">
            <button type="button" class="quick-filter-btn active" data-filter="all">
              ✨ Todas
            </button>
            <button type="button" class="quick-filter-btn" data-filter="for">
              💪 Força
            </button>
            <button type="button" class="quick-filter-btn" data-filter="des">
              🏃 Destreza
            </button>
            <button type="button" class="quick-filter-btn" data-filter="con">
              ❤️ Constituição
            </button>
            <button type="button" class="quick-filter-btn" data-filter="int">
              🧠 Inteligência
            </button>
            <button type="button" class="quick-filter-btn" data-filter="sab">
              🧙 Sabedoria
            </button>
            <button type="button" class="quick-filter-btn" data-filter="car">
              😎 Carisma
            </button>
          </div>
        </div>

        <!-- Container das Perícias por Categoria -->
        <div class="skills-sections-container">
          <% Object.entries(periciasSistema).forEach(([categoria, pericias]) => { %>
            <% if (pericias && pericias.length > 0) { %>
              <div class="skill-category-section" data-category="<%= categoria %>">
                <div class="skill-category-header">
                  <h5 class="skill-category-title">
                    <% 
                      let categoryIcon = '🎯';
                      let categoryName = categoria;
                      switch(categoria.toLowerCase()) {
                        case 'física': categoryIcon = '🏃'; categoryName = 'Perícias Físicas'; break;
                        case 'combate': categoryIcon = '⚔️'; categoryName = 'Perícias de Combate'; break;
                        case 'conhecimento': categoryIcon = '📚'; categoryName = 'Perícias de Conhecimento'; break;
                        case 'social': categoryIcon = '💬'; categoryName = 'Perícias Sociais'; break;
                        case 'percepção': categoryIcon = '👁️'; categoryName = 'Perícias de Percepção'; break;
                        case 'resistência': categoryIcon = '🛡️'; categoryName = 'Perícias de Resistência'; break;
                        case 'medicina': categoryIcon = '💚'; categoryName = 'Perícias de Medicina'; break;
                        default: categoryIcon = '🎯'; categoryName = categoria.charAt(0).toUpperCase() + categoria.slice(1); break;
                      }
                    %>
                    <span><%= categoryIcon %></span>
                    <%= categoryName %>
                  </h5>
                  <div class="skill-category-count">(<%= pericias.length %> perícias)</div>
                  <button type="button" class="skill-category-toggle" data-target="<%= categoria %>">
                    <span class="toggle-icon">📁</span>
                  </button>
                </div>

                <div class="skills-grid" id="skillsGrid-<%= categoria %>">
                  <% pericias.forEach(pericia => { %>
                    <div class="skill-info-card" data-skill-id="<%= pericia.id %>" data-attribute="<%= pericia.atributo_chave %>">
                      <div class="skill-card-header">
                        <div class="skill-card-icon">
                          <% 
                            let skillIcon = '🎯';
                            const nome = pericia.nome.toLowerCase();
                            
                            // Ícones específicos por perícia
                            if (nome.includes('acrobacia')) skillIcon = '🤸';
                            else if (nome.includes('atletismo')) skillIcon = '💪';
                            else if (nome.includes('cavalgar')) skillIcon = '🐎';
                            else if (nome.includes('furtividade')) skillIcon = '👤';
                            else if (nome.includes('iniciativa')) skillIcon = '⚡';
                            else if (nome.includes('ladinagem')) skillIcon = '🔓';
                            else if (nome.includes('luta')) skillIcon = '👊';
                            else if (nome.includes('pilotagem')) skillIcon = '🚗';
                            else if (nome.includes('pontaria')) skillIcon = '🏹';
                            else if (nome.includes('reflexos')) skillIcon = '🤺';
                            else if (nome.includes('conhecimento')) skillIcon = '📚';
                            else if (nome.includes('guerra')) skillIcon = '⚔️';
                            else if (nome.includes('investigação')) skillIcon = '🔍';
                            else if (nome.includes('misticismo')) skillIcon = '🔮';
                            else if (nome.includes('nobreza')) skillIcon = '👑';
                            else if (nome.includes('ofício')) skillIcon = '🔨';
                            else if (nome.includes('religião')) skillIcon = '🙏';
                            else if (nome.includes('adestramento')) skillIcon = '🐕';
                            else if (nome.includes('atuação')) skillIcon = '🎭';
                            else if (nome.includes('diplomacia')) skillIcon = '🤝';
                            else if (nome.includes('enganação')) skillIcon = '🎭';
                            else if (nome.includes('intimidação')) skillIcon = '😠';
                            else if (nome.includes('jogatina')) skillIcon = '🎲';
                            else if (nome.includes('cura')) skillIcon = '💚';
                            else if (nome.includes('intuição')) skillIcon = '💡';
                            else if (nome.includes('percepção')) skillIcon = '👁️';
                            else if (nome.includes('sobrevivência')) skillIcon = '🏕️';
                            else if (nome.includes('fortitude')) skillIcon = '🛡️';
                            else if (nome.includes('vontade')) skillIcon = '🧠';
                          %>
                          <%= skillIcon %>
                        </div>

                        <h6 class="skill-card-name"><%= pericia.nome %></h6>
                        <p class="skill-card-attribute">
                          <% 
                            let attrName = '';
                            let attrIcon = '';
                            switch(pericia.atributo_chave) {
                              case 'for': attrName = 'Força'; attrIcon = '💪'; break;
                              case 'des': attrName = 'Destreza'; attrIcon = '🏃'; break;
                              case 'con': attrName = 'Constituição'; attrIcon = '❤️'; break;
                              case 'int': attrName = 'Inteligência'; attrIcon = '🧠'; break;
                              case 'sab': attrName = 'Sabedoria'; attrIcon = '🧙'; break;
                              case 'car': attrName = 'Carisma'; attrIcon = '😎'; break;
                              default: attrName = pericia.atributo_chave; attrIcon = '🎯'; break;
                            }
                          %>
                          <%= attrIcon %> <%= attrName %>
                        </p>
                      </div>

                      <div class="skill-card-content">
                        <p class="skill-card-description"><%= pericia.descricao %></p>

                        <!-- Tags da Perícia -->
                        <div class="skill-tags">
                          <span class="skill-tag category"><%= categoryName %></span>
                          <span class="skill-tag attribute"><%= attrName %></span>
                        </div>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </div>
            <% } %>
          <% }); %>
        </div>
      </div>
    <% } else { %>
      <!-- Estado vazio -->
      <div class="skills-empty-state">
        <div class="skills-empty-icon">📜</div>
        <h4 class="skills-empty-title">Nenhuma Perícia Disponível</h4>
        <p class="skills-empty-description">
          Não há perícias disponíveis para seleção no momento.
        </p>
      </div>
    <% } %>
  </div>
</div>

      <!-- Poderes -->
      <!-- Seção de Poderes Melhorada para Character Create -->
      <div class="form-section">
        <h3>✨ Poderes</h3>

        <div class="powers-main-container">
          <!-- Header Principal -->
          <div class="powers-header">
            <h3>
              <span>⚡</span>
              Sistema de Poderes
              <span>⚡</span>
            </h3>
            <p>Escolha poderes para personalizar seu personagem</p>
          </div>

          <!-- A seção de Poderes de Classe será inserida aqui via JavaScript -->

          <!-- Poderes Raciais (Automáticos) -->
          <div class="racial-powers-section" id="racialPowersSection" style="display: none;">
            <div class="racial-powers-header">
              <h4 class="racial-powers-title">
                <span>🧬</span>
                Poderes Raciais
              </h4>
              <p class="racial-powers-description">
                Estes poderes serão aplicados automaticamente baseados na raça escolhida
              </p>
            </div>

            <div id="racialPowersList" class="racial-powers-list">
              <!-- Preenchido via JavaScript quando raça for selecionada -->
            </div>
          </div>

          <!-- Poderes Disponíveis para Seleção -->
          <% if (poderesDisponiveis && Object.keys(poderesDisponiveis).length> 0) { %>
            <div class="power-selection-section">
              <div class="power-selection-header">
                <h4 class="power-selection-title">
                  <span>⚡</span>
                  Poderes Gerais
                </h4>
                <p class="power-selection-description">
                  Escolha poderes gerais para personalizar seu personagem (opcional)
                </p>
              </div>

              <!-- Barra de Busca -->
              <div class="powers-search-container">
                <div class="powers-search-box">
                  <span class="powers-search-icon">🔍</span>
                  <input type="text" id="powersSearchInput" class="powers-search-input"
                    placeholder="Buscar poderes por nome, descrição ou tipo..." autocomplete="off">
                  <div id="powersSearchResults" class="powers-search-results"></div>
                </div>
              </div>

              <!-- Filtros Rápidos -->
              <div class="powers-quick-filters">
                <div class="quick-filters-title">🎯 Filtros Rápidos</div>
                <div class="quick-filters-buttons">
                  <button type="button" class="quick-filter-btn active" data-filter="all">
                    ✨ Todos
                  </button>
                  
                  <!-- Verificar se existe cada tipo antes de mostrar o filtro -->
                  <% if (typeof poderesDisponiveis !== 'undefined' && poderesDisponiveis) { %>
                    <% Object.keys(poderesDisponiveis).forEach(tipo => { %>
                      <% if (poderesDisponiveis[tipo] && poderesDisponiveis[tipo].length > 0) { %>
                        <button type="button" class="quick-filter-btn" data-filter="<%= tipo %>">
                          <% 
                            let tipoIcon = '✨';
                            let tipoNome = tipo;
                            switch(tipo.toLowerCase()) {
                              case 'geral': 
                                tipoIcon = '⚡'; 
                                tipoNome = 'Gerais'; 
                                break;
                              case 'combate': 
                                tipoIcon = '⚔️'; 
                                tipoNome = 'Combate'; 
                                break;
                              case 'destino': 
                                tipoIcon = '🌟'; 
                                tipoNome = 'Destino'; 
                                break;
                              case 'magia': 
                                tipoIcon = '🔮'; 
                                tipoNome = 'Magia'; 
                                break;
                              case 'racial':
                                tipoIcon = '🧬'; 
                                tipoNome = 'Raciais'; 
                                break;
                              case 'concedido':
                                tipoIcon = '⭐'; 
                                tipoNome = 'Concedidos'; 
                                break;
                              case 'tormenta':
                                tipoIcon = '💀'; 
                                tipoNome = 'Tormenta'; 
                                break;
                              default:
                                tipoIcon = '✨';
                                tipoNome = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                            }
                          %>
                          <%= tipoIcon %> <%= tipoNome %>
                        </button>
                      <% } %>
                    <% }); %>
                  <% } %>
                </div>
              </div>

              <!-- Container dos Poderes -->
              <div class="powers-sections-container">
                <% Object.entries(poderesDisponiveis).forEach(([tipo, poderes])=> { %>
                  <% if (poderes && poderes.length> 0) { %>
                    <div class="power-type-section" data-type="<%= tipo.toLowerCase() %>">
                      <div class="power-type-header">
                        <h5 class="power-type-title">
                          <% let tipoIcon='✨' ; let tipoNome=tipo; switch(tipo) { case 'geral' : tipoIcon='⚡' ;
                            tipoNome='Poderes Gerais' ; break; case 'combate' : tipoIcon='⚔️' ;
                            tipoNome='Poderes de Combate' ; break; case 'destino' : tipoIcon='🌟' ;
                            tipoNome='Poderes de Destino' ; break; case 'magia' : tipoIcon='🔮' ;
                            tipoNome='Poderes de Magia' ; break; } %>
                            <span>
                              <%= tipoIcon %>
                            </span>
                            <%= tipoNome %>
                        </h5>
                        <div class="power-type-count">(<%= poderes.length %> disponíveis)</div>
                        <button type="button" class="power-type-toggle" data-target="<%= tipo %>">
                          <span class="toggle-icon">📁</span>
                        </button>
                      </div>

                      <div class="powers-grid" id="powersGrid-<%= tipo %>">
                        <% poderes.forEach(poder=> { %>
                          <label class="power-checkbox-label">
                            <input type="checkbox" name="poderes_selecionados" value="<%= poder.id %>"
                              class="power-checkbox power-checkbox-filter" data-name="<%= poder.nome.toLowerCase() %>"
                              data-type="<%= tipo %>" data-description="<%= poder.descricao.toLowerCase() %>">

                            <div class="power-card" data-power-id="<%= poder.id %>" data-type="<%= tipo.toLowerCase() %>">
                              <div class="power-card-header">
                                <div class="power-card-icon">
                                  <%= getPowerIcon(poder, tipo) %>
                                </div>

                                <h6 class="power-card-name">
                                  <%= poder.nome %>
                                </h6>
                                <p class="power-card-type">
                                  <%= tipoNome %>
                                </p>
                              </div>

                              <div class="power-card-content">
                                <p class="power-card-description">
                                  <%= poder.descricao %>
                                </p>

                                <div class="power-card-details">
                                  <% if (poder.pre_requisitos) { %>
                                    <div class="power-detail-item">
                                      <span class="power-detail-label">📋</span>
                                      <span class="power-detail-value"><strong>Pré-req:</strong>
                                        <%= poder.pre_requisitos %>
                                      </span>
                                    </div>
                                    <% } %>

                                      <% if (poder.custo_pm && poder.custo_pm> 0) { %>
                                        <div class="power-detail-item">
                                          <span class="power-detail-label">💙</span>
                                          <span class="power-detail-value"><strong>Custo:</strong>
                                            <%= poder.custo_pm %> PM
                                          </span>
                                        </div>
                                        <% } %>

                                          <% if (poder.alcance && poder.alcance !=='Pessoal' ) { %>
                                            <div class="power-detail-item">
                                              <span class="power-detail-label">🎯</span>
                                              <span class="power-detail-value"><strong>Alcance:</strong>
                                                <%= poder.alcance %>
                                              </span>
                                            </div>
                                            <% } %>

                                              <% if (poder.duracao && poder.duracao !=='Instantâneo' ) { %>
                                                <div class="power-detail-item">
                                                  <span class="power-detail-label">⏱️</span>
                                                  <span class="power-detail-value"><strong>Duração:</strong>
                                                    <%= poder.duracao %>
                                                  </span>
                                                </div>
                                                <% } %>
                                </div>

                                <!-- Tags do Poder -->
                                <div class="power-tags">
                                  <span class="power-tag">
                                    <%= tipoNome %>
                                  </span>
                                  <% if (poder.custo_pm && poder.custo_pm> 0) { %>
                                    <span class="power-tag cost">
                                      <%= poder.custo_pm %> PM
                                    </span>
                                    <% } %>
                                      <% if (poder.pre_requisitos) { %>
                                        <span class="power-tag requirement">Pré-req</span>
                                        <% } %>
                                </div>
                              </div>
                            </div>
                          </label>
                          <% }); %>
                      </div>
                    </div>
                    <% } %>
                      <% }); %>
              </div>
            </div>
            <% } else { %>
              <!-- Estado vazio -->
              <div class="powers-empty-state">
                <div class="powers-empty-icon">📜</div>
                <h4 class="powers-empty-title">Nenhum Poder Disponível</h4>
                <p class="powers-empty-description">
                  Não há poderes disponíveis para seleção no momento.
                </p>
              </div>
              <% } %>
        </div>
      </div>

      <!-- Magias (ADICIONAR APÓS A SEÇÃO DE PODERES em character-create.ejs) -->
<div class="form-section">
  <h3>🔮 Magias do Personagem</h3>

  <div class="spells-main-container">
    <!-- Header Principal -->
    <div class="spells-header">
      <h3>
        <span>🔮</span>
        Sistema de Magias
        <span>🔮</span>
      </h3>
      <p>Configure as magias que seu personagem conhece</p>
    </div>

    <!-- Explicação do Sistema -->
    <div class="spells-explanation">
      <div class="card explanation-card">
        <h4>📋 Como Funcionam as Magias</h4>
        <div class="explanation-grid">
          <div class="explanation-item">
            <h5>🎭 Classes Mágicas</h5>
            <p>Apenas certas classes podem lançar magias</p>
          </div>
          <div class="explanation-item">
            <h5>🔘 Círculos</h5>
            <p>Magias são organizadas em círculos (1º ao 5º)</p>
          </div>
          <div class="explanation-item">
            <h5>📊 Nível Mínimo</h5>
            <p>Cada círculo requer um nível mínimo da classe</p>
          </div>
          <div class="explanation-item">
            <h5>🎯 Tipos de Magia</h5>
            <p>Arcana, Divina ou Universal conforme a classe</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Verificação de Classe Mágica -->
    <div class="class-magic-check" id="classMagicCheck" style="display: none;">
      <div class="magic-check-card">
        <h4 id="magicCheckTitle">🔮 Verificando Capacidade Mágica...</h4>
        <p id="magicCheckDescription">Analisando se a classe selecionada pode lançar magias...</p>
      </div>
    </div>

    <!-- Magias Automáticas de Classe -->
    <div class="class-spells-section" id="classSpellsSection" style="display: none;">
      <div class="class-spells-header">
        <h4 class="class-spells-title">
          <span>⚔️</span>
          Magias de Classe
        </h4>
        <p class="class-spells-description">
          Estas magias serão aplicadas automaticamente baseadas na classe e nível escolhidos
        </p>
      </div>

      <div id="classSpellsList" class="class-spells-list">
        <!-- Preenchido via JavaScript quando classe for selecionada -->
      </div>
    </div>

    <!-- Seleção de Magias Disponíveis -->
    <div class="spell-selection-section" id="spellSelectionSection" style="display: none;">
      <div class="spell-selection-header">
        <h4 class="spell-selection-title">
          <span>✨</span>
          Magias Disponíveis
        </h4>
        <p class="spell-selection-description" id="spellSelectionDescription">
          Escolha magias adicionais para seu personagem
        </p>
      </div>

      <!-- Filtros para Magias -->
      <div class="spells-filters">
        <div class="spells-search-container">
          <div class="spells-search-box">
            <span class="spells-search-icon">🔍</span>
            <input type="text" id="spellsSearchInput" class="spells-search-input"
              placeholder="Buscar magias por nome ou descrição..." autocomplete="off">
            <div id="spellsSearchResults" class="spells-search-results"></div>
          </div>
        </div>

        <!-- Filtros Rápidos -->
        <div class="spells-quick-filters">
          <div class="quick-filters-title">🎯 Filtros por Círculo</div>
          <div class="quick-filters-buttons" id="spellCircleFilters">
            <button type="button" class="quick-filter-btn active" data-filter="all">
              ✨ Todas
            </button>
            <!-- Círculos serão adicionados dinamicamente baseado na classe -->
          </div>
        </div>

        <!-- Filtros por Tipo -->
        <div class="spells-type-filters" id="spellTypeFilters">
          <div class="quick-filters-title">🌟 Filtros por Tipo</div>
          <div class="quick-filters-buttons">
            <!-- Tipos serão adicionados dinamicamente baseado na classe -->
          </div>
        </div>
      </div>

      <!-- Container das Magias por Círculo -->
      <div class="spells-circles-container" id="spellsCirclesContainer">
        <!-- Preenchido via JavaScript baseado na classe e nível -->
      </div>
    </div>

    <!-- Estado: Classe Não-Mágica -->
    <div class="non-magical-class" id="nonMagicalClass" style="display: none;">
      <div class="non-magical-card">
        <div class="non-magical-icon">⚔️</div>
        <h4 class="non-magical-title">Classe Não-Mágica</h4>
        <p class="non-magical-description">
          A classe selecionada não possui acesso a magias.
          <br>
          <strong>Classes Mágicas:</strong> Arcanista, Bardo, Clérigo, Druida
        </p>
      </div>
    </div>

    <!-- Estado Vazio -->
    <div class="spells-empty-state" id="spellsEmptyState">
      <div class="spells-empty-icon">🔮</div>
      <h4 class="spells-empty-title">Selecione uma Classe</h4>
      <p class="spells-empty-description">
        Escolha uma classe mágica para visualizar as magias disponíveis.
      </p>
    </div>
  </div>
</div>

      <!-- Características Derivadas -->
      <div class="form-section">
        <h3>📊 Características Derivadas</h3>
        <div class="card">
          <div class="form-grid-three">
            <div class="form-group">
              <label for="pontos_vida">❤️ Pontos de Vida</label>
              <input type="number" id="pontos_vida" name="pontos_vida" value="0" min="1" required readonly>
              <small>Calculado automaticamente baseado na classe e Constituição</small>
            </div>

            <div class="form-group">
              <label for="pontos_mana">🔵 Pontos de Mana</label>
              <input type="number" id="pontos_mana" name="pontos_mana" value="0" min="0" readonly>
              <small>Para classes que usam magia</small>
            </div>

            <div class="form-group">
              <label for="ca">🛡️ Classe de Armadura</label>
              <input type="number" id="ca" name="ca" value="10" min="1" readonly>
              <small>10 + modificador de Destreza (pode ser alterado por equipamentos)</small>
            </div>
          </div>

          <div class="form-group">
            <label for="experiencia">⭐ Experiência</label>
            <input type="number" id="experiencia" name="experiencia" value="0" min="0">
            <small>Pontos de experiência acumulados (opcional)</small>
          </div>
        </div>
      </div>

      <!-- Background e Roleplay -->
      <div class="form-section">
        <h3>🎭 História e Personalidade</h3>
        <div class="card">
          <div class="form-group">
            <label for="historia_pessoal">📜 História Pessoal</label>
            <textarea id="historia_pessoal" name="historia_pessoal" rows="4"
              placeholder="Descreva a origem, família, eventos marcantes da vida do personagem..."></textarea>
            <small>Onde nasceu? Como cresceu? O que o motivou a se tornar um aventureiro?</small>
          </div>

          <div class="form-group">
            <label for="personalidade">🎭 Personalidade</label>
            <textarea id="personalidade" name="personalidade" rows="3"
              placeholder="Corajoso, sarcástico, tímido, arrogante... Como seu personagem se comporta?"></textarea>
            <small>Traços de personalidade, maneirismos, medos, vícios...</small>
          </div>

          <div class="form-group">
            <label for="objetivos">🎯 Objetivos e Motivações</label>
            <textarea id="objetivos" name="objetivos" rows="3"
              placeholder="O que seu personagem busca? Vingança? Conhecimento? Riqueza? Justiça?"></textarea>
            <small>O que move seu personagem? Quais são seus sonhos e ambições?</small>
          </div>
        </div>
      </div>

      <!-- Preview do Personagem -->
      <div class="form-section">
        <h3>👁️ Preview do Personagem</h3>
        <div class="card character-preview" id="characterPreview">
          <div class="preview-content">
            <div class="preview-header">
              <h4 id="previewNome">Nome do Personagem</h4>
              <p id="previewClasseRaca">Classe Raça - Nível 1</p>
            </div>

            <div class="preview-stats">
              <div class="preview-atributos">
                <h5>Atributos (com bônus raciais)</h5>
                <div class="attrs-preview" id="attrsPreview">
                  <!-- Preenchido via JavaScript -->
                </div>
              </div>

              <div class="preview-derivadas">
                <h5>Características</h5>
                <div class="derivadas-preview" id="derivadasPreview">
                  <!-- Preenchido via JavaScript -->
                </div>
              </div>
            </div>

            <div class="preview-poderes" id="previewPoderes" style="display: none;">
              <h5>Poderes Selecionados</h5>
              <div class="poderes-preview" id="poderesPreview">
                <!-- Preenchido via JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="form-actions">
        <button type="submit" class="nav-btn">🎨 Criar Personagem</button>
        <a href="/personagens" class="btn btn-secondary">📋 Meus Personagens</a>
        <button type="button" class="btn btn-secondary" id="resetForm">🔄 Resetar</button>
      </div>
    </form>
  </section>

  
  <!-- Scripts -->
  <script src="/scripts/character-create.js"></script>
  <script src="/scripts/class-powers.js"></script>

  <%- include('../partials/footer') %>