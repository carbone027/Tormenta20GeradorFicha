<%- include('../partials/header', { title: `Editar ${character ? character.nome : 'Personagem' }`, activePage: 'editCharacter' }) %>

<%
// ===== ADICIONAR A FUNÃ‡ÃƒO AQUI, LOGO APÃ“S O INCLUDE DO HEADER =====
// FunÃ§Ã£o para gerar Ã­cones de poderes
function getPowerIcon(poder, tipo) {
  const nome = (poder.nome || '').toLowerCase();
  const tipoLower = (tipo || poder.tipo || '').toLowerCase();
  const descricao = (poder.descricao || '').toLowerCase();
  
  // Ãcones especÃ­ficos por palavra-chave no nome
  if (nome.includes('ataque') || nome.includes('golpe')) return 'âš”ï¸';
  if (nome.includes('defesa') || nome.includes('proteÃ§Ã£o')) return 'ğŸ›¡ï¸';
  if (nome.includes('cura') || nome.includes('curar')) return 'ğŸ’š';
  if (nome.includes('fogo') || nome.includes('chamas')) return 'ğŸ”¥';
  if (nome.includes('gelo') || nome.includes('frio')) return 'â„ï¸';
  if (nome.includes('raio') || nome.includes('elÃ©trico')) return 'âš¡';
  if (nome.includes('vento') || nome.includes('ar')) return 'ğŸ’¨';
  if (nome.includes('terra') || nome.includes('pedra')) return 'ğŸŒ';
  if (nome.includes('Ã¡gua') || nome.includes('aquÃ¡tico')) return 'ğŸ’§';
  if (nome.includes('luz') || nome.includes('sagrado')) return 'â˜€ï¸';
  if (nome.includes('trevas') || nome.includes('sombra')) return 'ğŸŒ‘';
  if (nome.includes('movimento') || nome.includes('velocidade')) return 'ğŸƒ';
  if (nome.includes('voo') || nome.includes('voar')) return 'ğŸ¦…';
  if (nome.includes('salto') || nome.includes('pular')) return 'ğŸ¦˜';
  if (nome.includes('furtividade') || nome.includes('stealth')) return 'ğŸ‘¤';
  if (nome.includes('percepÃ§Ã£o') || nome.includes('visÃ£o')) return 'ğŸ‘ï¸';
  if (nome.includes('forÃ§a') || nome.includes('poder')) return 'ğŸ’ª';
  if (nome.includes('garras') || nome.includes('presas')) return 'ğŸ¾';
  if (nome.includes('asas')) return 'ğŸ¦…';
  if (nome.includes('cauda') || nome.includes('rabo')) return 'ğŸ¦';
  if (nome.includes('chifres') || nome.includes('cornos')) return 'ğŸ‚';
  if (nome.includes('pelo') || nome.includes('pelagem')) return 'ğŸº';
  if (nome.includes('escamas') || nome.includes('escamoso')) return 'ğŸ';
  if (nome.includes('veneno') || nome.includes('tÃ³xico')) return 'â˜£ï¸';
  if (nome.includes('maldiÃ§Ã£o') || nome.includes('amaldiÃ§oar')) return 'ğŸ–¤';
  if (nome.includes('bÃªnÃ§Ã£o') || nome.includes('abenÃ§oar')) return 'ğŸ™';
  if (nome.includes('sorte') || nome.includes('fortuna')) return 'ğŸ€';
  if (nome.includes('conhecimento') || nome.includes('saber')) return 'ğŸ“š';
  if (nome.includes('lideranÃ§a') || nome.includes('comando')) return 'ğŸ‘‘';
  if (nome.includes('intimidaÃ§Ã£o') || nome.includes('medo')) return 'ğŸ˜ ';
  if (nome.includes('persuasÃ£o') || nome.includes('convencer')) return 'ğŸ’¬';
  if (nome.includes('diplomacia') || nome.includes('negociar')) return 'ğŸ¤';
  if (nome.includes('tiro') || nome.includes('disparo')) return 'ğŸ¹';
  if (nome.includes('crÃ­tico') || nome.includes('mortal')) return 'ğŸ’€';
  if (nome.includes('regeneraÃ§Ã£o') || nome.includes('recuperar')) return 'ğŸŒ¿';
  if (nome.includes('aura') || nome.includes('presenÃ§a')) return 'ğŸŒŸ';
  if (nome.includes('ritual') || nome.includes('cerimÃ´nia')) return 'ğŸ•¯ï¸';
  if (nome.includes('runa') || nome.includes('marca')) return 'ğŸ“œ';
  if (nome.includes('animal') || nome.includes('besta')) return 'ğŸº';
  if (nome.includes('natureza') || nome.includes('selvagem')) return 'ğŸŒ¿';
  if (nome.includes('caÃ§a') || nome.includes('rastrear')) return 'ğŸ¹';
  if (nome.includes('heroico') || nome.includes('Ã©pico')) return 'ğŸ†';
  if (nome.includes('lendÃ¡rio') || nome.includes('mÃ­tico')) return 'ğŸ‘‘';
  if (nome.includes('tormenta') || nome.includes('corrupÃ§Ã£o')) return 'ğŸ’€';
  if (nome.includes('investida') || nome.includes('carga')) return 'ğŸ‡';
  if (nome.includes('combo') || nome.includes('sequÃªncia')) return 'ğŸŒ€';
  if (nome.includes('rajada') || nome.includes('mÃºltiplo')) return 'ğŸ’¨';
  if (nome.includes('bloqueio') || nome.includes('parar')) return 'ğŸš«';
  if (nome.includes('esquiva') || nome.includes('desviar')) return 'ğŸ’¨';
  if (nome.includes('absorÃ§Ã£o') || nome.includes('absorver')) return 'ğŸŒ€';
  if (nome.includes('teleporte') || nome.includes('transportar')) return 'âš¡';
  if (nome.includes('escalada') || nome.includes('escalar')) return 'ğŸ§—';
  if (nome.includes('nataÃ§Ã£o') || nome.includes('nadar')) return 'ğŸŠ';
  if (nome.includes('acrobacia') || nome.includes('acrobÃ¡tico')) return 'ğŸ¤¸';
  if (nome.includes('atletismo') || nome.includes('atlÃ©tico')) return 'ğŸ’ª';
  if (nome.includes('investigaÃ§Ã£o') || nome.includes('investigar')) return 'ğŸ”';
  if (nome.includes('enganaÃ§Ã£o') || nome.includes('enganar')) return 'ğŸ­';
  if (nome.includes('faro') || nome.includes('olfato')) return 'ğŸ‘ƒ';
  if (nome.includes('audiÃ§Ã£o') || nome.includes('ouvir')) return 'ğŸ‘‚';
  
  // Ãcones por tipo com variaÃ§Ã£o
  const iconsByType = {
    'combate': ['âš”ï¸', 'ğŸ—¡ï¸', 'ğŸ¹', 'ğŸ’ª', 'ğŸ‘Š', 'ğŸ›¡ï¸', 'ğŸ’¥', 'âš¡'],
    'magia': ['ğŸ”®', 'âœ¨', 'ğŸª„', 'ğŸŒŸ', 'âš¡', 'ğŸ”¥', 'â„ï¸', 'ğŸ’«'],
    'destino': ['ğŸŒŸ', 'ğŸ¯', 'ğŸ’«', 'ğŸ€', 'ğŸ“ˆ', 'ğŸ²', 'ğŸ’', 'â­'],
    'racial': ['ğŸ§¬', 'ğŸ‘ï¸', 'ğŸ¦…', 'ğŸº', 'ğŸŒ¿', 'âš¡', 'ğŸ¾', 'ğŸ’ª'],
    'geral': ['âš¡', 'ğŸ’¡', 'ğŸ”§', 'ğŸ¯', 'ğŸ“š', 'ğŸƒ', 'ğŸ’ª', 'ğŸŒŸ'],
    'concedido': ['â­', 'ğŸ™', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ‘‘', 'ğŸ’', 'ğŸ”¸'],
    'tormenta': ['ğŸ’€', 'â˜ ï¸', 'ğŸ–¤', 'ğŸ‘»', 'ğŸŒ‘', 'âš¡', 'ğŸ’¥', 'ğŸ”¥']
  };
  
  if (iconsByType[tipoLower]) {
    const icons = iconsByType[tipoLower];
    let hash = 0;
    for (let i = 0; i < nome.length; i++) {
      hash = ((hash << 5) - hash + nome.charCodeAt(i)) & 0xffffffff;
    }
    return icons[Math.abs(hash) % icons.length];
  }
  
  // AnÃ¡lise da descriÃ§Ã£o
  if (descricao.includes('dano') || descricao.includes('ataque')) return 'âš”ï¸';
  if (descricao.includes('cura') || descricao.includes('recupera')) return 'ğŸ’š';
  if (descricao.includes('movimento') || descricao.includes('mover')) return 'ğŸƒ';
  if (descricao.includes('defesa') || descricao.includes('ca')) return 'ğŸ›¡ï¸';
  if (descricao.includes('magia')) return 'ğŸ”®';
  if (descricao.includes('perÃ­cia')) return 'ğŸ¯';
  
  // Ãcone padrÃ£o Ãºnico
  const fallbackIcons = ['âš¡', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ’', 'ğŸ­', 'ğŸ¯', 'ğŸ”§'];
  let charSum = 0;
  for (let i = 0; i < nome.length; i++) {
    charSum += nome.charCodeAt(i);
  }
  return fallbackIcons[charSum % fallbackIcons.length];
}
// ===== FIM DA FUNÃ‡ÃƒO =====
%>

<section class="content-section active">
  <h2>âœï¸ Editar Personagem</h2>
  <p style="text-align: center; margin-bottom: 2rem; color: #b8b8b8;">
    Modifique as informaÃ§Ãµes do seu herÃ³i. Todas as alteraÃ§Ãµes serÃ£o salvas automaticamente quando vocÃª confirmar.
  </p>

  <% if (character) { %>
    <form action="/personagens/<%= character.id %>?_method=PUT" method="POST" class="character-form" id="characterForm">
      <!-- InformaÃ§Ãµes BÃ¡sicas -->
      <div class="form-section">
        <h3>ğŸ“ InformaÃ§Ãµes BÃ¡sicas</h3>
        <div class="card">
          <div class="form-grid">
            <div class="form-group">
              <label for="nome">âš”ï¸ Nome do Personagem *</label>
              <input type="text" id="nome" name="nome" required value="<%= character.nome %>" placeholder="Ex: Alaric Fortaleza, Lyanna Luaverde..." maxlength="100">
              <small>Escolha um nome que reflita a personalidade e origem do seu herÃ³i</small>
            </div>

            <div class="form-group">
              <label for="nivel">ğŸ“Š NÃ­vel</label>
              <input type="number" id="nivel" name="nivel" value="<%= character.nivel || 1 %>" min="1" max="20" required>
              <small>NÃ­vel atual do personagem</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Atributos -->
      <div class="form-section">
        <h3>ğŸ’ª Atributos</h3>
        <div class="card">
          <div class="atributos-info" style="display: none;">
            <p>ğŸ“‹ <strong>Sistema Livre:</strong> VocÃª pode distribuir os atributos livremente. <span id="pontosRestantes" style="display: none;">0</span></p>
          </div>

          <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid var(--accent-gold); border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: center;">
            <p>ğŸ¯ <strong>Sistema Livre de DistribuiÃ§Ã£o:</strong> Ajuste os atributos conforme desejar (mÃ­nimo 3, mÃ¡ximo 20).</p>
            <p>ğŸ’¡ <strong>Dica:</strong> VocÃª pode ajustar livremente os valores dos atributos!</p>
          </div>

          <div class="atributos-grid">
            <div class="atributo-card">
              <label for="forca">ğŸ’ª ForÃ§a</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="forca">-</button>
                <input type="number" id="forca" name="forca" value="<%= character.forca || 10 %>" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="forca">+</button>
              </div>
              <small>ForÃ§a fÃ­sica, ataques corpo a corpo</small>
              <div class="bonus-display" id="bonus-forca">+0</div>
            </div>

            <div class="atributo-card">
              <label for="destreza">ğŸƒ Destreza</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="destreza">-</button>
                <input type="number" id="destreza" name="destreza" value="<%= character.destreza || 10 %>" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="destreza">+</button>
              </div>
              <small>Agilidade, ataques Ã  distÃ¢ncia</small>
              <div class="bonus-display" id="bonus-destreza">+0</div>
            </div>

            <div class="atributo-card">
              <label for="constituicao">â¤ï¸ ConstituiÃ§Ã£o</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="constituicao">-</button>
                <input type="number" id="constituicao" name="constituicao" value="<%= character.constituicao || 10 %>" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="constituicao">+</button>
              </div>
              <small>ResistÃªncia, pontos de vida</small>
              <div class="bonus-display" id="bonus-constituicao">+0</div>
            </div>

            <div class="atributo-card">
              <label for="inteligencia">ğŸ§  InteligÃªncia</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="inteligencia">-</button>
                <input type="number" id="inteligencia" name="inteligencia" value="<%= character.inteligencia || 10 %>" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="inteligencia">+</button>
              </div>
              <small>RaciocÃ­nio, magia arcana</small>
              <div class="bonus-display" id="bonus-inteligencia">+0</div>
            </div>

            <div class="atributo-card">
              <label for="sabedoria">ğŸ§™ Sabedoria</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="sabedoria">-</button>
                <input type="number" id="sabedoria" name="sabedoria" value="<%= character.sabedoria || 10 %>" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="sabedoria">+</button>
              </div>
              <small>PercepÃ§Ã£o, magia divina</small>
              <div class="bonus-display" id="bonus-sabedoria">+0</div>
            </div>

            <div class="atributo-card">
              <label for="carisma">ğŸ˜ Carisma</label>
              <div class="atributo-controls">
                <button type="button" class="attr-btn minus" data-attr="carisma">-</button>
                <input type="number" id="carisma" name="carisma" value="<%= character.carisma || 10 %>" min="3" max="20" readonly>
                <button type="button" class="attr-btn plus" data-attr="carisma">+</button>
              </div>
              <small>Personalidade, lideranÃ§a</small>
              <div class="bonus-display" id="bonus-carisma">+0</div>
            </div>
          </div>
        </div>
      </div>


      <!-- RaÃ§a, Classe e Deus -->
      <div class="form-section">
        <h3>ğŸ§¬ Origem e VocaÃ§Ã£o</h3>
        <div class="card">
          <div class="form-grid-three">
            <div class="form-group">
              <label for="raca_id">ğŸ§ RaÃ§a *</label>
              <select id="raca_id" name="raca_id" required>
                <option value="">Escolha uma raÃ§a...</option>
                <% if (racas && racas.length > 0) { %>
                  <% racas.forEach(raca => { %>
                    <option value="<%= raca.id %>" data-bonus='<%= JSON.stringify(raca.bonus_atributos || {}) %>' <%= character.raca_id == raca.id ? 'selected' : '' %>>
                      <%= raca.nome %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
              <small>Define caracterÃ­sticas fÃ­sicas e habilidades raciais</small>
            </div>

            <div class="form-group">
              <label for="classe_id">âš”ï¸ Classe *</label>
              <select id="classe_id" name="classe_id" required>
                <option value="">Escolha uma classe...</option>
                <% if (classes && classes.length > 0) { %>
                  <% classes.forEach(classe => { %>
                    <option value="<%= classe.id %>" data-vida="<%= classe.pontos_vida_base %>" data-mana="<%= classe.pontos_mana_base || 0 %>" data-atributo="<%= classe.atributo_principal %>" <%= character.classe_id == classe.id ? 'selected' : '' %>>
                      <%= classe.nome %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
              <small>Determina habilidades e papel no grupo</small>
            </div>

            <div class="form-group">
              <label for="deus_id">â­ Deus Patrono *</label>
              <select id="deus_id" name="deus_id" required>
                <option value="">Escolha um deus...</option>
                <% if (deuses && deuses.length > 0) { %>
                  <% deuses.forEach(deus => { %>
                    <option value="<%= deus.id %>" <%= character.deus_id == deus.id ? 'selected' : '' %>>
                      <%= deus.nome %> - <%= deus.dominio %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
              <small>
                Divindade que seu personagem venera
                <br><em>âš ï¸ ObrigatÃ³rio: Todo herÃ³i precisa de fÃ© para enfrentar Arton</em>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- PerÃ­cias -->
<div class="form-section">
  <h3>ğŸ¯ PerÃ­cias do Personagem</h3>

  <div class="skills-main-container">
    <!-- Header Principal -->
    <div class="skills-header">
      <h3>
        <span>ğŸ¯</span>
        Sistema de PerÃ­cias
        <span>ğŸ¯</span>
      </h3>
      <p>Gerencie as habilidades e conhecimentos do seu personagem</p>
    </div>

    <!-- ExplicaÃ§Ã£o do Sistema -->
    <div class="skills-explanation">
      <div class="card explanation-card">
        <h4>ğŸ“‹ Como Funcionam as PerÃ­cias</h4>
        <div class="explanation-grid">
          <div class="explanation-item">
            <h5>ğŸ² Teste de PerÃ­cia</h5>
            <p><strong>1d20 + Metade do NÃ­vel + Atributo + BÃ´nus de Treinamento</strong></p>
          </div>
          <div class="explanation-item">
            <h5>ğŸ’ª BÃ´nus de Treinamento</h5>
            <p>NÃ­veis 1-6: +2 | NÃ­veis 7-14: +4 | NÃ­veis 15+: +6</p>
          </div>
          <div class="explanation-item">
            <h5>ğŸ“Š Seu NÃ­vel</h5>
            <p>NÃ­vel <%= character.nivel || 1 %> = +<%= Math.floor((character.nivel || 1) / 2) %> de bÃ´nus</p>
          </div>
          <div class="explanation-item">
            <h5>ğŸ§  BÃ´nus por InteligÃªncia</h5>
            <p>
              <% 
                const intMod = Math.floor(((character.inteligencia || 10) - 10) / 2);
                const bonusSkills = Math.max(0, intMod);
              %>
              Int <%= character.inteligencia || 10 %> = <%= bonusSkills %> perÃ­cia<%= bonusSkills !== 1 ? 's' : '' %> adicional<%= bonusSkills !== 1 ? 'is' : '' %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- PerÃ­cias Atuais do Personagem -->
    <% if (periciasPersonagem && periciasPersonagem.length > 0) { %>
      <div class="character-skills-section">
        <div class="character-skills-header">
          <h4 class="character-skills-title">
            <span>ğŸŒŸ</span>
            PerÃ­cias Atuais
          </h4>
          <p class="character-skills-count">
            <%= periciasPersonagem.length %> perÃ­cias configuradas
          </p>
        </div>

        <!-- Organizar perÃ­cias por origem -->
        <% 
          const periciasPorOrigem = {};
          periciasPersonagem.forEach(pericia => {
            if (!periciasPorOrigem[pericia.origem]) {
              periciasPorOrigem[pericia.origem] = [];
            }
            periciasPorOrigem[pericia.origem].push(pericia);
          });
        %>

        <% Object.entries(periciasPorOrigem).forEach(([origem, pericias]) => { %>
          <div class="character-skill-origin-section">
            <h5 class="character-skill-origin-title">
              <% 
                let originIcon = 'ğŸ“';
                let originText = origem;
                switch(origem) {
                  case 'classe': 
                    originIcon = 'âš”ï¸'; 
                    originText = 'PerÃ­cias de Classe'; 
                    break;
                  case 'escolha': 
                    originIcon = 'ğŸ“š'; 
                    originText = 'PerÃ­cias Escolhidas'; 
                    break;
                  case 'inteligencia': 
                    originIcon = 'ğŸ§ '; 
                    originText = 'PerÃ­cias por InteligÃªncia'; 
                    break;
                  case 'raca': 
                    originIcon = 'ğŸ§¬'; 
                    originText = 'PerÃ­cias Raciais'; 
                    break;
                }
              %>
              <span><%= originIcon %></span>
              <%= originText %>
              <span style="font-size: 0.8em; color: var(--text-muted);">(<%= pericias.length %>)</span>
            </h5>

            <div class="skills-list">
              <% pericias.forEach(pericia => { %>
                <div class="character-skill-card">
                  <div class="character-skill-header">
                    <h6 class="character-skill-name">
                      <% 
                        // Ãcone da perÃ­cia
                        let skillIcon = 'ğŸ¯';
                        const nome = (pericia.nome || '').toLowerCase();
                        
                        if (nome.includes('acrobacia')) skillIcon = 'ğŸ¤¸';
                        else if (nome.includes('atletismo')) skillIcon = 'ğŸ’ª';
                        else if (nome.includes('cavalgar')) skillIcon = 'ğŸ';
                        else if (nome.includes('furtividade')) skillIcon = 'ğŸ‘¤';
                        else if (nome.includes('iniciativa')) skillIcon = 'âš¡';
                        else if (nome.includes('ladinagem')) skillIcon = 'ğŸ”“';
                        else if (nome.includes('luta')) skillIcon = 'ğŸ‘Š';
                        else if (nome.includes('pilotagem')) skillIcon = 'ğŸš—';
                        else if (nome.includes('pontaria')) skillIcon = 'ğŸ¹';
                        else if (nome.includes('reflexos')) skillIcon = 'ğŸ¤º';
                        else if (nome.includes('conhecimento')) skillIcon = 'ğŸ“š';
                        else if (nome.includes('guerra')) skillIcon = 'âš”ï¸';
                        else if (nome.includes('investigaÃ§Ã£o')) skillIcon = 'ğŸ”';
                        else if (nome.includes('misticismo')) skillIcon = 'ğŸ”®';
                        else if (nome.includes('nobreza')) skillIcon = 'ğŸ‘‘';
                        else if (nome.includes('ofÃ­cio')) skillIcon = 'ğŸ”¨';
                        else if (nome.includes('religiÃ£o')) skillIcon = 'ğŸ™';
                        else if (nome.includes('adestramento')) skillIcon = 'ğŸ•';
                        else if (nome.includes('atuaÃ§Ã£o')) skillIcon = 'ğŸ­';
                        else if (nome.includes('diplomacia')) skillIcon = 'ğŸ¤';
                        else if (nome.includes('enganaÃ§Ã£o')) skillIcon = 'ğŸ­';
                        else if (nome.includes('intimidaÃ§Ã£o')) skillIcon = 'ğŸ˜ ';
                        else if (nome.includes('jogatina')) skillIcon = 'ğŸ²';
                        else if (nome.includes('cura')) skillIcon = 'ğŸ’š';
                        else if (nome.includes('intuiÃ§Ã£o')) skillIcon = 'ğŸ’¡';
                        else if (nome.includes('percepÃ§Ã£o')) skillIcon = 'ğŸ‘ï¸';
                        else if (nome.includes('sobrevivÃªncia')) skillIcon = 'ğŸ•ï¸';
                        else if (nome.includes('fortitude')) skillIcon = 'ğŸ›¡ï¸';
                        else if (nome.includes('vontade')) skillIcon = 'ğŸ§ ';
                      %>
                      <%= skillIcon %> <%= pericia.nome %>
                    </h6>
                    
                    <div class="skill-status-badges">
                      <% if (pericia.treinado) { %>
                        <span class="skill-status-badge trained">ğŸ¯ Treinada</span>
                      <% } else { %>
                        <span class="skill-status-badge untrained">âŒ NÃ£o Treinada</span>
                      <% } %>
                      
                      <% if (pericia.especialista) { %>
                        <span class="skill-status-badge expert">â­ Especialista</span>
                      <% } %>
                      
                      <span class="skill-status-badge bonus">
                        ğŸ² +<%= pericia.bonus_total || 0 %>
                      </span>
                    </div>
                  </div>
                  
                  <div class="character-skill-details">
                    <!-- Atributo chave -->
                    <div class="skill-attribute">
                      <% 
                        let attrIcon = 'ğŸ¯';
                        let attrName = pericia.atributo_chave || 'N/A';
                        switch(pericia.atributo_chave) {
                          case 'for': attrIcon = 'ğŸ’ª'; attrName = 'ForÃ§a'; break;
                          case 'des': attrIcon = 'ğŸƒ'; attrName = 'Destreza'; break;
                          case 'con': attrIcon = 'â¤ï¸'; attrName = 'ConstituiÃ§Ã£o'; break;
                          case 'int': attrIcon = 'ğŸ§ '; attrName = 'InteligÃªncia'; break;
                          case 'sab': attrIcon = 'ğŸ§™'; attrName = 'Sabedoria'; break;
                          case 'car': attrIcon = 'ğŸ˜'; attrName = 'Carisma'; break;
                        }
                      %>
                      <strong>Atributo:</strong> <%= attrIcon %> <%= attrName %>
                    </div>
                    
                    <!-- Categoria -->
                    <div class="skill-category">
                      <strong>Categoria:</strong> <%= pericia.categoria || 'Geral' %>
                    </div>
                    
                    <!-- Origem -->
                    <div class="skill-origin">
                      <strong>Origem:</strong> <%= originIcon %> <%= originText.replace('PerÃ­cias ', '') %>
                    </div>
                    
                    <!-- CÃ¡lculo do bÃ´nus -->
                    <div class="skill-bonus-breakdown">
                      <strong>CÃ¡lculo do BÃ´nus:</strong>
                      <div class="bonus-items">
                        <span>NÃ­vel: +<%= pericia.bonus_nivel || 0 %></span>
                        <span>Atributo: <%= pericia.bonus_atributo >= 0 ? '+' : '' %><%= pericia.bonus_atributo || 0 %></span>
                        <% if (pericia.treinado) { %>
                          <span>Treinamento: +<%= pericia.bonus_treinamento || 0 %></span>
                        <% } %>
                        <% if (pericia.especialista) { %>
                          <span>Especialista: +<%= pericia.bonus_treinamento || 0 %></span>
                        <% } %>
                        <span><strong>Total: +<%= pericia.bonus_total || 0 %></strong></span>
                      </div>
                    </div>
                    
                    <!-- ObservaÃ§Ãµes -->
                    <% if (pericia.observacoes) { %>
                      <div class="skill-notes">
                        <strong>ObservaÃ§Ãµes:</strong> <%= pericia.observacoes %>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- PerÃ­cias DisponÃ­veis para SeleÃ§Ã£o/EdiÃ§Ã£o -->
    <% if (periciasSistema && Object.keys(periciasSistema).length > 0) { %>
      <div class="skill-selection-section">
        <div class="skill-selection-header">
          <h4 class="skill-selection-title">
            <span>ğŸ“š</span>
            Gerenciar PerÃ­cias
          </h4>
          <p class="skill-selection-description">
            Modifique as perÃ­cias escolhidas do seu personagem (perÃ­cias de classe sÃ£o gerenciadas automaticamente)
          </p>
        </div>

        <!-- PerÃ­cias por BÃ´nus de InteligÃªncia -->
        <% if (bonusSkills > 0) { %>
          <div class="intelligence-skills-section">
            <div class="intelligence-skills-header">
              <h5 class="intelligence-skills-title">
                <span>ğŸ§ </span>
                PerÃ­cias por InteligÃªncia
              </h5>
              <p class="intelligence-skills-description">
                VocÃª pode escolher <%= bonusSkills %> perÃ­cia<%= bonusSkills !== 1 ? 's' : '' %> adicional<%= bonusSkills !== 1 ? 'is' : '' %> pelo seu modificador de InteligÃªncia (+<%= intMod %>)
              </p>
            </div>

            <div class="intelligence-skills-grid">
              <% Object.values(periciasSistema).flat().forEach(pericia => { %>
                <% 
                  // Verificar se a perÃ­cia jÃ¡ estÃ¡ selecionada por inteligÃªncia
                  const isSelectedByInt = periciasPersonagem && periciasPersonagem.some(p => 
                    p.id == pericia.id && p.origem === 'inteligencia'
                  );
                %>
                
                <label class="intelligence-skill-label">
                  <input type="checkbox" name="pericias_inteligencia" value="<%= pericia.id %>" 
                         class="intelligence-skill-checkbox" <%= isSelectedByInt ? 'checked' : '' %>>
                  <div class="intelligence-skill-content">
                    <div class="intelligence-skill-header">
                      <span class="skill-icon">
                        <% 
                          let skillIcon = 'ğŸ¯';
                          const nome = (pericia.nome || '').toLowerCase();
                          
                          if (nome.includes('acrobacia')) skillIcon = 'ğŸ¤¸';
                          else if (nome.includes('atletismo')) skillIcon = 'ğŸ’ª';
                          else if (nome.includes('cavalgar')) skillIcon = 'ğŸ';
                          else if (nome.includes('furtividade')) skillIcon = 'ğŸ‘¤';
                          else if (nome.includes('iniciativa')) skillIcon = 'âš¡';
                          else if (nome.includes('ladinagem')) skillIcon = 'ğŸ”“';
                          else if (nome.includes('luta')) skillIcon = 'ğŸ‘Š';
                          else if (nome.includes('pilotagem')) skillIcon = 'ğŸš—';
                          else if (nome.includes('pontaria')) skillIcon = 'ğŸ¹';
                          else if (nome.includes('reflexos')) skillIcon = 'ğŸ¤º';
                          else if (nome.includes('conhecimento')) skillIcon = 'ğŸ“š';
                          else if (nome.includes('guerra')) skillIcon = 'âš”ï¸';
                          else if (nome.includes('investigaÃ§Ã£o')) skillIcon = 'ğŸ”';
                          else if (nome.includes('misticismo')) skillIcon = 'ğŸ”®';
                          else if (nome.includes('nobreza')) skillIcon = 'ğŸ‘‘';
                          else if (nome.includes('ofÃ­cio')) skillIcon = 'ğŸ”¨';
                          else if (nome.includes('religiÃ£o')) skillIcon = 'ğŸ™';
                          else if (nome.includes('adestramento')) skillIcon = 'ğŸ•';
                          else if (nome.includes('atuaÃ§Ã£o')) skillIcon = 'ğŸ­';
                          else if (nome.includes('diplomacia')) skillIcon = 'ğŸ¤';
                          else if (nome.includes('enganaÃ§Ã£o')) skillIcon = 'ğŸ­';
                          else if (nome.includes('intimidaÃ§Ã£o')) skillIcon = 'ğŸ˜ ';
                          else if (nome.includes('jogatina')) skillIcon = 'ğŸ²';
                          else if (nome.includes('cura')) skillIcon = 'ğŸ’š';
                          else if (nome.includes('intuiÃ§Ã£o')) skillIcon = 'ğŸ’¡';
                          else if (nome.includes('percepÃ§Ã£o')) skillIcon = 'ğŸ‘ï¸';
                          else if (nome.includes('sobrevivÃªncia')) skillIcon = 'ğŸ•ï¸';
                          else if (nome.includes('fortitude')) skillIcon = 'ğŸ›¡ï¸';
                          else if (nome.includes('vontade')) skillIcon = 'ğŸ§ ';
                        %>
                        <%= skillIcon %>
                      </span>
                      <span class="skill-name"><%= pericia.nome %></span>
                    </div>
                    <p class="skill-attribute">
                      <% 
                        let attrIcon = 'ğŸ¯';
                        let attrName = pericia.atributo_chave || 'N/A';
                        switch(pericia.atributo_chave) {
                          case 'for': attrIcon = 'ğŸ’ª'; attrName = 'ForÃ§a'; break;
                          case 'des': attrIcon = 'ğŸƒ'; attrName = 'Destreza'; break;
                          case 'con': attrIcon = 'â¤ï¸'; attrName = 'ConstituiÃ§Ã£o'; break;
                          case 'int': attrIcon = 'ğŸ§ '; attrName = 'InteligÃªncia'; break;
                          case 'sab': attrIcon = 'ğŸ§™'; attrName = 'Sabedoria'; break;
                          case 'car': attrIcon = 'ğŸ˜'; attrName = 'Carisma'; break;
                        }
                      %>
                      <%= attrIcon %> <%= attrName %>
                    </p>
                    <p class="skill-category"><%= pericia.categoria || 'Geral' %></p>
                  </div>
                </label>
              <% }); %>
            </div>
          </div>
        <% } %>

        <!-- PerÃ­cias Opcionais da Classe -->
        <% if (periciasDaClasse && periciasDaClasse.length > 0) { %>
          <div class="class-optional-skills-section">
            <div class="class-optional-skills-header">
              <h5 class="class-optional-skills-title">
                <span>âš”ï¸</span>
                PerÃ­cias Opcionais da Classe
              </h5>
              <p class="class-optional-skills-description">
                PerÃ­cias que vocÃª pode escolher baseado na sua classe
              </p>
            </div>

            <div class="class-optional-skills-grid">
              <% periciasDaClasse.filter(p => p.opcional && !p.obrigatoria).forEach(pericia => { %>
                <% 
                  // Verificar se a perÃ­cia jÃ¡ estÃ¡ selecionada
                  const isSelected = periciasPersonagem && periciasPersonagem.some(p => 
                    p.id == pericia.id && p.origem === 'escolha'
                  );
                %>
                
                <label class="class-optional-skill-label">
                  <input type="checkbox" name="pericias_selecionadas" value="<%= pericia.id %>" 
                         class="class-optional-skill-checkbox" <%= isSelected ? 'checked' : '' %>>
                  <div class="class-optional-skill-content">
                    <div class="class-optional-skill-header">
                      <span class="skill-icon">
                        <% 
                          let skillIcon = 'ğŸ¯';
                          const nome = (pericia.nome || '').toLowerCase();
                          
                          if (nome.includes('acrobacia')) skillIcon = 'ğŸ¤¸';
                          else if (nome.includes('atletismo')) skillIcon = 'ğŸ’ª';
                          else if (nome.includes('cavalgar')) skillIcon = 'ğŸ';
                          else if (nome.includes('furtividade')) skillIcon = 'ğŸ‘¤';
                          else if (nome.includes('iniciativa')) skillIcon = 'âš¡';
                          else if (nome.includes('ladinagem')) skillIcon = 'ğŸ”“';
                          else if (nome.includes('luta')) skillIcon = 'ğŸ‘Š';
                          else if (nome.includes('pilotagem')) skillIcon = 'ğŸš—';
                          else if (nome.includes('pontaria')) skillIcon = 'ğŸ¹';
                          else if (nome.includes('reflexos')) skillIcon = 'ğŸ¤º';
                          else if (nome.includes('conhecimento')) skillIcon = 'ğŸ“š';
                          else if (nome.includes('guerra')) skillIcon = 'âš”ï¸';
                          else if (nome.includes('investigaÃ§Ã£o')) skillIcon = 'ğŸ”';
                          else if (nome.includes('misticismo')) skillIcon = 'ğŸ”®';
                          else if (nome.includes('nobreza')) skillIcon = 'ğŸ‘‘';
                          else if (nome.includes('ofÃ­cio')) skillIcon = 'ğŸ”¨';
                          else if (nome.includes('religiÃ£o')) skillIcon = 'ğŸ™';
                          else if (nome.includes('adestramento')) skillIcon = 'ğŸ•';
                          else if (nome.includes('atuaÃ§Ã£o')) skillIcon = 'ğŸ­';
                          else if (nome.includes('diplomacia')) skillIcon = 'ğŸ¤';
                          else if (nome.includes('enganaÃ§Ã£o')) skillIcon = 'ğŸ­';
                          else if (nome.includes('intimidaÃ§Ã£o')) skillIcon = 'ğŸ˜ ';
                          else if (nome.includes('jogatina')) skillIcon = 'ğŸ²';
                          else if (nome.includes('cura')) skillIcon = 'ğŸ’š';
                          else if (nome.includes('intuiÃ§Ã£o')) skillIcon = 'ğŸ’¡';
                          else if (nome.includes('percepÃ§Ã£o')) skillIcon = 'ğŸ‘ï¸';
                          else if (nome.includes('sobrevivÃªncia')) skillIcon = 'ğŸ•ï¸';
                          else if (nome.includes('fortitude')) skillIcon = 'ğŸ›¡ï¸';
                          else if (nome.includes('vontade')) skillIcon = 'ğŸ§ ';
                        %>
                        <%= skillIcon %>
                      </span>
                      <span class="skill-name"><%= pericia.nome %></span>
                    </div>
                    <p class="skill-attribute">
                      <% 
                        let attrIcon = 'ğŸ¯';
                        let attrName = pericia.atributo_chave || 'N/A';
                        switch(pericia.atributo_chave) {
                          case 'for': attrIcon = 'ğŸ’ª'; attrName = 'ForÃ§a'; break;
                          case 'des': attrIcon = 'ğŸƒ'; attrName = 'Destreza'; break;
                          case 'con': attrIcon = 'â¤ï¸'; attrName = 'ConstituiÃ§Ã£o'; break;
                          case 'int': attrIcon = 'ğŸ§ '; attrName = 'InteligÃªncia'; break;
                          case 'sab': attrIcon = 'ğŸ§™'; attrName = 'Sabedoria'; break;
                          case 'car': attrIcon = 'ğŸ˜'; attrName = 'Carisma'; break;
                        }
                      %>
                      <%= attrIcon %> <%= attrName %>
                    </p>
                    <% if (pericia.descricao) { %>
                      <p class="skill-description"><%= pericia.descricao %></p>
                    <% } %>
                  </div>
                </label>
              <% }); %>
            </div>
          </div>
        <% } %>
      </div>
    <% } else { %>
      <!-- Estado vazio -->
      <div class="skills-empty-state">
        <div class="skills-empty-icon">ğŸ“œ</div>
        <h4 class="skills-empty-title">Nenhuma PerÃ­cia DisponÃ­vel</h4>
        <p class="skills-empty-description">
          NÃ£o hÃ¡ perÃ­cias disponÃ­veis para ediÃ§Ã£o no momento.
        </p>
      </div>
    <% } %>
  </div>
</div>

      <!-- Poderes -->
      <div class="form-section">
        <h3>âœ¨ Poderes</h3>

        <div class="powers-main-container">
          <!-- Header Principal -->
          <div class="powers-header">
            <h3>
              <span>âš¡</span>
              Sistema de Poderes
              <span>âš¡</span>
            </h3>
            <p>Gerencie os poderes do seu personagem</p>
          </div>

          <!-- A seÃ§Ã£o de Poderes de Classe serÃ¡ inserida aqui via JavaScript -->

          <!-- Poderes Atuais do Personagem -->
          <% if (poderesPersonagem && poderesPersonagem.length > 0) { %>
            <div class="character-powers-section">
              <div class="character-powers-header">
                <h4 class="character-powers-title">
                  <span>ğŸŒŸ</span>
                  Poderes Atuais
                </h4>
                <p class="character-powers-count">
                  <%= poderesPersonagem.length %> poderes ativos
                </p>
              </div>

              <!-- Organizar poderes por fonte -->
              <% 
                const poderesPorFonte = {};
                poderesPersonagem.forEach(poder => {
                  if (!poderesPorFonte[poder.fonte]) {
                    poderesPorFonte[poder.fonte] = [];
                  }
                  poderesPorFonte[poder.fonte].push(poder);
                });
              %>

              <% Object.entries(poderesPorFonte).forEach(([fonte, poderes]) => { %>
                <div class="character-power-type-section">
                  <h5 class="character-power-type-title">
                    <% 
                      let sourceIcon = 'ğŸ“';
                      let sourceText = fonte;
                      switch(fonte) {
                        case 'raca': 
                          sourceIcon = 'ğŸ§¬'; 
                          sourceText = 'Poderes Raciais'; 
                          break;
                        case 'escolha': 
                          sourceIcon = 'âš¡'; 
                          sourceText = 'Poderes Escolhidos'; 
                          break;
                        case 'classe': 
                          sourceIcon = 'âš”ï¸'; 
                          sourceText = 'Poderes de Classe'; 
                          break;
                        case 'deus': 
                          sourceIcon = 'â­'; 
                          sourceText = 'Poderes Divinos'; 
                          break;
                      }
                    %>
                    <span><%= sourceIcon %></span>
                    <%= sourceText %>
                    <span style="font-size: 0.8em; color: var(--text-muted);">(<%= poderes.length %>)</span>
                  </h5>

                  <div class="powers-list">
                    <% poderes.forEach(poder => { %>
                      <div class="character-power-card">
                        <div class="character-power-header">
                          <h6 class="character-power-name"><%= poder.nome %></h6>
                          <span class="character-power-source-badge">
                            <%= sourceIcon %> <%= sourceText.replace('Poderes ', '') %>
                          </span>
                        </div>
                        
                        <div class="character-power-description">
                          <%= poder.descricao %>
                        </div>
                        
                        <% if (poder.pre_requisitos || poder.custo_pm || poder.observacoes) { %>
                          <div class="character-power-details">
                            <% if (poder.pre_requisitos) { %>
                              <div class="character-power-detail">
                                <div class="character-power-detail-label">ğŸ“‹ PrÃ©-requisitos</div>
                                <p class="character-power-detail-value"><%= poder.pre_requisitos %></p>
                              </div>
                            <% } %>
                            
                            <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                              <div class="character-power-detail">
                                <div class="character-power-detail-label">ğŸ’™ Custo</div>
                                <p class="character-power-detail-value"><%= poder.custo_pm %> PM</p>
                              </div>
                            <% } %>
                            
                            <% if (poder.observacoes) { %>
                              <div class="character-power-detail">
                                <div class="character-power-detail-label">ğŸ“ ObservaÃ§Ãµes</div>
                                <p class="character-power-detail-value"><%= poder.observacoes %></p>
                              </div>
                            <% } %>
                          </div>
                        <% } %>
                      </div>
                    <% }); %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } %>

          <!-- Poderes DisponÃ­veis para SeleÃ§Ã£o/EdiÃ§Ã£o -->
          <% if (poderesDisponiveis && Object.keys(poderesDisponiveis).length > 0) { %>
            <div class="power-selection-section">
              <div class="power-selection-header">
                <h4 class="power-selection-title">
                  <span>âš¡</span>
                  Gerenciar Poderes Gerais
                </h4>
                <p class="power-selection-description">
                  Modifique os poderes gerais do seu personagem (poderes raciais e de classe sÃ£o gerenciados automaticamente)
                </p>
              </div>

              <!-- Barra de Busca -->
              <div class="powers-search-container">
                <div class="powers-search-box">
                  <span class="powers-search-icon">ğŸ”</span>
                  <input type="text" id="powersSearchInput" class="powers-search-input" placeholder="Buscar poderes por nome, descriÃ§Ã£o ou tipo..." autocomplete="off">
                  <div id="powersSearchResults" class="powers-search-results"></div>
                </div>
              </div>

              <!-- Filtros RÃ¡pidos -->
              <div class="powers-quick-filters">
                <div class="quick-filters-title">ğŸ¯ Filtros RÃ¡pidos</div>
                <div class="quick-filters-buttons">
                  <button type="button" class="quick-filter-btn active" data-filter="all">âœ¨ Todos</button>
                  <button type="button" class="quick-filter-btn" data-filter="selected">âœ… Selecionados</button>
                  <button type="button" class="quick-filter-btn" data-filter="available">ğŸ“‹ DisponÃ­veis</button>
                  <button type="button" class="quick-filter-btn" data-filter="combate">âš”ï¸ Combate</button>
                  <button type="button" class="quick-filter-btn" data-filter="destino">ğŸŒŸ Destino</button>
                  <button type="button" class="quick-filter-btn" data-filter="magia">ğŸ”® Magia</button>
                </div>
              </div>

              <!-- Container dos Poderes -->
              <div class="powers-sections-container">
                <% Object.entries(poderesDisponiveis).forEach(([tipo, poderes]) => { %>
                  <% if (poderes && poderes.length > 0) { %>
                    <div class="power-type-section" data-type="<%= tipo %>">
                      <div class="power-type-header">
                        <h5 class="power-type-title">
                          <% 
                            let tipoIcon = 'âœ¨';
                            let tipoNome = tipo;
                            switch(tipo) {
                              case 'combate': 
                                tipoIcon = 'âš”ï¸'; 
                                tipoNome = 'Poderes de Combate'; 
                                break;
                              case 'destino': 
                                tipoIcon = 'ğŸŒŸ'; 
                                tipoNome = 'Poderes de Destino'; 
                                break;
                              case 'magia': 
                                tipoIcon = 'ğŸ”®'; 
                                tipoNome = 'Poderes de Magia'; 
                                break;
                              case 'geral':
                                tipoIcon = 'âš¡'; 
                                tipoNome = 'Poderes Gerais'; 
                                break;
                            }

                            // Contar quantos estÃ£o selecionados
                            let selectedCount = 0;
                            if (poderesPersonagem) {
                              selectedCount = poderes.filter(poder => 
                                poderesPersonagem.some(p => p.id == poder.id && p.fonte === 'escolha')
                              ).length;
                            }
                          %>
                          <span><%= tipoIcon %></span>
                          <%= tipoNome %>
                        </h5>
                        <div class="power-type-count">
                          (<%= selectedCount %>/<%= poderes.length %> selecionados)
                        </div>
                        <button type="button" class="power-type-toggle" data-target="<%= tipo %>">
                          <span class="toggle-icon">ğŸ“</span>
                        </button>
                      </div>

                      <div class="powers-grid" id="powersGrid-<%= tipo %>">
                        <% poderes.forEach(poder => { %>
                          <% 
                            // Verificar se o poder jÃ¡ estÃ¡ selecionado
                            let isSelected = false;
                            if (poderesPersonagem) {
                              isSelected = poderesPersonagem.some(p => p.id == poder.id && p.fonte === 'escolha');
                            }
                          %>

                          <label class="power-checkbox-label">
                            <input type="checkbox" name="poderes_selecionados" value="<%= poder.id %>" class="power-checkbox power-checkbox-filter" data-name="<%= poder.nome.toLowerCase() %>" data-type="<%= tipo %>" data-description="<%= poder.descricao.toLowerCase() %>" data-selected="<%= isSelected %>" <%= isSelected ? 'checked' : '' %>>

                            <div class="power-card <%= isSelected ? 'selected' : '' %>" data-power-id="<%= poder.id %>">
                              <div class="power-card-header">
                                <% if (isSelected) { %>
                                  <div class="power-card-source">âœ… Ativo</div>
                                <% } %>

                                <div class="power-card-icon"><%= getPowerIcon(poder, tipo) %></div>

                                <h6 class="power-card-name"><%= poder.nome %></h6>
                                <p class="power-card-type"><%= tipoNome %></p>
                              </div>

                              <div class="power-card-content">
                                <p class="power-card-description"><%= poder.descricao %></p>

                                <div class="power-card-details">
                                  <% if (poder.pre_requisitos) { %>
                                    <div class="power-detail-item">
                                      <span class="power-detail-label">ğŸ“‹</span>
                                      <span class="power-detail-value"><strong>PrÃ©-req:</strong> <%= poder.pre_requisitos %></span>
                                    </div>
                                  <% } %>

                                  <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                                    <div class="power-detail-item">
                                      <span class="power-detail-label">ğŸ’™</span>
                                      <span class="power-detail-value"><strong>Custo:</strong> <%= poder.custo_pm %> PM</span>
                                    </div>
                                  <% } %>
                                </div>

                                <!-- Tags do Poder -->
                                <div class="power-tags">
                                  <span class="power-tag"><%= tipoNome %></span>
                                  <% if (isSelected) { %>
                                    <span class="power-tag" style="background: var(--success-green); color: white; border-color: var(--success-green);">Ativo</span>
                                  <% } %>
                                  <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                                    <span class="power-tag cost"><%= poder.custo_pm %> PM</span>
                                  <% } %>
                                  <% if (poder.pre_requisitos) { %>
                                    <span class="power-tag requirement">PrÃ©-req</span>
                                  <% } %>
                                </div>
                              </div>
                            </div>
                          </label>
                        <% }); %>
                      </div>
                    </div>
                  <% } %>
                <% }); %>
              </div>
            </div>
          <% } else { %>
            <!-- Estado vazio -->
            <div class="powers-empty-state">
              <div class="powers-empty-icon">ğŸ“œ</div>
              <h4 class="powers-empty-title">Nenhum Poder DisponÃ­vel</h4>
              <p class="powers-empty-description">NÃ£o hÃ¡ poderes disponÃ­veis para ediÃ§Ã£o no momento.</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Magias (ADICIONAR APÃ“S A SEÃ‡ÃƒO DE PODERES em character-edit.ejs) -->
<div class="form-section">
  <h3>ğŸ”® Magias do Personagem</h3>

  <div class="spells-main-container">
    <!-- Header Principal -->
    <div class="spells-header">
      <h3>
        <span>ğŸ”®</span>
        Sistema de Magias
        <span>ğŸ”®</span>
      </h3>
      <p>Gerencie as magias conhecidas pelo seu personagem</p>
    </div>

    <!-- ExplicaÃ§Ã£o do Sistema -->
    <div class="spells-explanation">
      <div class="card explanation-card">
        <h4>ğŸ“‹ Como Funcionam as Magias</h4>
        <div class="explanation-grid">
          <div class="explanation-item">
            <h5>ğŸ’™ Custo de PM</h5>
            <p>Cada magia consome Pontos de Mana para ser lanÃ§ada</p>
          </div>
          <div class="explanation-item">
            <h5>ğŸ¯ Acesso por Classe</h5>
            <p>Classe: <%= character.classe_nome || 'N/A' %> - NÃ­vel: <%= character.nivel || 1 %></p>
          </div>
          <div class="explanation-item">
            <h5>ğŸ”˜ CÃ­rculos DisponÃ­veis</h5>
            <p id="availableCircles">Baseado no nÃ­vel da classe</p>
          </div>
          <div class="explanation-item">
            <h5>ğŸ“Š PM DisponÃ­veis</h5>
            <p><%= character.pontos_mana || 0 %> PM</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Magias Atuais do Personagem -->
    <% if (magiasPersonagem && magiasPersonagem.length > 0) { %>
      <div class="character-spells-section">
        <div class="character-spells-header">
          <h4 class="character-spells-title">
            <span>ğŸŒŸ</span>
            Magias Conhecidas
          </h4>
          <p class="character-spells-count">
            <%= magiasPersonagem.length %> <%= magiasPersonagem.length === 1 ? 'magia conhecida' : 'magias conhecidas' %>
          </p>
        </div>

        <!-- Organizar magias por cÃ­rculo -->
        <% 
          const magiasPorCirculo = {};
          magiasPersonagem.forEach(magia => {
            if (!magiasPorCirculo[magia.circulo]) {
              magiasPorCirculo[magia.circulo] = [];
            }
            magiasPorCirculo[magia.circulo].push(magia);
          });
        %>

        <% Object.entries(magiasPorCirculo).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([circulo, magias]) => { %>
          <div class="character-spell-circle-section">
            <h5 class="character-spell-circle-title">
              <span>ğŸ”˜</span>
              <%= circulo %>Âº CÃ­rculo
              <span style="font-size: 0.8em; color: var(--text-muted);">(<%= magias.length %> <%= magias.length === 1 ? 'magia' : 'magias' %>)</span>
            </h5>

            <div class="spells-grid">
              <% magias.forEach(magia => { %>
                <div class="character-spell-card">
                  <div class="character-spell-header">
                    <h6 class="character-spell-name">
                      <% 
                        let spellIcon = 'âœ¨';
                        const nome = (magia.nome || '').toLowerCase();
                        
                        // Ãcones especÃ­ficos por tipo de magia
                        if (nome.includes('cura') || nome.includes('curar')) spellIcon = 'ğŸ’š';
                        else if (nome.includes('fogo') || nome.includes('chama')) spellIcon = 'ğŸ”¥';
                        else if (nome.includes('gelo') || nome.includes('frio')) spellIcon = 'â„ï¸';
                        else if (nome.includes('raio') || nome.includes('relÃ¢mpago')) spellIcon = 'âš¡';
                        else if (nome.includes('luz') || nome.includes('brilho')) spellIcon = 'â˜€ï¸';
                        else if (nome.includes('trevas') || nome.includes('sombra')) spellIcon = 'ğŸŒ‘';
                        else if (nome.includes('proteÃ§Ã£o') || nome.includes('escudo')) spellIcon = 'ğŸ›¡ï¸';
                        else if (nome.includes('ilusÃ£o') || nome.includes('invisibilidade')) spellIcon = 'ğŸ‘»';
                        else if (nome.includes('voo') || nome.includes('voar')) spellIcon = 'ğŸ¦…';
                        else if (nome.includes('teleporte') || nome.includes('portal')) spellIcon = 'ğŸŒ€';
                        else if (nome.includes('invocaÃ§Ã£o') || nome.includes('convocar')) spellIcon = 'ğŸ‘¤';
                        else if (nome.includes('detecÃ§Ã£o') || nome.includes('detectar')) spellIcon = 'ğŸ‘ï¸';
                        else if (nome.includes('transformaÃ§Ã£o') || nome.includes('forma')) spellIcon = 'ğŸ”„';
                        else if (nome.includes('explosÃ£o') || nome.includes('Ã¡rea')) spellIcon = 'ğŸ’¥';
                        else if (nome.includes('mÃ­ssil') || nome.includes('projÃ©til')) spellIcon = 'ğŸ¯';
                        else if (magia.tipo === 'Divina') spellIcon = 'âœ¨';
                        else if (magia.tipo === 'Arcana') spellIcon = 'ğŸ”®';
                        else if (magia.tipo === 'Universal') spellIcon = 'ğŸŒŸ';
                      %>
                      <%= spellIcon %> <%= magia.nome %>
                    </h6>
                    
                    <div class="spell-badges">
                      <span class="spell-badge circle">
                        <%= circulo %>Âº CÃ­rculo
                      </span>
                      <span class="spell-badge type">
                        <%= magia.tipo %>
                      </span>
                      <% if (magia.fonte === 'classe') { %>
                        <span class="spell-badge source-class">âš”ï¸ Classe</span>
                      <% } else { %>
                        <span class="spell-badge source-choice">âš¡ Escolhida</span>
                      <% } %>
                      <% if (magia.custo_pm && magia.custo_pm > 0) { %>
                        <span class="spell-badge cost">ğŸ’™ <%= magia.custo_pm %> PM</span>
                      <% } %>
                    </div>
                  </div>
                  
                  <div class="character-spell-details">
                    <p class="spell-description"><%= magia.descricao %></p>
                    
                    <div class="spell-mechanics">
                      <% if (magia.escola) { %>
                        <div class="spell-mechanic">
                          <strong>Escola:</strong> <%= magia.escola %>
                        </div>
                      <% } %>
                      
                      <% if (magia.execucao) { %>
                        <div class="spell-mechanic">
                          <strong>ExecuÃ§Ã£o:</strong> <%= magia.execucao %>
                        </div>
                      <% } %>
                      
                      <% if (magia.alcance) { %>
                        <div class="spell-mechanic">
                          <strong>Alcance:</strong> <%= magia.alcance %>
                        </div>
                      <% } %>
                      
                      <% if (magia.duracao) { %>
                        <div class="spell-mechanic">
                          <strong>DuraÃ§Ã£o:</strong> <%= magia.duracao %>
                        </div>
                      <% } %>
                    </div>
                    
                    <!-- Origem da magia -->
                    <% if (magia.observacoes) { %>
                      <div class="spell-origin">
                        <small><strong>Origem:</strong> <%= magia.observacoes %></small>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Magias DisponÃ­veis para SeleÃ§Ã£o/EdiÃ§Ã£o -->
    <% if (magiasDaClasse && magiasDaClasse.length > 0) { %>
      <div class="spell-selection-section">
        <div class="spell-selection-header">
          <h4 class="spell-selection-title">
            <span>âš¡</span>
            Gerenciar Magias Conhecidas
          </h4>
          <p class="spell-selection-description">
            Modifique as magias conhecidas pelo personagem (magias de classe sÃ£o gerenciadas automaticamente)
          </p>
        </div>

        <!-- Filtros -->
        <div class="spells-filters">
          <!-- Barra de Busca -->
          <div class="spells-search-container">
            <div class="spells-search-box">
              <span class="spells-search-icon">ğŸ”</span>
              <input type="text" id="spellsSearchInput" class="spells-search-input"
                placeholder="Buscar magias por nome, escola ou descriÃ§Ã£o..." autocomplete="off">
              <div id="spellsSearchResults" class="spells-search-results"></div>
            </div>
          </div>

          <!-- Filtros RÃ¡pidos -->
          <div class="spells-quick-filters">
            <div class="quick-filters-title">ğŸ¯ Filtros RÃ¡pidos</div>
            <div class="quick-filters-buttons">
              <button type="button" class="quick-filter-btn active" data-filter="all">âœ¨ Todas</button>
              <button type="button" class="quick-filter-btn" data-filter="selected">âœ… Selecionadas</button>
              <button type="button" class="quick-filter-btn" data-filter="available">ğŸ“‹ DisponÃ­veis</button>
              <button type="button" class="quick-filter-btn" data-filter="arcana">ğŸ”® Arcana</button>
              <button type="button" class="quick-filter-btn" data-filter="divina">âœ¨ Divina</button>
              <button type="button" class="quick-filter-btn" data-filter="universal">ğŸŒŸ Universal</button>
            </div>
          </div>
        </div>

        <!-- Organizar por cÃ­rculo -->
        <% 
          const magiasDisponiveis = {};
          magiasDaClasse.forEach(magia => {
            if (!magiasDisponiveis[magia.circulo]) {
              magiasDisponiveis[magia.circulo] = [];
            }
            magiasDisponiveis[magia.circulo].push(magia);
          });
        %>

        <div class="available-spells-container">
          <% Object.entries(magiasDisponiveis).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([circulo, magias]) => { %>
            <div class="spell-circle-section" data-circle="<%= circulo %>">
              <div class="spell-circle-header">
                <h5 class="spell-circle-title">
                  <span>ğŸ”˜</span>
                  <%= circulo %>Âº CÃ­rculo
                  <% 
                    // Verificar nÃ­vel mÃ­nimo necessÃ¡rio baseado na classe
                    let nivelMinimo = 1;
                    const classe = character.classe_nome ? character.classe_nome.toLowerCase() : '';
                    
                    if (classe === 'arcanista' || classe === 'clÃ©rigo') {
                      switch(parseInt(circulo)) {
                        case 1: nivelMinimo = 1; break;
                        case 2: nivelMinimo = 5; break;
                        case 3: nivelMinimo = 9; break;
                        case 4: nivelMinimo = 13; break;
                        case 5: nivelMinimo = 17; break;
                      }
                    } else if (classe === 'bardo' || classe === 'druida') {
                      switch(parseInt(circulo)) {
                        case 1: nivelMinimo = 1; break;
                        case 2: nivelMinimo = 6; break;
                        case 3: nivelMinimo = 10; break;
                        case 4: nivelMinimo = 14; break;
                        case 5: nivelMinimo = 999; break; // Bardo e Druida nÃ£o tÃªm 5Âº cÃ­rculo
                      }
                    }
                    
                    const podeAcessar = (character.nivel || 1) >= nivelMinimo;
                    const selectedCount = magias.filter(m => 
                      magiasPersonagem && magiasPersonagem.some(pm => pm.id == m.id && pm.fonte === 'escolha')
                    ).length;
                  %>
                  
                  <% if (!podeAcessar) { %>
                    <span class="level-requirement">âš ï¸ Requer NÃ­vel <%= nivelMinimo %></span>
                  <% } %>
                </h5>
                
                <div class="spell-circle-info">
                  <span class="circle-count">(<%= selectedCount %>/<%= magias.length %> selecionadas)</span>
                  <% if (!podeAcessar) { %>
                    <span class="circle-locked">ğŸ”’ Bloqueado</span>
                  <% } %>
                </div>
                
                <button type="button" class="spell-circle-toggle" data-target="<%= circulo %>">
                  <span class="toggle-icon">ğŸ“</span>
                </button>
              </div>

              <div class="spells-grid" id="spellsGrid-<%= circulo %>" <%= !podeAcessar ? 'style="opacity: 0.5; pointer-events: none;"' : '' %>>
                <% magias.forEach(magia => { %>
                  <% 
                    // Verificar se a magia jÃ¡ estÃ¡ selecionada
                    let isSelected = false;
                    if (magiasPersonagem) {
                      isSelected = magiasPersonagem.some(pm => pm.id == magia.id && pm.fonte === 'escolha');
                    }
                  %>

                  <label class="spell-checkbox-label <%= podeAcessar ? '' : 'disabled' %>">
                    <input type="checkbox" name="magias_selecionadas" value="<%= magia.id %>" 
                           class="spell-checkbox spell-checkbox-filter" 
                           data-name="<%= magia.nome.toLowerCase() %>" 
                           data-type="<%= magia.tipo.toLowerCase() %>" 
                           data-circle="<%= circulo %>"
                           data-school="<%= magia.escola.toLowerCase() %>"
                           data-description="<%= magia.descricao.toLowerCase() %>" 
                           <%= isSelected ? 'checked' : '' %>
                           <%= !podeAcessar ? 'disabled' : '' %>>

                    <div class="spell-card <%= isSelected ? 'selected' : '' %>" data-spell-id="<%= magia.id %>">
                      <div class="spell-card-header">
                        <% if (isSelected) { %>
                          <div class="spell-card-source">âœ… Conhecida</div>
                        <% } %>

                        <div class="spell-card-icon">
                          <% 
                            let spellIcon = 'âœ¨';
                            const nome = (magia.nome || '').toLowerCase();
                            
                            if (nome.includes('cura') || nome.includes('curar')) spellIcon = 'ğŸ’š';
                            else if (nome.includes('fogo') || nome.includes('chama')) spellIcon = 'ğŸ”¥';
                            else if (nome.includes('gelo') || nome.includes('frio')) spellIcon = 'â„ï¸';
                            else if (nome.includes('raio') || nome.includes('relÃ¢mpago')) spellIcon = 'âš¡';
                            else if (nome.includes('luz') || nome.includes('brilho')) spellIcon = 'â˜€ï¸';
                            else if (nome.includes('trevas') || nome.includes('sombra')) spellIcon = 'ğŸŒ‘';
                            else if (nome.includes('proteÃ§Ã£o') || nome.includes('escudo')) spellIcon = 'ğŸ›¡ï¸';
                            else if (magia.tipo === 'Divina') spellIcon = 'âœ¨';
                            else if (magia.tipo === 'Arcana') spellIcon = 'ğŸ”®';
                            else if (magia.tipo === 'Universal') spellIcon = 'ğŸŒŸ';
                          %>
                          <%= spellIcon %>
                        </div>

                        <h6 class="spell-card-name"><%= magia.nome %></h6>
                        <p class="spell-card-type"><%= magia.escola %> â€¢ <%= magia.tipo %></p>
                      </div>

                      <div class="spell-card-content">
                        <p class="spell-card-description"><%= magia.descricao %></p>

                        <div class="spell-card-details">
                          <% if (magia.custo_pm && magia.custo_pm > 0) { %>
                            <div class="spell-detail-item">
                              <span class="spell-detail-label">ğŸ’™</span>
                              <span class="spell-detail-value"><strong>Custo:</strong> <%= magia.custo_pm %> PM</span>
                            </div>
                          <% } %>

                          <% if (magia.execucao) { %>
                            <div class="spell-detail-item">
                              <span class="spell-detail-label">â°</span>
                              <span class="spell-detail-value"><strong>ExecuÃ§Ã£o:</strong> <%= magia.execucao %></span>
                            </div>
                          <% } %>

                          <% if (magia.alcance && magia.alcance !== 'Pessoal') { %>
                            <div class="spell-detail-item">
                              <span class="spell-detail-label">ğŸ¯</span>
                              <span class="spell-detail-value"><strong>Alcance:</strong> <%= magia.alcance %></span>
                            </div>
                          <% } %>

                          <% if (magia.duracao && magia.duracao !== 'InstantÃ¢neo') { %>
                            <div class="spell-detail-item">
                              <span class="spell-detail-label">â±ï¸</span>
                              <span class="spell-detail-value"><strong>DuraÃ§Ã£o:</strong> <%= magia.duracao %></span>
                            </div>
                          <% } %>

                          <% if (magia.nivel_minimo) { %>
                            <div class="spell-detail-item">
                              <span class="spell-detail-label">ğŸ“Š</span>
                              <span class="spell-detail-value"><strong>NÃ­vel:</strong> <%= magia.nivel_minimo %>+</span>
                            </div>
                          <% } %>
                        </div>

                        <!-- Tags da Magia -->
                        <div class="spell-tags">
                          <span class="spell-tag circle"><%= circulo %>Âº CÃ­rculo</span>
                          <span class="spell-tag type"><%= magia.tipo %></span>
                          <span class="spell-tag school"><%= magia.escola %></span>
                          
                          <% if (isSelected) { %>
                            <span class="spell-tag selected">Conhecida</span>
                          <% } %>
                          
                          <% if (magia.custo_pm && magia.custo_pm > 0) { %>
                            <span class="spell-tag cost"><%= magia.custo_pm %> PM</span>
                          <% } %>
                          
                          <% if (!podeAcessar) { %>
                            <span class="spell-tag locked">ğŸ”’ NÃ­vel <%= nivelMinimo %>+</span>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </label>
                <% }); %>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    <% } else if (character.classe_nome && ['Arcanista', 'Bardo', 'ClÃ©rigo', 'Druida'].includes(character.classe_nome)) { %>
      <!-- Classe mÃ¡gica mas sem magias disponÃ­veis -->
      <div class="spells-empty-state">
        <div class="spells-empty-icon">ğŸ”®</div>
        <h4 class="spells-empty-title">Sem Magias DisponÃ­veis</h4>
        <p class="spells-empty-description">
          NÃ£o hÃ¡ magias disponÃ­veis para sua classe no momento.
          <br>
          <strong>Classe:</strong> <%= character.classe_nome %> - <strong>NÃ­vel:</strong> <%= character.nivel || 1 %>
        </p>
      </div>
    <% } else { %>
      <!-- Classe nÃ£o-mÃ¡gica -->
      <div class="non-magical-class">
        <div class="non-magical-card">
          <div class="non-magical-icon">âš”ï¸</div>
          <h4 class="non-magical-title">Classe NÃ£o-MÃ¡gica</h4>
          <p class="non-magical-description">
            A classe <strong><%= character.classe_nome || 'selecionada' %></strong> nÃ£o possui acesso a magias.
            <br>
            <strong>Classes MÃ¡gicas:</strong> Arcanista, Bardo, ClÃ©rigo, Druida
          </p>
        </div>
      </div>
    <% } %>
  </div>
</div>

      <!-- CaracterÃ­sticas Derivadas -->
      <div class="form-section">
        <h3>ğŸ“Š CaracterÃ­sticas Derivadas</h3>
        <div class="card">
          <div class="form-grid-three">
            <div class="form-group">
              <label for="pontos_vida">â¤ï¸ Pontos de Vida</label>
              <input type="number" id="pontos_vida" name="pontos_vida" value="<%= character.pontos_vida || 0 %>" min="1" required>
              <small>Pode ser ajustado manualmente conforme evoluÃ§Ã£o</small>
            </div>

            <div class="form-group">
              <label for="pontos_mana">ğŸ”µ Pontos de Mana</label>
              <input type="number" id="pontos_mana" name="pontos_mana" value="<%= character.pontos_mana || 0 %>" min="0">
              <small>Para classes que usam magia</small>
            </div>

            <div class="form-group">
              <label for="ca">ğŸ›¡ï¸ Classe de Armadura</label>
              <input type="number" id="ca" name="ca" value="<%= character.ca || 10 %>" min="10">
              <small>Inclui bÃ´nus de equipamentos e Destreza</small>
            </div>
          </div>

          <div class="form-group">
            <label for="experiencia">â­ ExperiÃªncia</label>
            <input type="number" id="experiencia" name="experiencia" value="<%= character.experiencia || 0 %>" min="0">
            <small>Pontos de experiÃªncia acumulados</small>
          </div>
        </div>
      </div>

      <!-- Background e Roleplay -->
      <div class="form-section">
        <h3>ğŸ­ HistÃ³ria e Personalidade</h3>
        <div class="card">
          <div class="form-group">
            <label for="historia_pessoal">ğŸ“œ HistÃ³ria Pessoal</label>
            <textarea id="historia_pessoal" name="historia_pessoal" rows="4" placeholder="Descreva a origem, famÃ­lia, eventos marcantes da vida do personagem..."><%= character.historia_pessoal || '' %></textarea>
            <small>Onde nasceu? Como cresceu? O que o motivou a se tornar um aventureiro?</small>
          </div>

          <div class="form-group">
            <label for="personalidade">ğŸ­ Personalidade</label>
            <textarea id="personalidade" name="personalidade" rows="3" placeholder="Corajoso, sarcÃ¡stico, tÃ­mido, arrogante... Como seu personagem se comporta?"><%= character.personalidade || '' %></textarea>
            <small>TraÃ§os de personalidade, maneirismos, medos, vÃ­cios...</small>
          </div>

          <div class="form-group">
            <label for="objetivos">ğŸ¯ Objetivos e MotivaÃ§Ãµes</label>
            <textarea id="objetivos" name="objetivos" rows="3" placeholder="O que seu personagem busca? VinganÃ§a? Conhecimento? Riqueza? JustiÃ§a?"><%= character.objetivos || '' %></textarea>
            <small>O que move seu personagem? Quais sÃ£o seus sonhos e ambiÃ§Ãµes?</small>
          </div>
        </div>
      </div>

      <!-- Preview do Personagem -->
      <div class="form-section">
        <h3>ğŸ‘ï¸ Preview do Personagem</h3>
        <div class="card character-preview" id="characterPreview">
          <div class="preview-content">
            <div class="preview-header">
              <h4 id="previewNome"><%= character.nome %></h4>
              <p id="previewClasseRaca">Classe RaÃ§a - NÃ­vel <%= character.nivel || 1 %></p>
            </div>

            <div class="preview-stats">
              <div class="preview-atributos">
                <h5>Atributos</h5>
                <div class="attrs-preview" id="attrsPreview">
                  <!-- Preenchido via JavaScript -->
                </div>
              </div>

              <div class="preview-derivadas">
                <h5>CaracterÃ­sticas</h5>
                <div class="derivadas-preview" id="derivadasPreview">
                  <!-- Preenchido via JavaScript -->
                </div>
              </div>
            </div>

            <div class="preview-poderes" id="previewPoderes">
              <h5>Poderes Selecionados</h5>
              <div class="poderes-preview" id="poderesPreview">
                <!-- Preenchido via JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BotÃµes de AÃ§Ã£o -->
      <div class="form-actions">
        <button type="submit" class="nav-btn">ğŸ’¾ Salvar AlteraÃ§Ãµes</button>
        <a href="/personagens/<%= character.id %>" class="btn btn-secondary">ğŸ‘ï¸ Ver Ficha</a>
        <a href="/personagens" class="btn btn-secondary">ğŸ“‹ Meus Personagens</a>
        <button type="button" class="btn btn-secondary" id="resetForm">ğŸ”„ Resetar</button>
      </div>
    </form>
  <% } else { %>
    <!-- Personagem nÃ£o encontrado -->
    <div class="error-state">
      <div class="error-card">
        <div class="error-icon">ğŸ˜”</div>
        <h2>Personagem NÃ£o Encontrado</h2>
        <p>O personagem que vocÃª estÃ¡ tentando editar nÃ£o foi encontrado ou vocÃª nÃ£o tem permissÃ£o para editÃ¡-lo.</p>
        <div class="error-actions">
          <a href="/personagens" class="nav-btn">ğŸ“‹ Meus Personagens</a>
          <a href="/personagens/criar" class="btn btn-secondary">âœ¨ Criar Novo</a>
        </div>
      </div>
    </div>
  <% } %>
</section>

<!-- Scripts especÃ­ficos para ediÃ§Ã£o de personagem -->
<script src="/scripts/character-edit.js"></script>
<script src="/scripts/class-powers.js"></script>

<%- include('../partials/footer') %>