<%- include('../partials/header', { title: `Editar ${character ? character.nome : 'Personagem' }`,
  activePage: 'editCharacter' }) %>

  <section class="content-section active">
    <h2>‚úèÔ∏è Editar Personagem</h2>
    <p style="text-align: center; margin-bottom: 2rem; color: #b8b8b8;">
      Modifique as informa√ß√µes do seu her√≥i. Todas as altera√ß√µes ser√£o salvas automaticamente quando voc√™ confirmar.
    </p>

    <% if (character) { %>
      <form action="/personagens/<%= character.id %>?_method=PUT" method="POST" class="character-form"
        id="characterForm">
        <!-- Informa√ß√µes B√°sicas -->
        <div class="form-section">
          <h3>üìù Informa√ß√µes B√°sicas</h3>
          <div class="card">
            <div class="form-grid">
              <div class="form-group">
                <label for="nome">‚öîÔ∏è Nome do Personagem *</label>
                <input type="text" id="nome" name="nome" required value="<%= character.nome %>"
                  placeholder="Ex: Alaric Fortaleza, Lyanna Luaverde..." maxlength="100">
                <small>Escolha um nome que reflita a personalidade e origem do seu her√≥i</small>
              </div>

              <div class="form-group">
                <label for="nivel">üìä N√≠vel</label>
                <input type="number" id="nivel" name="nivel" value="<%= character.nivel || 1 %>" min="1" max="20"
                  required>
                <small>N√≠vel atual do personagem</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Ra√ßa, Classe e Deus -->
        <div class="form-section">
          <h3>üß¨ Origem e Voca√ß√£o</h3>
          <div class="card">
            <div class="form-grid-three">
              <div class="form-group">
                <label for="raca_id">üßù Ra√ßa *</label>
                <select id="raca_id" name="raca_id" required>
                  <option value="">Escolha uma ra√ßa...</option>
                  <% if (racas && racas.length> 0) { %>
                    <% racas.forEach(raca=> { %>
                      <option value="<%= raca.id %>" data-bonus='<%= JSON.stringify(raca.bonus_atributos) %>'
                        <%=character.raca_id==raca.id ? 'selected' : '' %>>
                        <%= raca.nome %>
                      </option>
                      <% }); %>
                        <% } %>
                </select>
                <small>Define caracter√≠sticas f√≠sicas e habilidades raciais</small>
              </div>

              <div class="form-group">
                <label for="classe_id">‚öîÔ∏è Classe *</label>
                <select id="classe_id" name="classe_id" required>
                  <option value="">Escolha uma classe...</option>
                  <% if (classes && classes.length> 0) { %>
                    <% classes.forEach(classe=> { %>
                      <option value="<%= classe.id %>" data-vida="<%= classe.pontos_vida_base %>"
                        data-mana="<%= classe.pontos_mana_base || 0 %>" data-atributo="<%= classe.atributo_principal %>"
                        <%=character.classe_id==classe.id ? 'selected' : '' %>>
                        <%= classe.nome %>
                      </option>
                      <% }); %>
                        <% } %>
                </select>
                <small>Determina habilidades e papel no grupo</small>
              </div>

              <div class="form-group">
                <label for="deus_id">‚≠ê Deus Patrono</label>
                <select id="deus_id" name="deus_id">
                  <option value="">Sem deus espec√≠fico</option>
                  <% if (deuses && deuses.length> 0) { %>
                    <% deuses.forEach(deus=> { %>
                      <option value="<%= deus.id %>" <%=character.deus_id==deus.id ? 'selected' : '' %>>
                        <%= deus.nome %> - <%= deus.dominio %>
                      </option>
                      <% }); %>
                        <% } %>
                </select>
                <small>Divindade que seu personagem venera (opcional)</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Atributos -->
        <div class="form-section">
          <h3>üí™ Atributos</h3>
          <div class="card">
            <div class="atributos-info">
              <p>üìã <strong>Distribui√ß√£o de Pontos:</strong> Voc√™ tem <span id="pontosRestantes">0</span> pontos
                restantes para distribuir. Cada atributo pode variar entre 8 e 18.</p>
              <p>üí° <strong>Dica:</strong> Mantenha o foco no atributo principal da sua classe!</p>
            </div>

            <div class="atributos-grid">
              <div class="atributo-card">
                <label for="forca">üí™ For√ßa</label>
                <div class="atributo-controls">
                  <button type="button" class="attr-btn minus" data-attr="forca">-</button>
                  <input type="number" id="forca" name="forca" value="<%= character.forca || 10 %>" min="8" max="18"
                    readonly>
                  <button type="button" class="attr-btn plus" data-attr="forca">+</button>
                </div>
                <small>For√ßa f√≠sica, ataques corpo a corpo</small>
                <div class="bonus-display" id="bonus-forca">+0</div>
              </div>

              <div class="atributo-card">
                <label for="destreza">üèÉ Destreza</label>
                <div class="atributo-controls">
                  <button type="button" class="attr-btn minus" data-attr="destreza">-</button>
                  <input type="number" id="destreza" name="destreza" value="<%= character.destreza || 10 %>" min="8"
                    max="18" readonly>
                  <button type="button" class="attr-btn plus" data-attr="destreza">+</button>
                </div>
                <small>Agilidade, ataques √† dist√¢ncia</small>
                <div class="bonus-display" id="bonus-destreza">+0</div>
              </div>

              <div class="atributo-card">
                <label for="constituicao">‚ù§Ô∏è Constitui√ß√£o</label>
                <div class="atributo-controls">
                  <button type="button" class="attr-btn minus" data-attr="constituicao">-</button>
                  <input type="number" id="constituicao" name="constituicao" value="<%= character.constituicao || 10 %>"
                    min="8" max="18" readonly>
                  <button type="button" class="attr-btn plus" data-attr="constituicao">+</button>
                </div>
                <small>Resist√™ncia, pontos de vida</small>
                <div class="bonus-display" id="bonus-constituicao">+0</div>
              </div>

              <div class="atributo-card">
                <label for="inteligencia">üß† Intelig√™ncia</label>
                <div class="atributo-controls">
                  <button type="button" class="attr-btn minus" data-attr="inteligencia">-</button>
                  <input type="number" id="inteligencia" name="inteligencia" value="<%= character.inteligencia || 10 %>"
                    min="8" max="18" readonly>
                  <button type="button" class="attr-btn plus" data-attr="inteligencia">+</button>
                </div>
                <small>Racioc√≠nio, magia arcana</small>
                <div class="bonus-display" id="bonus-inteligencia">+0</div>
              </div>

              <div class="atributo-card">
                <label for="sabedoria">üßô Sabedoria</label>
                <div class="atributo-controls">
                  <button type="button" class="attr-btn minus" data-attr="sabedoria">-</button>
                  <input type="number" id="sabedoria" name="sabedoria" value="<%= character.sabedoria || 10 %>" min="8"
                    max="18" readonly>
                  <button type="button" class="attr-btn plus" data-attr="sabedoria">+</button>
                </div>
                <small>Percep√ß√£o, magia divina</small>
                <div class="bonus-display" id="bonus-sabedoria">+0</div>
              </div>

              <div class="atributo-card">
                <label for="carisma">üòé Carisma</label>
                <div class="atributo-controls">
                  <button type="button" class="attr-btn minus" data-attr="carisma">-</button>
                  <input type="number" id="carisma" name="carisma" value="<%= character.carisma || 10 %>" min="8"
                    max="18" readonly>
                  <button type="button" class="attr-btn plus" data-attr="carisma">+</button>
                </div>
                <small>Personalidade, lideran√ßa</small>
                <div class="bonus-display" id="bonus-carisma">+0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Poderes -->
        <!-- Se√ß√£o de Poderes Melhorada para Character Edit -->
        <div class="form-section">
          <h3>‚ú® Poderes</h3>

          <div class="powers-main-container">
            <!-- Header Principal -->
            <div class="powers-header">
              <h3>
                <span>‚ö°</span>
                Sistema de Poderes
                <span>‚ö°</span>
              </h3>
              <p>Gerencie os poderes do seu personagem</p>
            </div>

            <!-- Poderes Atuais do Personagem -->
            <% if (poderesPersonagem && poderesPersonagem.length> 0) { %>
              <div class="character-powers-section">
                <div class="character-powers-header">
                  <h4 class="character-powers-title">
                    <span>üåü</span>
                    Poderes Atuais
                  </h4>
                  <p class="character-powers-count">
                    <%= poderesPersonagem.length %> poderes ativos
                  </p>
                </div>

                <!-- Organizar poderes por fonte -->
                <% const poderesPorFonte={}; poderesPersonagem.forEach(poder=> {
                  if (!poderesPorFonte[poder.fonte]) {
                  poderesPorFonte[poder.fonte] = [];
                  }
                  poderesPorFonte[poder.fonte].push(poder);
                  });
                  %>

                  <% Object.entries(poderesPorFonte).forEach(([fonte, poderes])=> { %>
                    <div class="character-power-type-section">
                      <h5 class="character-power-type-title">
                        <% let sourceIcon='üìù' ; let sourceText=fonte; switch(fonte) { case 'raca' : sourceIcon='üß¨' ;
                          sourceText='Poderes Raciais' ; break; case 'escolha' : sourceIcon='‚ö°' ;
                          sourceText='Poderes Escolhidos' ; break; case 'classe' : sourceIcon='‚öîÔ∏è' ;
                          sourceText='Poderes de Classe' ; break; case 'deus' : sourceIcon='‚≠ê' ;
                          sourceText='Poderes Divinos' ; break; } %>
                          <span>
                            <%= sourceIcon %>
                          </span>
                          <%= sourceText %>
                            <span style="font-size: 0.8em; color: var(--text-muted);">(<%= poderes.length %>)</span>
                      </h5>

                      <div class="powers-list">
                        <% poderes.forEach(poder=> { %>
                          <div class="character-power-card">
                            <div class="character-power-header">
                              <h6 class="character-power-name">
                                <%= poder.nome %>
                              </h6>
                              <span class="character-power-source-badge">
                                <%= sourceIcon %>
                                  <%= sourceText.replace('Poderes ', '') %>
                    </span>
                  </div>
                  
                  <div class="character-power-description">
                    <%= poder.descricao %>
                  </div>
                  
                  <% if (poder.pre_requisitos || poder.custo_pm || poder.observacoes) { %>
                    <div class="character-power-details">
                      <% if (poder.pre_requisitos) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">üìã Pr√©-requisitos</div>
                          <p class="character-power-detail-value"><%= poder.pre_requisitos %></p>
                        </div>
                      <% } %>
                      
                      <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">üíô Custo</div>
                          <p class="character-power-detail-value"><%= poder.custo_pm %> PM</p>
                        </div>
                      <% } %>
                      
                      <% if (poder.observacoes) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">üìù Observa√ß√µes</div>
                          <p class="character-power-detail-value"><%= poder.observacoes %></p>
                        </div>
                      <% } %>
                    </div>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Poderes Dispon√≠veis para Sele√ß√£o/Edi√ß√£o -->
    <% if (poderesDisponiveis && Object.keys(poderesDisponiveis).length > 0) { %>
      <div class="power-selection-section">
        <div class="power-selection-header">
          <h4 class="power-selection-title">
            <span>‚ö°</span>
            Adicionar ou Remover Poderes
          </h4>
          <p class="power-selection-description">
            Modifique os poderes escolhidos do seu personagem (n√£o afeta poderes raciais autom√°ticos)
          </p>
        </div>

        <!-- Barra de Busca -->
        <div class="powers-search-container">
          <div class="powers-search-box">
            <span class="powers-search-icon">üîç</span>
            <input 
              type="text" 
              id="powersSearchInput" 
              class="powers-search-input" 
              placeholder="Buscar poderes por nome, descri√ß√£o ou tipo..."
              autocomplete="off"
            >
            <div id="powersSearchResults" class="powers-search-results"></div>
          </div>
        </div>

        <!-- Filtros R√°pidos -->
        <div class="powers-quick-filters">
          <div class="quick-filters-title">üéØ Filtros R√°pidos</div>
          <div class="quick-filters-buttons">
            <button type="button" class="quick-filter-btn active" data-filter="all">
              ‚ú® Todos
            </button>
            <button type="button" class="quick-filter-btn" data-filter="selected">
              ‚úÖ Selecionados
            </button>
            <button type="button" class="quick-filter-btn" data-filter="available">
              üìã Dispon√≠veis
            </button>
            <button type="button" class="quick-filter-btn" data-filter="geral">
              ‚ö° Gerais
            </button>
            <button type="button" class="quick-filter-btn" data-filter="combate">
              ‚öîÔ∏è Combate
            </button>
            <button type="button" class="quick-filter-btn" data-filter="destino">
              üåü Destino
            </button>
            <button type="button" class="quick-filter-btn" data-filter="magia">
              üîÆ Magia
            </button>
          </div>
        </div>

        <!-- Container dos Poderes -->
        <div class="powers-sections-container">
          <% Object.entries(poderesDisponiveis).forEach(([tipo, poderes]) => { %>
            <% if (poderes && poderes.length > 0) { %>
              <div class="power-type-section" data-type="<%= tipo %>">
                <div class="power-type-header">
                  <h5 class="power-type-title">
                    <% 
                      let tipoIcon = ' ‚ú®'; let tipoNome=tipo; switch(tipo) { case 'geral' : tipoIcon='‚ö°' ;
                                    tipoNome='Poderes Gerais' ; break; case 'combate' : tipoIcon='‚öîÔ∏è' ;
                                    tipoNome='Poderes de Combate' ; break; case 'destino' : tipoIcon='üåü' ;
                                    tipoNome='Poderes de Destino' ; break; case 'magia' : tipoIcon='üîÆ' ;
                                    tipoNome='Poderes de Magia' ; break; } // Contar quantos est√£o selecionados let
                                    selectedCount=0; if (poderesPersonagem) { selectedCount=poderes.filter(poder=>
                                    poderesPersonagem.some(p => p.id == poder.id && p.fonte === 'escolha')
                                    ).length;
                                    }
                                    %>
                                    <span>
                                      <%= tipoIcon %>
                                    </span>
                                    <%= tipoNome %>
                                      </h5>
                                      <div class="power-type-count">
                                        (<%= selectedCount %>/<%= poderes.length %> selecionados)
                                      </div>
                                      <button type="button" class="power-type-toggle" data-target="<%= tipo %>">
                                        <span class="toggle-icon">üìÅ</span>
                                      </button>
                            </div>

                            <div class="powers-grid" id="powersGrid-<%= tipo %>">
                              <% poderes.forEach(poder=> { %>
                                <% // Verificar se o poder j√° est√° selecionado let isSelected=false; if
                                  (poderesPersonagem) { isSelected=poderesPersonagem.some(p=> p.id == poder.id &&
                                  p.fonte === 'escolha');
                                  }
                                  %>

                                  <label class="power-checkbox-label">
                                    <input type="checkbox" name="poderes_selecionados" value="<%= poder.id %>"
                                      class="power-checkbox power-checkbox-filter"
                                      data-name="<%= poder.nome.toLowerCase() %>" data-type="<%= tipo %>"
                                      data-description="<%= poder.descricao.toLowerCase() %>"
                                      data-selected="<%= isSelected %>" <%=isSelected ? 'checked' : '' %>
                                    >

                                    <div class="power-card <%= isSelected ? 'selected' : '' %>"
                                      data-power-id="<%= poder.id %>">
                                      <div class="power-card-header">
                                        <% if (isSelected) { %>
                                          <div class="power-card-source">‚úÖ Ativo</div>
                                          <% } %>

                                            <div class="power-card-icon">
                                              <% let poderIcon='‚ú®'%>
                                                <%= poderIcon %>
                                            </div>

                                            <h6 class="power-card-name">
                                              <%= poder.nome %>
                                            </h6>
                                            <p class="power-card-type">
                                              <%= tipoNome %>
                                            </p>
                                      </div>

                                      <div class="power-card-content">
                                        <p class="power-card-description">
                                          <%= poder.descricao %>
                                        </p>

                                        <div class="power-card-details">
                                          <% if (poder.pre_requisitos) { %>
                                            <div class="power-detail-item">
                                              <span class="power-detail-label">üìã</span>
                                              <span class="power-detail-value"><strong>Pr√©-req:</strong>
                                                <%= poder.pre_requisitos %>
                                              </span>
                                            </div>
                                            <% } %>

                                              <% if (poder.custo_pm && poder.custo_pm> 0) { %>
                                                <div class="power-detail-item">
                                                  <span class="power-detail-label">üíô</span>
                                                  <span class="power-detail-value"><strong>Custo:</strong>
                                                    <%= poder.custo_pm %> PM
                                                  </span>
                                                </div>
                                                <% } %>

                                                  <% if (poder.alcance && poder.alcance !=='Pessoal' ) { %>
                                                    <div class="power-detail-item">
                                                      <span class="power-detail-label">üéØ</span>
                                                      <span class="power-detail-value"><strong>Alcance:</strong>
                                                        <%= poder.alcance %>
                                                      </span>
                                                    </div>
                                                    <% } %>

                                                      <% if (poder.duracao && poder.duracao !=='Instant√¢neo' ) { %>
                                                        <div class="power-detail-item">
                                                          <span class="power-detail-label">‚è±Ô∏è</span>
                                                          <span class="power-detail-value"><strong>Dura√ß√£o:</strong>
                                                            <%= poder.duracao %>
                                                          </span>
                                                        </div>
                                                        <% } %>
                                        </div>

                                        <!-- Tags do Poder -->
                                        <div class="power-tags">
                                          <span class="power-tag">
                                            <%= tipoNome %>
                                          </span>
                                          <% if (isSelected) { %>
                                            <span class="power-tag"
                                              style="background: var(--success-green); color: white; border-color: var(--success-green);">Ativo</span>
                                            <% } %>
                                              <% if (poder.custo_pm && poder.custo_pm> 0) { %>
                                                <span class="power-tag cost">
                                                  <%= poder.custo_pm %> PM
                                                </span>
                                                <% } %>
                                                  <% if (poder.pre_requisitos) { %>
                                                    <span class="power-tag requirement">Pr√©-req</span>
                                                    <% } %>
                                        </div>
                                      </div>
                                    </div>
                                  </label>
                                  <% }); %>
                            </div>
                          </div>
                          <% } %>
                            <% }); %>
                      </div>
                    </div>
                    <% } else { %>
                      <!-- Estado vazio -->
                      <div class="powers-empty-state">
                        <div class="powers-empty-icon">üìú</div>
                        <h4 class="powers-empty-title">Nenhum Poder Dispon√≠vel</h4>
                        <p class="powers-empty-description">
                          N√£o h√° poderes dispon√≠veis para edi√ß√£o no momento.
                        </p>
                      </div>
                      <% } %>
              </div>
          </div>

          <!-- Caracter√≠sticas Derivadas -->
          <div class="form-section">
            <h3>üìä Caracter√≠sticas Derivadas</h3>
            <div class="card">
              <div class="form-grid-three">
                <div class="form-group">
                  <label for="pontos_vida">‚ù§Ô∏è Pontos de Vida</label>
                  <input type="number" id="pontos_vida" name="pontos_vida" value="<%= character.pontos_vida || 0 %>"
                    min="1" required>
                  <small>Pode ser ajustado manualmente conforme evolu√ß√£o</small>
                </div>

                <div class="form-group">
                  <label for="pontos_mana">üîµ Pontos de Mana</label>
                  <input type="number" id="pontos_mana" name="pontos_mana" value="<%= character.pontos_mana || 0 %>"
                    min="0">
                  <small>Para classes que usam magia</small>
                </div>

                <div class="form-group">
                  <label for="ca">üõ°Ô∏è Classe de Armadura</label>
                  <input type="number" id="ca" name="ca" value="<%= character.ca || 10 %>" min="10">
                  <small>Inclui b√¥nus de equipamentos e Destreza</small>
                </div>
              </div>

              <div class="form-group">
                <label for="experiencia">‚≠ê Experi√™ncia</label>
                <input type="number" id="experiencia" name="experiencia" value="<%= character.experiencia || 0 %>"
                  min="0">
                <small>Pontos de experi√™ncia acumulados</small>
              </div>
            </div>
          </div>

          <!-- Background e Roleplay -->
          <div class="form-section">
            <h3>üé≠ Hist√≥ria e Personalidade</h3>
            <div class="card">
              <div class="form-group">
                <label for="historia_pessoal">üìú Hist√≥ria Pessoal</label>
                <textarea id="historia_pessoal" name="historia_pessoal" rows="4"
                  placeholder="Descreva a origem, fam√≠lia, eventos marcantes da vida do personagem..."><%= character.historia_pessoal || '' %></textarea>
                <small>Onde nasceu? Como cresceu? O que o motivou a se tornar um aventureiro?</small>
              </div>

              <div class="form-group">
                <label for="personalidade">üé≠ Personalidade</label>
                <textarea id="personalidade" name="personalidade" rows="3"
                  placeholder="Corajoso, sarc√°stico, t√≠mido, arrogante... Como seu personagem se comporta?"><%= character.personalidade || '' %></textarea>
                <small>Tra√ßos de personalidade, maneirismos, medos, v√≠cios...</small>
              </div>

              <div class="form-group">
                <label for="objetivos">üéØ Objetivos e Motiva√ß√µes</label>
                <textarea id="objetivos" name="objetivos" rows="3"
                  placeholder="O que seu personagem busca? Vingan√ßa? Conhecimento? Riqueza? Justi√ßa?"><%= character.objetivos || '' %></textarea>
                <small>O que move seu personagem? Quais s√£o seus sonhos e ambi√ß√µes?</small>
              </div>
            </div>
          </div>

          <!-- Preview do Personagem -->
          <div class="form-section">
            <h3>üëÅÔ∏è Preview do Personagem</h3>
            <div class="card character-preview" id="characterPreview">
              <div class="preview-content">
                <div class="preview-header">
                  <h4 id="previewNome">
                    <%= character.nome %>
                  </h4>
                  <p id="previewClasseRaca">Classe Ra√ßa - N√≠vel <%= character.nivel || 1 %>
                  </p>
                </div>

                <div class="preview-stats">
                  <div class="preview-atributos">
                    <h5>Atributos</h5>
                    <div class="attrs-preview" id="attrsPreview">
                      <!-- Preenchido via JavaScript -->
                    </div>
                  </div>

                  <div class="preview-derivadas">
                    <h5>Caracter√≠sticas</h5>
                    <div class="derivadas-preview" id="derivadasPreview">
                      <!-- Preenchido via JavaScript -->
                    </div>
                  </div>
                </div>

                <div class="preview-poderes" id="previewPoderes">
                  <h5>Poderes Selecionados</h5>
                  <div class="poderes-preview" id="poderesPreview">
                    <!-- Preenchido via JavaScript -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="form-actions">
            <button type="submit" class="nav-btn">üíæ Salvar Altera√ß√µes</button>
            <a href="/personagens/<%= character.id %>" class="btn btn-secondary">üëÅÔ∏è Ver Ficha</a>
            <a href="/personagens" class="btn btn-secondary">üìã Meus Personagens</a>
            <button type="button" class="btn btn-secondary" id="resetForm">üîÑ Resetar</button>
          </div>
      </form>
      <% } else { %>
        <!-- Personagem n√£o encontrado -->
        <div class="error-state">
          <div class="error-card">
            <div class="error-icon">üòî</div>
            <h2>Personagem N√£o Encontrado</h2>
            <p>O personagem que voc√™ est√° tentando editar n√£o foi encontrado ou voc√™ n√£o tem permiss√£o para edit√°-lo.
            </p>
            <div class="error-actions">
              <a href="/personagens" class="nav-btn">üìã Meus Personagens</a>
              <a href="/personagens/criar" class="btn btn-secondary">‚ú® Criar Novo</a>
            </div>
          </div>
        </div>
        <% } %>
  </section>

  <!-- Script espec√≠fico para edi√ß√£o de personagem -->
  <script src="/scripts/character-edit.js"></script>

  <%- include('../partials/footer') %>