<%- include('../partials/header', { title: 'Meus Personagens', activePage: 'myCharacters' }) %>

<section class="content-section active">
  <div class="page-header">
    <h2>ğŸ“‹ Meus Personagens</h2>
    <p>Gerencie todos os seus herÃ³is de Arton em um sÃ³ lugar</p>
  </div>
  
  <div class="characters-actions">
    <a href="/personagens/criar" class="nav-btn create-btn">
      âœ¨ Criar Novo Personagem
    </a>
    <div class="view-options">
      <button class="view-btn active" data-view="grid">ğŸ”² Grade</button>
      <button class="view-btn" data-view="list">ğŸ“‹ Lista</button>
    </div>
  </div>

  <% if (characters && characters.length > 0) { %>
    <!-- EstatÃ­sticas rÃ¡pidas -->
    <div class="characters-stats">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-info">
            <span class="stat-number"><%= characters.length %></span>
            <span class="stat-label">Personagens</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">â­</div>
          <div class="stat-info">
            <span class="stat-number">
              <%= characters.reduce((total, char) => total + (char.nivel || 1), 0) %>
            </span>
            <span class="stat-label">NÃ­veis Totais</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">ğŸ†</div>
          <div class="stat-info">
            <span class="stat-number">
              <%= Math.max(...characters.map(char => char.nivel || 1)) %>
            </span>
            <span class="stat-label">Maior NÃ­vel</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">âš”ï¸</div>
          <div class="stat-info">
            <span class="stat-number">
              <%= [...new Set(characters.map(char => char.classe_nome))].length %>
            </span>
            <span class="stat-label">Classes Diferentes</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Grid de Personagens -->
    <div class="characters-container" id="charactersContainer">
      <div class="characters-grid" id="charactersGrid">
        <% characters.forEach(character => { %>
          <div class="character-card" data-id="<%= character.id %>">
            <div class="character-header">
              <div class="character-avatar">
                <% 
                  // Ãcone baseado na classe
                  let classeIcon = 'âš”ï¸';
                  if (character.classe_nome) {
                    switch(character.classe_nome.toLowerCase()) {
                      case 'guerreiro': classeIcon = 'âš”ï¸'; break;
                      case 'ladino': classeIcon = 'ğŸ—¡ï¸'; break;
                      case 'arcanista': classeIcon = 'ğŸ”®'; break;
                      case 'clÃ©rico': classeIcon = 'âœ¨'; break;
                      case 'bÃ¡rbaro': classeIcon = 'ğŸª“'; break;
                      case 'bardo': classeIcon = 'ğŸµ'; break;
                      default: classeIcon = 'âš”ï¸';
                    }
                  }
                %>
                <span class="avatar-icon"><%= classeIcon %></span>
                <div class="level-badge">Nv. <%= character.nivel || 1 %></div>
              </div>
              
              <div class="character-info">
                <h3 class="character-name"><%= character.nome %></h3>
                <p class="character-details">
                  <%= character.classe_nome || 'Classe' %> <%= character.raca_nome || 'RaÃ§a' %>
                </p>
                <% if (character.deus_nome) { %>
                  <p class="character-deity">â­ Devoto de <%= character.deus_nome %></p>
                <% } %>
              </div>
            </div>
            
            <div class="character-stats">
              <div class="stat-row">
                <div class="stat-item">
                  <span class="stat-icon">â¤ï¸</span>
                  <span class="stat-value"><%= character.pontos_vida || 0 %></span>
                  <span class="stat-label">PV</span>
                </div>
                
                <% if (character.pontos_mana && character.pontos_mana > 0) { %>
                  <div class="stat-item">
                    <span class="stat-icon">ğŸ”µ</span>
                    <span class="stat-value"><%= character.pontos_mana %></span>
                    <span class="stat-label">PM</span>
                  </div>
                <% } %>
                
                <div class="stat-item">
                  <span class="stat-icon">ğŸ›¡ï¸</span>
                  <span class="stat-value"><%= character.ca || 10 %></span>
                  <span class="stat-label">CA</span>
                </div>
                
                <% if (character.experiencia && character.experiencia > 0) { %>
                  <div class="stat-item">
                    <span class="stat-icon">â­</span>
                    <span class="stat-value"><%= character.experiencia %></span>
                    <span class="stat-label">XP</span>
                  </div>
                <% } %>
              </div>
            </div>
            
            <div class="character-attributes">
              <div class="attributes-row">
                <div class="attr-item">
                  <span class="attr-label">FOR</span>
                  <span class="attr-value"><%= character.forca || 10 %></span>
                </div>
                <div class="attr-item">
                  <span class="attr-label">DES</span>
                  <span class="attr-value"><%= character.destreza || 10 %></span>
                </div>
                <div class="attr-item">
                  <span class="attr-label">CON</span>
                  <span class="attr-value"><%= character.constituicao || 10 %></span>
                </div>
                <div class="attr-item">
                  <span class="attr-label">INT</span>
                  <span class="attr-value"><%= character.inteligencia || 10 %></span>
                </div>
                <div class="attr-item">
                  <span class="attr-label">SAB</span>
                  <span class="attr-value"><%= character.sabedoria || 10 %></span>
                </div>
                <div class="attr-item">
                  <span class="attr-label">CAR</span>
                  <span class="attr-value"><%= character.carisma || 10 %></span>
                </div>
              </div>
            </div>
            
            <div class="character-meta">
              <div class="creation-date">
                ğŸ“… Criado em <%= new Date(character.created_at).toLocaleDateString('pt-BR') %>
              </div>
              <% if (character.updated_at && character.updated_at !== character.created_at) { %>
                <div class="last-modified">
                  âœï¸ Editado em <%= new Date(character.updated_at).toLocaleDateString('pt-BR') %>
                </div>
              <% } %>
            </div>
            
            <div class="character-actions">
              <a href="/personagens/<%= character.id %>" class="action-btn view-btn">
                ğŸ‘ï¸ Ver Ficha
              </a>
              <a href="/personagens/<%= character.id %>/editar" class="action-btn edit-btn">
                âœï¸ Editar
              </a>
              <button class="action-btn delete-btn" data-id="<%= character.id %>" data-name="<%= character.nome %>" onclick="deleteCharacter('<%= character.id %>')">
                ğŸ—‘ï¸ Excluir
              </button>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  <% } else { %>
    <!-- Estado vazio -->
    <div class="empty-state">
      <div class="empty-card">
        <div class="empty-icon">ğŸ“</div>
        <h3>Nenhum Personagem Criado</h3>
        <p>VocÃª ainda nÃ£o possui nenhum herÃ³i em sua jornada por Arton.</p>
        <p>Que tal criar seu primeiro personagem Ã©pico?</p>
        
        <div class="empty-actions">
          <a href="/personagens/criar" class="nav-btn">âœ¨ Criar Primeiro Personagem</a>
          <a href="/racas" class="btn btn-secondary">ğŸ§ Explorar RaÃ§as</a>
        </div>
      </div>
      
      <!-- Dicas para iniciantes -->
      <div class="starter-tips">
        <h3>ğŸ’¡ Dicas para ComeÃ§ar</h3>
        <div class="tips-grid">
          <div class="tip-card">
            <h4>1ï¸âƒ£ Escolha a RaÃ§a</h4>
            <p>Comece explorando as raÃ§as disponÃ­veis e suas caracterÃ­sticas Ãºnicas.</p>
            <a href="/racas">Ver RaÃ§as â†’</a>
          </div>
          
          <div class="tip-card">
            <h4>2ï¸âƒ£ Selecione a Classe</h4>
            <p>Cada classe oferece um estilo de jogo diferente. Encontre o seu!</p>
            <a href="/classes">Ver Classes â†’</a>
          </div>
          
          <div class="tip-card">
            <h4>3ï¸âƒ£ ConheÃ§a os Deuses</h4>
            <p>Os deuses de Arton concedem poderes especiais aos seus seguidores.</p>
            <a href="/deuses">Ver Deuses â†’</a>
          </div>
          
          <div class="tip-card">
            <h4>4ï¸âƒ£ Crie Sua HistÃ³ria</h4>
            <p>Desenvolva a personalidade e background do seu personagem.</p>
            <a href="/personagens/criar">Criar Agora â†’</a>
          </div>
        </div>
      </div>
    </div>
  <% } %>
</section>

<!-- Modal de ConfirmaÃ§Ã£o de ExclusÃ£o -->
<div id="deleteModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âš ï¸ Confirmar ExclusÃ£o</h3>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o personagem <strong id="characterToDelete"></strong>?</p>
      <p class="warning-text">Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="cancelDelete">Cancelar</button>
      <button class="btn btn-danger" id="confirmDelete">ğŸ—‘ï¸ Excluir Personagem</button>
    </div>
  </div>
</div>

<!-- Script especÃ­fico para meus personagens -->
<script src="/scripts/my-characters.js"></script>

<script>
// SoluÃ§Ã£o de emergÃªncia para botÃµes de delete
function initEmergencyDelete() {
  console.log('ğŸš¨ Iniciando correÃ§Ã£o de emergÃªncia para delete');
  
  // FunÃ§Ã£o para deletar personagem
  window.deleteCharacter = async function(characterId, characterName) {
    console.log(`ğŸ—‘ï¸ Tentando deletar: ${characterName} (ID: ${characterId})`);
    
    // ConfirmaÃ§Ã£o simples
    const confirmed = confirm(`Tem certeza que deseja excluir o personagem "${characterName}"?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita!`);
    
    if (!confirmed) {
      console.log('âŒ ExclusÃ£o cancelada pelo usuÃ¡rio');
      return;
    }
    
    try {
      console.log(`ğŸ“¡ Enviando requisiÃ§Ã£o DELETE para /personagens/${characterId}`);
      
      const response = await fetch(`/personagens/${characterId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log(`ğŸ“¡ Resposta: ${response.status} ${response.statusText}`);
      
      if (response.ok) {
        console.log('âœ… Personagem excluÃ­do com sucesso');
        alert('Personagem excluÃ­do com sucesso!');
        
        // Recarregar a pÃ¡gina para atualizar a lista
        window.location.reload();
      } else {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
    } catch (error) {
      console.error('âŒ Erro ao excluir personagem:', error);
      alert('Erro ao excluir personagem. Tente novamente.');
    }
  };
  
  // Anexar eventos aos botÃµes existentes
  const deleteButtons = document.querySelectorAll('.delete-btn, button[data-id]');
  console.log(`ğŸ” Encontrados ${deleteButtons.length} botÃµes de delete`);
  
  deleteButtons.forEach((btn, index) => {
    const characterId = btn.dataset.id || btn.getAttribute('data-id');
    const characterName = btn.dataset.name || btn.getAttribute('data-name') || 'Personagem';
    
    console.log(`Configurando botÃ£o ${index + 1}: ID=${characterId}, Nome=${characterName}`);
    
    if (characterId) {
      // Remover eventos existentes
      btn.onclick = null;
      
      // Adicionar novo evento
      btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        deleteCharacter(characterId, characterName);
      };
      
      // Garantir que o botÃ£o seja visÃ­vel e clicÃ¡vel
      btn.style.cursor = 'pointer';
      btn.style.pointerEvents = 'auto';
      
      console.log(`âœ… Evento anexado ao botÃ£o ${index + 1}`);
    } else {
      console.warn(`âš ï¸ BotÃ£o ${index + 1} nÃ£o tem data-id`);
    }
  });
  
  console.log('âœ… CorreÃ§Ã£o de emergÃªncia aplicada');
}

// Executar quando DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initEmergencyDelete);
} else {
  initEmergencyDelete();
}

// Executar novamente apÃ³s um delay para garantir
setTimeout(initEmergencyDelete, 1000);
</script>

<%- include('../partials/footer') %>