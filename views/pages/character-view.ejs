<%- include('../partials/header', { 
  title: (typeof character !== 'undefined' && character) ? `${character.nome} - Ficha` : 'Personagem - Ficha', 
  activePage: 'characterView' 
}) %>

<% if (typeof character !== 'undefined' && character) { %>
  <section class="content-section active character-sheet">
    <!-- Header do Personagem -->
    <div class="character-header-section">
      <div class="character-main-info">
        <div class="character-portrait">
          <% 
            // Ãcone baseado na classe
            let classeIcon = 'âš”ï¸';
            if (character.classe_nome) {
              switch(character.classe_nome.toLowerCase()) {
                case 'guerreiro': classeIcon = 'âš”ï¸'; break;
                case 'ladino': classeIcon = 'ğŸ—¡ï¸'; break;
                case 'arcanista': classeIcon = 'ğŸ”®'; break;
                case 'clÃ©rico': classeIcon = 'âœ¨'; break;
                case 'bÃ¡rbaro': classeIcon = 'ğŸª“'; break;
                case 'bardo': classeIcon = 'ğŸµ'; break;
                default: classeIcon = 'âš”ï¸';
              }
            }
          %>
          <div class="portrait-icon"><%= classeIcon %></div>
          <div class="level-badge">NÃ­vel <%= character.nivel || 1 %></div>
        </div>
        
        <div class="character-identity">
          <h1 class="character-name"><%= character.nome %></h1>
          <p class="character-class-race">
            <%= character.classe_nome || 'Classe' %> <%= character.raca_nome || 'RaÃ§a' %>
          </p>
          <% if (character.deus_nome) { %>
            <p class="character-deity">â­ Devoto de <%= character.deus_nome %></p>
          <% } %>
          <% if (character.experiencia && character.experiencia > 0) { %>
            <p class="character-xp">ğŸŒŸ <%= character.experiencia %> XP</p>
          <% } %>
        </div>
        
        <div class="character-actions">
          <a href="/personagens/<%= character.id %>/editar" class="action-btn edit-btn">
            âœï¸ Editar Personagem
          </a>
          <a href="/personagens" class="action-btn back-btn">
            â† Meus Personagens
          </a>
        </div>
      </div>
    </div>

    <!-- CaracterÃ­sticas Principais -->
    <div class="main-characteristics">
      <div class="characteristic-card vital-stats">
        <h3>ğŸ’™ CaracterÃ­sticas Vitais</h3>
        <div class="vital-grid">
          <div class="vital-item pv">
            <div class="vital-icon">â¤ï¸</div>
            <div class="vital-info">
              <span class="vital-value"><%= character.pontos_vida || 0 %></span>
              <span class="vital-label">Pontos de Vida</span>
            </div>
          </div>
          
          <% if (character.pontos_mana && character.pontos_mana > 0) { %>
            <div class="vital-item pm">
              <div class="vital-icon">ğŸ”µ</div>
              <div class="vital-info">
                <span class="vital-value"><%= character.pontos_mana %></span>
                <span class="vital-label">Pontos de Mana</span>
              </div>
            </div>
          <% } %>
          
          <div class="vital-item ca">
            <div class="vital-icon">ğŸ›¡ï¸</div>
            <div class="vital-info">
              <span class="vital-value"><%= character.ca || 10 %></span>
              <span class="vital-label">Classe de Armadura</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Atributos -->
    <div class="attributes-section">
      <h3>ğŸ’ª Atributos</h3>
      <div class="attributes-grid">
        <div class="attribute-card">
          <div class="attr-icon">ğŸ’ª</div>
          <div class="attr-info">
            <span class="attr-name">ForÃ§a</span>
            <span class="attr-value"><%= character.forca || 10 %></span>
            <span class="attr-modifier">
              <% 
                const forcaMod = Math.floor(((character.forca || 10) - 10) / 2);
                const forcaModText = forcaMod >= 0 ? '+' + forcaMod : forcaMod;
              %>
              (<%= forcaModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸƒ</div>
          <div class="attr-info">
            <span class="attr-name">Destreza</span>
            <span class="attr-value"><%= character.destreza || 10 %></span>
            <span class="attr-modifier">
              <% 
                const destrezaMod = Math.floor(((character.destreza || 10) - 10) / 2);
                const destrezaModText = destrezaMod >= 0 ? '+' + destrezaMod : destrezaMod;
              %>
              (<%= destrezaModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">â¤ï¸â€ğŸ”¥</div>
          <div class="attr-info">
            <span class="attr-name">ConstituiÃ§Ã£o</span>
            <span class="attr-value"><%= character.constituicao || 10 %></span>
            <span class="attr-modifier">
              <% 
                const constMod = Math.floor(((character.constituicao || 10) - 10) / 2);
                const constModText = constMod >= 0 ? '+' + constMod : constMod;
              %>
              (<%= constModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸ§ </div>
          <div class="attr-info">
            <span class="attr-name">InteligÃªncia</span>
            <span class="attr-value"><%= character.inteligencia || 10 %></span>
            <span class="attr-modifier">
              <% 
                const intMod = Math.floor(((character.inteligencia || 10) - 10) / 2);
                const intModText = intMod >= 0 ? '+' + intMod : intMod;
              %>
              (<%= intModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸ§™</div>
          <div class="attr-info">
            <span class="attr-name">Sabedoria</span>
            <span class="attr-value"><%= character.sabedoria || 10 %></span>
            <span class="attr-modifier">
              <% 
                const sabMod = Math.floor(((character.sabedoria || 10) - 10) / 2);
                const sabModText = sabMod >= 0 ? '+' + sabMod : sabMod;
              %>
              (<%= sabModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸ˜</div>
          <div class="attr-info">
            <span class="attr-name">Carisma</span>
            <span class="attr-value"><%= character.carisma || 10 %></span>
            <span class="attr-modifier">
              <% 
                const carMod = Math.floor(((character.carisma || 10) - 10) / 2);
                const carModText = carMod >= 0 ? '+' + carMod : carMod;
              %>
              (<%= carModText %>)
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Poderes -->
    <% if (typeof poderes !== 'undefined' && poderes && poderes.length > 0) { %>
      <div class="powers-section">
        <h3>âœ¨ Poderes do Personagem</h3>
        
        <% if (typeof poderesPorTipo !== 'undefined' && poderesPorTipo && Object.keys(poderesPorTipo).length > 0) { %>
          <div class="powers-by-type">
            <% Object.entries(poderesPorTipo).forEach(([tipo, poderesTipo]) => { %>
              <div class="power-type-section">
                <h4 class="power-type-title">
                  <% 
                    let tipoIcon = 'âœ¨';
                    let tipoNome = tipo;
                    switch(tipo) {
                      case 'racial': tipoIcon = 'ğŸ§¬'; tipoNome = 'Poderes Raciais'; break;
                      case 'geral': tipoIcon = 'âš¡'; tipoNome = 'Poderes Gerais'; break;
                      case 'combate': tipoIcon = 'âš”ï¸'; tipoNome = 'Poderes de Combate'; break;
                      case 'destino': tipoIcon = 'ğŸŒŸ'; tipoNome = 'Poderes de Destino'; break;
                      case 'magia': tipoIcon = 'ğŸ”®'; tipoNome = 'Poderes de Magia'; break;
                      case 'concedido': tipoIcon = 'â­'; tipoNome = 'Poderes Concedidos'; break;
                      case 'tormenta': tipoIcon = 'ğŸ’€'; tipoNome = 'Poderes da Tormenta'; break;
                    }
                  %>
                  <%= tipoIcon %> <%= tipoNome %> (<%= poderesTipo.length %>)
                </h4>
                
                <div class="powers-grid">
                  <% poderesTipo.forEach(poder => { %>
                    <div class="power-card-view">
                      <div class="power-header-view">
                        <h5 class="power-name-view"><%= poder.nome %></h5>
                        <span class="power-source">
                          <% 
                            let sourceIcon = 'ğŸ“';
                            let sourceText = poder.fonte;
                            switch(poder.fonte) {
                              case 'raca': sourceIcon = 'ğŸ§¬'; sourceText = 'Racial'; break;
                              case 'escolha': sourceIcon = 'âš¡'; sourceText = 'Escolhido'; break;
                              case 'classe': sourceIcon = 'âš”ï¸'; sourceText = 'Classe'; break;
                              case 'deus': sourceIcon = 'â­'; sourceText = 'Divino'; break;
                            }
                          %>
                          <%= sourceIcon %> <%= sourceText %>
                        </span>
                      </div>
                      
                      <div class="power-content-view">
                        <p class="power-description-view"><%= poder.descricao %></p>
                        
                        <% if (poder.pre_requisitos) { %>
                          <div class="power-detail">
                            <strong>ğŸ“‹ PrÃ©-requisitos:</strong> <%= poder.pre_requisitos %>
                          </div>
                        <% } %>
                        
                        <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                          <div class="power-detail">
                            <strong>ğŸ’™ Custo:</strong> <%= poder.custo_pm %> PM
                          </div>
                        <% } %>
                        
                        <% if (poder.efeito_especial) { %>
                          <div class="power-detail">
                            <strong>âš¡ Efeito Especial:</strong> <%= poder.efeito_especial %>
                          </div>
                        <% } %>
                        
                        <% if (poder.observacoes) { %>
                          <div class="power-detail power-notes">
                            <strong>ğŸ“ ObservaÃ§Ãµes:</strong> <%= poder.observacoes %>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <!-- Lista simples caso nÃ£o tenha agrupamento por tipo -->
          <div class="powers-list">
            <% poderes.forEach(poder => { %>
              <div class="power-card-view">
                <div class="power-header-view">
                  <h5 class="power-name-view"><%= poder.nome %></h5>
                  <span class="power-source">
                    <% 
                      let sourceIcon = 'ğŸ“';
                      let sourceText = poder.fonte;
                      switch(poder.fonte) {
                        case 'raca': sourceIcon = 'ğŸ§¬'; sourceText = 'Racial'; break;
                        case 'escolha': sourceIcon = 'âš¡'; sourceText = 'Escolhido'; break;
                        case 'classe': sourceIcon = 'âš”ï¸'; sourceText = 'Classe'; break;
                        case 'deus': sourceIcon = 'â­'; sourceText = 'Divino'; break;
                      }
                    %>
                    <%= sourceIcon %> <%= sourceText %>
                  </span>
                </div>
                
                <div class="power-content-view">
                  <p class="power-description-view"><%= poder.descricao %></p>
                  
                  <% if (poder.observacoes) { %>
                    <div class="power-detail power-notes">
                      <strong>ğŸ“ ObservaÃ§Ãµes:</strong> <%= poder.observacoes %>
                    </div>
                  <% } %>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    <% } %>

    <!-- HistÃ³ria e Personalidade -->
    <% if (character.historia_pessoal || character.personalidade || character.objetivos) { %>
      <div class="background-section">
        <h3>ğŸ“œ HistÃ³ria e Personalidade</h3>
        <div class="background-grid">
          <% if (character.historia_pessoal) { %>
            <div class="background-card">
              <h4>ğŸ“– HistÃ³ria Pessoal</h4>
              <div class="background-content">
                <p><%= character.historia_pessoal %></p>
              </div>
            </div>
          <% } %>
          
          <% if (character.personalidade) { %>
            <div class="background-card">
              <h4>ğŸ­ Personalidade</h4>
              <div class="background-content">
                <p><%= character.personalidade %></p>
              </div>
            </div>
          <% } %>
          
          <% if (character.objetivos) { %>
            <div class="background-card">
              <h4>ğŸ¯ Objetivos e MotivaÃ§Ãµes</h4>
              <div class="background-content">
                <p><%= character.objetivos %></p>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    <% } %>

    <!-- InformaÃ§Ãµes TÃ©cnicas -->
    <div class="technical-info">
      <h3>â„¹ï¸ InformaÃ§Ãµes do Sistema</h3>
      <div class="tech-grid">
        <div class="tech-card">
          <h4>ğŸ“… CriaÃ§Ã£o</h4>
          <p><%= new Date(character.created_at).toLocaleDateString('pt-BR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) %></p>
        </div>
        
        <% if (character.updated_at && character.updated_at !== character.created_at) { %>
          <div class="tech-card">
            <h4>âœï¸ Ãšltima EdiÃ§Ã£o</h4>
            <p><%= new Date(character.updated_at).toLocaleDateString('pt-BR', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) %></p>
          </div>
        <% } %>
        
        <div class="tech-card">
          <h4>ğŸ†” ID do Personagem</h4>
          <p><code>#<%= character.id %></code></p>
        </div>
      </div>
    </div>

    <!-- AÃ§Ãµes Adicionais -->
    <div class="additional-actions">
      <div class="actions-card">
        <h3>ğŸ› ï¸ AÃ§Ãµes DisponÃ­veis</h3>
        <div class="actions-grid">
          <button class="action-btn utility-btn" onclick="window.print()">
            ğŸ–¨ï¸ Imprimir Ficha
          </button>
          
          <button class="action-btn utility-btn" onclick="exportCharacter()">
            ğŸ“¥ Exportar Dados
          </button>
          
          <button class="action-btn utility-btn" onclick="shareCharacter()">
            ğŸ“¤ Compartilhar
          </button>
          
          <button class="action-btn danger-btn" onclick="confirmDelete()">
            ğŸ—‘ï¸ Excluir Personagem
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal de ConfirmaÃ§Ã£o de ExclusÃ£o -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âš ï¸ Confirmar ExclusÃ£o</h3>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir o personagem <strong><%= character.nome %></strong>?</p>
        <p class="warning-text">Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
        <button class="btn btn-danger" onclick="deleteCharacter()">ğŸ—‘ï¸ Excluir Personagem</button>
      </div>
    </div>
  </div>

<% } else { %>
  <!-- Personagem nÃ£o encontrado -->
  <section class="content-section active">
    <div class="error-state">
      <div class="error-card">
        <div class="error-icon">ğŸ˜”</div>
        <h2>Personagem NÃ£o Encontrado</h2>
        <p>O personagem que vocÃª estÃ¡ procurando nÃ£o existe ou vocÃª nÃ£o tem permissÃ£o para visualizÃ¡-lo.</p>
        <div class="error-actions">
          <a href="/personagens" class="nav-btn">ğŸ“‹ Meus Personagens</a>
          <a href="/personagens/criar" class="btn btn-secondary">âœ¨ Criar Novo</a>
        </div>
      </div>
    </div>
  </section>
<% } %>

<!-- Script especÃ­fico para visualizaÃ§Ã£o de personagem -->
<script src="/scripts/character-view.js"></script>

<%- include('../partials/footer') %>