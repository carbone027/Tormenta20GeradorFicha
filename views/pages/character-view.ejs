<%- include('../partials/header', { 
  title: (typeof character !== 'undefined' && character) ? `${character.nome} - Ficha` : 'Personagem - Ficha', 
  activePage: 'characterView' 
}) %>

<%
// ===== ADICIONAR A FUNÃ‡ÃƒO AQUI, LOGO APÃ“S O INCLUDE DO HEADER =====
// FunÃ§Ã£o para gerar Ã­cones de poderes
function getPowerIcon(poder, tipo) {
  const nome = (poder.nome || '').toLowerCase();
  const tipoLower = (tipo || poder.tipo || '').toLowerCase();
  const descricao = (poder.descricao || '').toLowerCase();
  
  // Ãcones especÃ­ficos por palavra-chave no nome
  if (nome.includes('ataque') || nome.includes('golpe')) return 'âš”ï¸';
  if (nome.includes('defesa') || nome.includes('proteÃ§Ã£o')) return 'ğŸ›¡ï¸';
  if (nome.includes('cura') || nome.includes('curar')) return 'ğŸ’š';
  if (nome.includes('fogo') || nome.includes('chamas')) return 'ğŸ”¥';
  if (nome.includes('gelo') || nome.includes('frio')) return 'â„ï¸';
  if (nome.includes('raio') || nome.includes('elÃ©trico')) return 'âš¡';
  if (nome.includes('vento') || nome.includes('ar')) return 'ğŸ’¨';
  if (nome.includes('terra') || nome.includes('pedra')) return 'ğŸŒ';
  if (nome.includes('Ã¡gua') || nome.includes('aquÃ¡tico')) return 'ğŸ’§';
  if (nome.includes('luz') || nome.includes('sagrado')) return 'â˜€ï¸';
  if (nome.includes('trevas') || nome.includes('sombra')) return 'ğŸŒ‘';
  if (nome.includes('movimento') || nome.includes('velocidade')) return 'ğŸƒ';
  if (nome.includes('voo') || nome.includes('voar')) return 'ğŸ¦…';
  if (nome.includes('salto') || nome.includes('pular')) return 'ğŸ¦˜';
  if (nome.includes('furtividade') || nome.includes('stealth')) return 'ğŸ‘¤';
  if (nome.includes('percepÃ§Ã£o') || nome.includes('visÃ£o')) return 'ğŸ‘ï¸';
  if (nome.includes('forÃ§a') || nome.includes('poder')) return 'ğŸ’ª';
  if (nome.includes('garras') || nome.includes('presas')) return 'ğŸ¾';
  if (nome.includes('asas')) return 'ğŸ¦…';
  if (nome.includes('cauda') || nome.includes('rabo')) return 'ğŸ¦';
  if (nome.includes('chifres') || nome.includes('cornos')) return 'ğŸ‚';
  if (nome.includes('pelo') || nome.includes('pelagem')) return 'ğŸº';
  if (nome.includes('escamas') || nome.includes('escamoso')) return 'ğŸ';
  if (nome.includes('veneno') || nome.includes('tÃ³xico')) return 'â˜£ï¸';
  if (nome.includes('maldiÃ§Ã£o') || nome.includes('amaldiÃ§oar')) return 'ğŸ–¤';
  if (nome.includes('bÃªnÃ§Ã£o') || nome.includes('abenÃ§oar')) return 'ğŸ™';
  if (nome.includes('sorte') || nome.includes('fortuna')) return 'ğŸ€';
  if (nome.includes('conhecimento') || nome.includes('saber')) return 'ğŸ“š';
  if (nome.includes('lideranÃ§a') || nome.includes('comando')) return 'ğŸ‘‘';
  if (nome.includes('intimidaÃ§Ã£o') || nome.includes('medo')) return 'ğŸ˜ ';
  if (nome.includes('persuasÃ£o') || nome.includes('convencer')) return 'ğŸ’¬';
  if (nome.includes('diplomacia') || nome.includes('negociar')) return 'ğŸ¤';
  if (nome.includes('tiro') || nome.includes('disparo')) return 'ğŸ¹';
  if (nome.includes('crÃ­tico') || nome.includes('mortal')) return 'ğŸ’€';
  if (nome.includes('regeneraÃ§Ã£o') || nome.includes('recuperar')) return 'ğŸŒ¿';
  if (nome.includes('aura') || nome.includes('presenÃ§a')) return 'ğŸŒŸ';
  if (nome.includes('ritual') || nome.includes('cerimÃ´nia')) return 'ğŸ•¯ï¸';
  if (nome.includes('runa') || nome.includes('marca')) return 'ğŸ“œ';
  if (nome.includes('animal') || nome.includes('besta')) return 'ğŸº';
  if (nome.includes('natureza') || nome.includes('selvagem')) return 'ğŸŒ¿';
  if (nome.includes('caÃ§a') || nome.includes('rastrear')) return 'ğŸ¹';
  if (nome.includes('heroico') || nome.includes('Ã©pico')) return 'ğŸ†';
  if (nome.includes('lendÃ¡rio') || nome.includes('mÃ­tico')) return 'ğŸ‘‘';
  if (nome.includes('tormenta') || nome.includes('corrupÃ§Ã£o')) return 'ğŸ’€';
  if (nome.includes('investida') || nome.includes('carga')) return 'ğŸ‡';
  if (nome.includes('combo') || nome.includes('sequÃªncia')) return 'ğŸŒ€';
  if (nome.includes('rajada') || nome.includes('mÃºltiplo')) return 'ğŸ’¨';
  if (nome.includes('bloqueio') || nome.includes('parar')) return 'ğŸš«';
  if (nome.includes('esquiva') || nome.includes('desviar')) return 'ğŸ’¨';
  if (nome.includes('absorÃ§Ã£o') || nome.includes('absorver')) return 'ğŸŒ€';
  if (nome.includes('teleporte') || nome.includes('transportar')) return 'âš¡';
  if (nome.includes('escalada') || nome.includes('escalar')) return 'ğŸ§—';
  if (nome.includes('nataÃ§Ã£o') || nome.includes('nadar')) return 'ğŸŠ';
  if (nome.includes('acrobacia') || nome.includes('acrobÃ¡tico')) return 'ğŸ¤¸';
  if (nome.includes('atletismo') || nome.includes('atlÃ©tico')) return 'ğŸ’ª';
  if (nome.includes('investigaÃ§Ã£o') || nome.includes('investigar')) return 'ğŸ”';
  if (nome.includes('enganaÃ§Ã£o') || nome.includes('enganar')) return 'ğŸ­';
  if (nome.includes('faro') || nome.includes('olfato')) return 'ğŸ‘ƒ';
  if (nome.includes('audiÃ§Ã£o') || nome.includes('ouvir')) return 'ğŸ‘‚';
  
  // Ãcones por tipo com variaÃ§Ã£o
  const iconsByType = {
    'combate': ['âš”ï¸', 'ğŸ—¡ï¸', 'ğŸ¹', 'ğŸ’ª', 'ğŸ‘Š', 'ğŸ›¡ï¸', 'ğŸ’¥', 'âš¡'],
    'magia': ['ğŸ”®', 'âœ¨', 'ğŸª„', 'ğŸŒŸ', 'âš¡', 'ğŸ”¥', 'â„ï¸', 'ğŸ’«'],
    'destino': ['ğŸŒŸ', 'ğŸ¯', 'ğŸ’«', 'ğŸ€', 'ğŸ“ˆ', 'ğŸ²', 'ğŸ’', 'â­'],
    'racial': ['ğŸ§¬', 'ğŸ‘ï¸', 'ğŸ¦…', 'ğŸº', 'ğŸŒ¿', 'âš¡', 'ğŸ¾', 'ğŸ’ª'],
    'geral': ['âš¡', 'ğŸ’¡', 'ğŸ”§', 'ğŸ¯', 'ğŸ“š', 'ğŸƒ', 'ğŸ’ª', 'ğŸŒŸ'],
    'concedido': ['â­', 'ğŸ™', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ‘‘', 'ğŸ’', 'ğŸ”¸'],
    'tormenta': ['ğŸ’€', 'â˜ ï¸', 'ğŸ–¤', 'ğŸ‘»', 'ğŸŒ‘', 'âš¡', 'ğŸ’¥', 'ğŸ”¥'],
    'classe': ['âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ¹', 'ğŸ’ª', 'ğŸŒŸ', 'âš¡', 'ğŸ”¥', 'âœ¨']
  };
  
  if (iconsByType[tipoLower]) {
    const icons = iconsByType[tipoLower];
    let hash = 0;
    for (let i = 0; i < nome.length; i++) {
      hash = ((hash << 5) - hash + nome.charCodeAt(i)) & 0xffffffff;
    }
    return icons[Math.abs(hash) % icons.length];
  }
  
  // AnÃ¡lise da descriÃ§Ã£o
  if (descricao.includes('dano') || descricao.includes('ataque')) return 'âš”ï¸';
  if (descricao.includes('cura') || descricao.includes('recupera')) return 'ğŸ’š';
  if (descricao.includes('movimento') || descricao.includes('mover')) return 'ğŸƒ';
  if (descricao.includes('defesa') || descricao.includes('ca')) return 'ğŸ›¡ï¸';
  if (descricao.includes('magia')) return 'ğŸ”®';
  if (descricao.includes('perÃ­cia')) return 'ğŸ¯';
  
  // Ãcone padrÃ£o Ãºnico
  const fallbackIcons = ['âš¡', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ’', 'ğŸ­', 'ğŸ¯', 'ğŸ”§'];
  let charSum = 0;
  for (let i = 0; i < nome.length; i++) {
    charSum += nome.charCodeAt(i);
  }
  return fallbackIcons[charSum % fallbackIcons.length];
}
// ===== FIM DA FUNÃ‡ÃƒO =====
%>

<% if (typeof character !== 'undefined' && character) { %>
  <section class="content-section active character-sheet">
    <!-- Header do Personagem -->
    <div class="character-header-section">
      <div class="character-main-info">
        <div class="character-portrait">
          <% 
            // Ãcone baseado na classe
            let classeIcon = 'âš”ï¸';
            if (character.classe_nome) {
              switch(character.classe_nome.toLowerCase()) {
                case 'guerreiro': classeIcon = 'âš”ï¸'; break;
                case 'ladino': classeIcon = 'ğŸ—¡ï¸'; break;
                case 'arcanista': classeIcon = 'ğŸ”®'; break;
                case 'clÃ©rico': classeIcon = 'âœ¨'; break;
                case 'bÃ¡rbaro': classeIcon = 'ğŸª“'; break;
                case 'bardo': classeIcon = 'ğŸµ'; break;
                default: classeIcon = 'âš”ï¸';
              }
            }
          %>
          <div class="portrait-icon"><%= classeIcon %></div>
          <div class="level-badge">NÃ­vel <%= character.nivel || 1 %></div>
        </div>
        
        <div class="character-identity">
          <h1 class="character-name"><%= character.nome %></h1>
          <p class="character-class-race">
            <%= character.classe_nome || 'Classe' %> <%= character.raca_nome || 'RaÃ§a' %>
          </p>
          <% if (character.deus_nome) { %>
            <p class="character-deity">â­ Devoto de <%= character.deus_nome %></p>
          <% } %>
          <% if (character.experiencia && character.experiencia > 0) { %>
            <p class="character-xp">ğŸŒŸ <%= character.experiencia %> XP</p>
          <% } %>
        </div>
        
        <div class="character-actions">
          <a href="/personagens/<%= character.id %>/editar" class="action-btn edit-btn">
            âœï¸ Editar Personagem
          </a>
          <a href="/personagens" class="action-btn back-btn">
            â† Meus Personagens
          </a>
        </div>
      </div>
    </div>

    <!-- CaracterÃ­sticas Principais -->
    <div class="main-characteristics">
      <div class="characteristic-card vital-stats">
        <h3>ğŸ’™ CaracterÃ­sticas Vitais</h3>
        <div class="vital-grid">
          <div class="vital-item pv">
            <div class="vital-icon">â¤ï¸</div>
            <div class="vital-info">
              <span class="vital-value"><%= character.pontos_vida || 0 %></span>
              <span class="vital-label">Pontos de Vida</span>
            </div>
          </div>
          
          <% if (character.pontos_mana && character.pontos_mana > 0) { %>
            <div class="vital-item pm">
              <div class="vital-icon">ğŸ”µ</div>
              <div class="vital-info">
                <span class="vital-value"><%= character.pontos_mana %></span>
                <span class="vital-label">Pontos de Mana</span>
              </div>
            </div>
          <% } %>
          
          <div class="vital-item ca">
            <div class="vital-icon">ğŸ›¡ï¸</div>
            <div class="vital-info">
              <span class="vital-value"><%= character.ca || 10 %></span>
              <span class="vital-label">Classe de Armadura</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Atributos -->
    <div class="attributes-section">
      <h3>ğŸ’ª Atributos</h3>
      <div class="attributes-grid">
        <div class="attribute-card">
          <div class="attr-icon">ğŸ’ª</div>
          <div class="attr-info">
            <span class="attr-name">ForÃ§a</span>
            <span class="attr-value"><%= character.forca || 10 %></span>
            <span class="attr-modifier">
              <% 
                const forcaMod = Math.floor(((character.forca || 10) - 10) / 2);
                const forcaModText = forcaMod >= 0 ? '+' + forcaMod : forcaMod;
              %>
              (<%= forcaModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸƒ</div>
          <div class="attr-info">
            <span class="attr-name">Destreza</span>
            <span class="attr-value"><%= character.destreza || 10 %></span>
            <span class="attr-modifier">
              <% 
                const destrezaMod = Math.floor(((character.destreza || 10) - 10) / 2);
                const destrezaModText = destrezaMod >= 0 ? '+' + destrezaMod : destrezaMod;
              %>
              (<%= destrezaModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">â¤ï¸â€ğŸ”¥</div>
          <div class="attr-info">
            <span class="attr-name">ConstituiÃ§Ã£o</span>
            <span class="attr-value"><%= character.constituicao || 10 %></span>
            <span class="attr-modifier">
              <% 
                const constMod = Math.floor(((character.constituicao || 10) - 10) / 2);
                const constModText = constMod >= 0 ? '+' + constMod : constMod;
              %>
              (<%= constModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸ§ </div>
          <div class="attr-info">
            <span class="attr-name">InteligÃªncia</span>
            <span class="attr-value"><%= character.inteligencia || 10 %></span>
            <span class="attr-modifier">
              <% 
                const intMod = Math.floor(((character.inteligencia || 10) - 10) / 2);
                const intModText = intMod >= 0 ? '+' + intMod : intMod;
              %>
              (<%= intModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸ§™</div>
          <div class="attr-info">
            <span class="attr-name">Sabedoria</span>
            <span class="attr-value"><%= character.sabedoria || 10 %></span>
            <span class="attr-modifier">
              <% 
                const sabMod = Math.floor(((character.sabedoria || 10) - 10) / 2);
                const sabModText = sabMod >= 0 ? '+' + sabMod : sabMod;
              %>
              (<%= sabModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">ğŸ˜</div>
          <div class="attr-info">
            <span class="attr-name">Carisma</span>
            <span class="attr-value"><%= character.carisma || 10 %></span>
            <span class="attr-modifier">
              <% 
                const carMod = Math.floor(((character.carisma || 10) - 10) / 2);
                const carModText = carMod >= 0 ? '+' + carMod : carMod;
              %>
              (<%= carModText %>)
            </span>
          </div>
        </div>
      </div>
    </div>

<!-- SeÃ§Ã£o de PerÃ­cias Melhorada -->
<% if (pericias && pericias.length > 0) { %>
  <div class="character-skills-section">
    <div class="section-header">
      <h3>
        <span>ğŸ¯</span>
        PerÃ­cias do Personagem
        <span class="skills-count">(<%= pericias.length %> perÃ­cias)</span>
      </h3>
      
      <!-- Filtros para perÃ­cias -->
      <div class="skills-filters">
        <button type="button" class="quick-filter-btn active" data-filter="all">
          âœ¨ Todas
        </button>
        <button type="button" class="quick-filter-btn" data-filter="trained">
          âœ… Treinadas
        </button>
        <button type="button" class="quick-filter-btn" data-filter="usable">
          ğŸ¯ UtilizÃ¡veis
        </button>
        <button type="button" class="quick-filter-btn" data-filter="unusable">
          âŒ Bloqueadas
        </button>
      </div>
    </div>

    <!-- ExplicaÃ§Ã£o do Sistema -->
    <div class="skills-explanation-view">
      <div class="explanation-card">
        <h4>ğŸ“‹ Sistema de PerÃ­cias</h4>
        <div class="explanation-grid">
          <div class="explanation-item">
            <h5>ğŸ² Teste</h5>
            <p>1d20 + Â½ NÃ­vel + Atributo + Treino</p>
          </div>
          <div class="explanation-item">
            <h5>âœ… Treinadas</h5>
            <p>Recebem bÃ´nus de treinamento</p>
          </div>
          <div class="explanation-item">
            <h5>âŒ Bloqueadas</h5>
            <p>Precisam treino para usar</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Container das PerÃ­cias por Categoria -->
    <div class="skills-categories-container">
      <% Object.entries(periciasPorCategoria).forEach(([categoria, periciasCategoria]) => { %>
        <% if (periciasCategoria && periciasCategoria.length > 0) { %>
          <div class="skill-category-section">
            <div class="skill-category-header">
              <h4 class="skill-category-title">
                <% 
                  let categoryIcon = 'ğŸ¯';
                  let categoryName = categoria;
                  switch(categoria.toLowerCase()) {
                    case 'fÃ­sica': categoryIcon = 'ğŸƒ'; categoryName = 'PerÃ­cias FÃ­sicas'; break;
                    case 'combate': categoryIcon = 'âš”ï¸'; categoryName = 'PerÃ­cias de Combate'; break;
                    case 'conhecimento': categoryIcon = 'ğŸ“š'; categoryName = 'PerÃ­cias de Conhecimento'; break;
                    case 'social': categoryIcon = 'ğŸ’¬'; categoryName = 'PerÃ­cias Sociais'; break;
                    case 'percepÃ§Ã£o': categoryIcon = 'ğŸ‘ï¸'; categoryName = 'PerÃ­cias de PercepÃ§Ã£o'; break;
                    case 'resistÃªncia': categoryIcon = 'ğŸ›¡ï¸'; categoryName = 'PerÃ­cias de ResistÃªncia'; break;
                    case 'medicina': categoryIcon = 'ğŸ’š'; categoryName = 'PerÃ­cias de Medicina'; break;
                    default: categoryIcon = 'ğŸ¯'; categoryName = categoria.charAt(0).toUpperCase() + categoria.slice(1); break;
                  }
                %>
                <span><%= categoryIcon %></span>
                <%= categoryName %>
              </h4>
              <div class="skill-category-count">(<%= periciasCategoria.length %> perÃ­cias)</div>
            </div>

            <div class="skills-grid">
              <% periciasCategoria.forEach(pericia => { %>
                <div class="character-skill-card 
                          <%= pericia.treinado ? 'trained' : 'untrained' %> 
                          <%= pericia.pode_usar ? 'usable' : 'unusable' %>" 
                     data-skill-id="<%= pericia.pericia_id %>" 
                     data-trained="<%= pericia.treinado %>" 
                     data-usable="<%= pericia.pode_usar %>">
                  
                  <div class="skill-card-header">
                    <div class="skill-icon-container">
                      <% 
                        let skillIcon = 'ğŸ¯';
                        const nome = pericia.nome.toLowerCase();
                        
                        // Ãcones especÃ­ficos por perÃ­cia
                        if (nome.includes('acrobacia')) skillIcon = 'ğŸ¤¸';
                        else if (nome.includes('atletismo')) skillIcon = 'ğŸ’ª';
                        else if (nome.includes('cavalgar')) skillIcon = 'ğŸ';
                        else if (nome.includes('furtividade')) skillIcon = 'ğŸ‘¤';
                        else if (nome.includes('iniciativa')) skillIcon = 'âš¡';
                        else if (nome.includes('ladinagem')) skillIcon = 'ğŸ”“';
                        else if (nome.includes('luta')) skillIcon = 'ğŸ‘Š';
                        else if (nome.includes('pilotagem')) skillIcon = 'ğŸš—';
                        else if (nome.includes('pontaria')) skillIcon = 'ğŸ¹';
                        else if (nome.includes('reflexos')) skillIcon = 'ğŸ¤º';
                        else if (nome.includes('conhecimento')) skillIcon = 'ğŸ“š';
                        else if (nome.includes('guerra')) skillIcon = 'âš”ï¸';
                        else if (nome.includes('investigaÃ§Ã£o')) skillIcon = 'ğŸ”';
                        else if (nome.includes('misticismo')) skillIcon = 'ğŸ”®';
                        else if (nome.includes('nobreza')) skillIcon = 'ğŸ‘‘';
                        else if (nome.includes('ofÃ­cio')) skillIcon = 'ğŸ”¨';
                        else if (nome.includes('religiÃ£o')) skillIcon = 'ğŸ™';
                        else if (nome.includes('adestramento')) skillIcon = 'ğŸ•';
                        else if (nome.includes('atuaÃ§Ã£o')) skillIcon = 'ğŸ­';
                        else if (nome.includes('diplomacia')) skillIcon = 'ğŸ¤';
                        else if (nome.includes('enganaÃ§Ã£o')) skillIcon = 'ğŸ­';
                        else if (nome.includes('intimidaÃ§Ã£o')) skillIcon = 'ğŸ˜ ';
                        else if (nome.includes('jogatina')) skillIcon = 'ğŸ²';
                        else if (nome.includes('cura')) skillIcon = 'ğŸ’š';
                        else if (nome.includes('intuiÃ§Ã£o')) skillIcon = 'ğŸ’¡';
                        else if (nome.includes('percepÃ§Ã£o')) skillIcon = 'ğŸ‘ï¸';
                        else if (nome.includes('sobrevivÃªncia')) skillIcon = 'ğŸ•ï¸';
                        else if (nome.includes('fortitude')) skillIcon = 'ğŸ›¡ï¸';
                        else if (nome.includes('vontade')) skillIcon = 'ğŸ§ ';
                      %>
                      <div class="skill-icon"><%= skillIcon %></div>
                      
                      <!-- Status Indicators -->
                      <div class="skill-status-indicators">
                        <% if (pericia.treinado) { %>
                          <span class="skill-status-badge trained" title="PerÃ­cia Treinada">âœ…</span>
                        <% } %>
                        
                        <% if (!pericia.pode_usar) { %>
                          <span class="skill-status-badge blocked" title="Precisa ser treinada para usar">âŒ</span>
                        <% } %>
                        
                        <% if (pericia.especialista) { %>
                          <span class="skill-status-badge specialist" title="Especialista (Ladino)">â­</span>
                        <% } %>
                      </div>
                    </div>

                    <div class="skill-info">
                      <h5 class="skill-name"><%= pericia.nome %></h5>
                      <p class="skill-attribute">
                        <% 
                          let attrName = '';
                          let attrIcon = '';
                          switch(pericia.atributo_chave) {
                            case 'for': attrName = 'ForÃ§a'; attrIcon = 'ğŸ’ª'; break;
                            case 'des': attrName = 'Destreza'; attrIcon = 'ğŸƒ'; break;
                            case 'con': attrName = 'ConstituiÃ§Ã£o'; attrIcon = 'â¤ï¸'; break;
                            case 'int': attrName = 'InteligÃªncia'; attrIcon = 'ğŸ§ '; break;
                            case 'sab': attrName = 'Sabedoria'; attrIcon = 'ğŸ§™'; break;
                            case 'car': attrName = 'Carisma'; attrIcon = 'ğŸ˜'; break;
                            default: attrName = pericia.atributo_chave; attrIcon = 'ğŸ¯'; break;
                          }
                        %>
                        <%= attrIcon %> <%= attrName %>
                      </p>
                    </div>

                    <div class="skill-bonus">
                      <div class="bonus-total <%= pericia.pode_usar ? 'usable' : 'blocked' %>">
                        <% if (pericia.pode_usar) { %>
                          +<%= pericia.bonus_total %>
                        <% } else { %>
                          â€”
                        <% } %>
                      </div>
                      <small class="bonus-label">
                        <% if (pericia.pode_usar) { %>
                          BÃ´nus Total
                        <% } else { %>
                          NÃ£o UtilizÃ¡vel
                        <% } %>
                      </small>
                    </div>
                  </div>

                  <div class="skill-card-content">
                    <p class="skill-description"><%= pericia.descricao %></p>

                    <!-- Breakdown do BÃ´nus -->
                    <% if (pericia.pode_usar) { %>
                      <div class="bonus-breakdown">
                        <div class="bonus-item">
                          <span class="bonus-label">NÃ­vel (Â½):</span>
                          <span class="bonus-value">+<%= pericia.bonus_nivel %></span>
                        </div>
                        <div class="bonus-item">
                          <span class="bonus-label"><%= attrName %>:</span>
                          <span class="bonus-value">
                            <%= pericia.bonus_atributo >= 0 ? '+' + pericia.bonus_atributo : pericia.bonus_atributo %>
                          </span>
                        </div>
                        <% if (pericia.treinado) { %>
                          <div class="bonus-item">
                            <span class="bonus-label">Treino:</span>
                            <span class="bonus-value">+<%= pericia.bonus_treinamento %></span>
                          </div>
                          <% if (pericia.especialista) { %>
                            <div class="bonus-item">
                              <span class="bonus-label">Especialista:</span>
                              <span class="bonus-value">+<%= pericia.bonus_treinamento %></span>
                            </div>
                          <% } %>
                        <% } %>
                      </div>
                    <% } else { %>
                      <div class="skill-blocked-notice">
                        <span class="blocked-icon">ğŸ”’</span>
                        <span class="blocked-text">Esta perÃ­cia precisa ser treinada para ser utilizÃ¡vel</span>
                      </div>
                    <% } %>

                    <!-- Tags da PerÃ­cia -->
                    <div class="skill-tags">
                      <span class="skill-tag category"><%= categoryName %></span>
                      
                      <% if (pericia.treinado) { %>
                        <span class="skill-tag trained">Treinada</span>
                      <% } %>
                      
                      <% if (pericia.precisa_treino) { %>
                        <span class="skill-tag needs-training">Requer Treino</span>
                      <% } %>
                      
                      <% if (pericia.origem) { %>
                        <span class="skill-tag origin">
                          <% 
                            let origemText = '';
                            switch(pericia.origem) {
                              case 'classe': origemText = 'Classe'; break;
                              case 'raca': origemText = 'RaÃ§a'; break;
                              case 'escolha': origemText = 'Escolha'; break;
                              case 'inteligencia': origemText = 'InteligÃªncia'; break;
                              default: origemText = pericia.origem; break;
                            }
                          %>
                          <%= origemText %>
                        </span>
                      <% } %>
                    </div>

                    <!-- ObservaÃ§Ãµes -->
                    <% if (pericia.observacoes) { %>
                      <div class="skill-notes">
                        <small><strong>ObservaÃ§Ãµes:</strong> <%= pericia.observacoes %></small>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% } %>
      <% }); %>
    </div>

    <!-- Resumo das PerÃ­cias -->
    <div class="skills-summary">
      <div class="summary-card">
        <h4>ğŸ“Š Resumo das PerÃ­cias</h4>
        <div class="summary-stats">
          <div class="summary-stat">
            <span class="stat-icon">ğŸ¯</span>
            <span class="stat-label">Total:</span>
            <span class="stat-value"><%= pericias.length %></span>
          </div>
          <div class="summary-stat">
            <span class="stat-icon">âœ…</span>
            <span class="stat-label">Treinadas:</span>
            <span class="stat-value"><%= pericias.filter(p => p.treinado).length %></span>
          </div>
          <div class="summary-stat">
            <span class="stat-icon">ğŸ¯</span>
            <span class="stat-label">UtilizÃ¡veis:</span>
            <span class="stat-value"><%= pericias.filter(p => p.pode_usar).length %></span>
          </div>
          <div class="summary-stat">
            <span class="stat-icon">âŒ</span>
            <span class="stat-label">Bloqueadas:</span>
            <span class="stat-value"><%= pericias.filter(p => !p.pode_usar).length %></span>
          </div>
        </div>
      </div>
    </div>
  </div>
<% } else { %>
  <div class="no-skills-message">
    <div class="no-skills-icon">ğŸ“œ</div>
    <h4>Nenhuma PerÃ­cia Registrada</h4>
    <p>Este personagem ainda nÃ£o possui perÃ­cias registradas.</p>
  </div>
<% } %>

    <!-- Poderes -->
<% 
  // DEBUG: Log para verificar dados recebidos
  console.log('ğŸ” DEBUG character-view:');
  console.log('  - poderes definido:', typeof poderes !== 'undefined');
  console.log('  - poderes Ã© array:', Array.isArray(poderes));
  console.log('  - quantidade de poderes:', poderes ? poderes.length : 0);
  console.log('  - poderesPorTipo definido:', typeof poderesPorTipo !== 'undefined');
  console.log('  - tipos disponÃ­veis:', poderesPorTipo ? Object.keys(poderesPorTipo) : 'nenhum');
%>

<!-- SEÃ‡ÃƒO DE PODERES - CORREÃ‡ÃƒO FINAL para character-view.ejs -->
<!-- Substituir a seÃ§Ã£o de poderes existente -->

<% 
  // DEBUG MELHORADO: Verificar dados recebidos
  console.log('ğŸ” ===== DEBUG CHARACTER-VIEW (FINAL) =====');
  console.log('  - character definido:', typeof character !== 'undefined');
  console.log('  - character.id:', character ? character.id : 'undefined');
  console.log('  - character.nome:', character ? character.nome : 'undefined');
  console.log('  - poderes definido:', typeof poderes !== 'undefined');
  console.log('  - poderes Ã© array:', Array.isArray(poderes));
  console.log('  - quantidade de poderes:', poderes ? poderes.length : 0);
  console.log('  - poderesPorTipo definido:', typeof poderesPorTipo !== 'undefined');
  console.log('  - tipos disponÃ­veis:', poderesPorTipo ? Object.keys(poderesPorTipo) : 'nenhum');
  
  if (poderes && poderes.length > 0) {
    console.log('  ğŸ“‹ Lista de poderes:');
    poderes.forEach((poder, index) => {
      console.log(`    ${index + 1}. ${poder.nome} (${poder.fonte}) - ${poder.descricao ? poder.descricao.substring(0, 50) + '...' : 'sem descriÃ§Ã£o'}`);
    });
  }
  
  if (typeof debug !== 'undefined') {
    console.log('  ğŸ”§ Debug extra:', debug);
  }
  console.log('===========================================');
%>

<!-- Poderes do Personagem -->
<div class="character-powers-section">
  <div class="character-powers-header">
    <h3 class="character-powers-title">
      <span>âœ¨</span>
      Poderes do Personagem
      <span>âœ¨</span>
    </h3>
    
    <% if (typeof poderes !== 'undefined' && poderes && poderes.length > 0) { %>
      <p class="character-powers-count">
        <%= poderes.length %> <%= poderes.length === 1 ? 'poder ativo' : 'poderes ativos' %>
      </p>
    <% } else { %>
      <p class="character-powers-count">
        Nenhum poder ativo
      </p>
    <% } %>
  </div>

  <!-- Debug Info (apenas em desenvolvimento) -->
  <% if (process.env.NODE_ENV === 'development' || (typeof debug !== 'undefined' && debug)) { %>
    <div class="debug-info" style="background: rgba(255, 255, 0, 0.1); border: 1px solid yellow; padding: 1rem; margin: 1rem 0; border-radius: 8px; font-family: monospace; font-size: 0.8rem;">
      <strong>ğŸ”§ DEBUG INFO:</strong><br>
      - Poderes: <%= typeof poderes %> (<%= poderes ? poderes.length : 0 %> itens)<br>
      - PoderesPorTipo: <%= typeof poderesPorTipo %> (<%= poderesPorTipo ? Object.keys(poderesPorTipo).length : 0 %> tipos)<br>
      - Character ID: <%= character ? character.id : 'undefined' %><br>
      - Classe ID: <%= character ? character.classe_id : 'undefined' %><br>
      - NÃ­vel: <%= character ? character.nivel : 'undefined' %><br>
      <% if (typeof debug !== 'undefined') { %>
        - Debug extra: <%= JSON.stringify(debug) %><br>
      <% } %>
      <% if (poderesPorTipo && Object.keys(poderesPorTipo).length > 0) { %>
        - Fontes encontradas: <%= Object.keys(poderesPorTipo).join(', ') %><br>
      <% } %>
    </div>
  <% } %>

  <!-- CASO 1: TEM PODERES PARA EXIBIR -->
  <% if (typeof poderes !== 'undefined' && poderes && poderes.length > 0) { %>
    
    <!-- Filtros para VisualizaÃ§Ã£o -->
    <div class="powers-quick-filters">
      <div class="quick-filters-title">ğŸ¯ Filtros RÃ¡pidos</div>
      <div class="quick-filters-buttons">
        <button type="button" class="quick-filter-btn active" data-filter="all">
          âœ¨ Todos (<%= poderes.length %>)
        </button>
        
        <!-- Filtros dinÃ¢micos baseados nos tipos existentes -->
        <% if (poderesPorTipo) { %>
          <% Object.entries(poderesPorTipo).forEach(([fonte, lista]) => { %>
            <% if (lista && lista.length > 0) { %>
              <% 
                let sourceIcon = 'ğŸ“';
                let sourceName = fonte;
                switch(fonte) {
                  case 'raca': sourceIcon = 'ğŸ§¬'; sourceName = 'Raciais'; break;
                  case 'classe': sourceIcon = 'âš”ï¸'; sourceName = 'Classe'; break;
                  case 'escolha': sourceIcon = 'âš¡'; sourceName = 'Escolhidos'; break;
                  case 'deus': sourceIcon = 'â­'; sourceName = 'Divinos'; break;
                  default: sourceIcon = 'ğŸ“'; sourceName = fonte.charAt(0).toUpperCase() + fonte.slice(1); break;
                }
              %>
              <button type="button" class="quick-filter-btn" data-filter="<%= fonte %>">
                <%= sourceIcon %> <%= sourceName %> (<%= lista.length %>)
              </button>
            <% } %>
          <% }); %>
        <% } %>
      </div>
    </div>

    <!-- OrganizaÃ§Ã£o por Fonte/Tipo -->
    <% if (poderesPorTipo && Object.keys(poderesPorTipo).length > 0) { %>
      <div class="powers-by-source">
        <% Object.entries(poderesPorTipo).forEach(([fonte, poderesFonte]) => { %>
          <% if (poderesFonte && poderesFonte.length > 0) { %>
            <div class="character-power-type-section" 
                 data-source="<%= fonte %>" 
                 data-type="<%= fonte %>">
              <div class="power-type-header">
                <h4 class="character-power-type-title">
                  <% 
                    let sourceIcon = 'âœ¨';
                    let sourceName = fonte;
                    switch(fonte) {
                      case 'raca': 
                        sourceIcon = 'ğŸ§¬'; 
                        sourceName = 'Poderes Raciais'; 
                        break;
                      case 'classe': 
                        sourceIcon = 'âš”ï¸'; 
                        sourceName = 'Poderes de Classe'; 
                        break;
                      case 'escolha': 
                        sourceIcon = 'âš¡'; 
                        sourceName = 'Poderes Escolhidos'; 
                        break;
                      case 'deus': 
                        sourceIcon = 'â­'; 
                        sourceName = 'Poderes Divinos'; 
                        break;
                      default:
                        sourceIcon = 'ğŸ“'; 
                        sourceName = 'Outros Poderes'; 
                        break;
                    }
                  %>
                  <span><%= sourceIcon %></span>
                  <%= sourceName %>
                </h4>
                <div class="power-type-count">
                  (<%= poderesFonte.length %> <%= poderesFonte.length === 1 ? 'poder' : 'poderes' %>)
                </div>
                <button type="button" class="power-type-toggle" data-target="<%= fonte %>">
                  <span class="toggle-icon">ğŸ“‚</span>
                </button>
              </div>
              
              <div class="powers-list" id="powersGrid-<%= fonte %>">
                <% poderesFonte.forEach(poder => { %>
                  <div class="character-power-card" 
                       data-source="<%= poder.fonte || fonte %>" 
                       data-type="<%= poder.tipo || 'geral' %>">
                    
                    <div class="character-power-header">
                      <h5 class="character-power-name">
                        <%= getPowerIcon(poder, poder.fonte || fonte) %> <%= poder.nome %>
                      </h5>
                      
                      <span class="character-power-source-badge">
                        <%= sourceIcon %> <%= sourceName.replace('Poderes ', '') %>
                      </span>
                    </div>
                    
                    <div class="character-power-description">
                      <%= poder.descricao || 'DescriÃ§Ã£o nÃ£o disponÃ­vel' %>
                    </div>
                    
                    <% if (poder.pre_requisitos || poder.custo_pm || poder.efeito_especial || poder.observacoes || poder.nivel_minimo || poder.alcance || poder.duracao) { %>
                      <div class="character-power-details">
                        <% if (poder.nivel_minimo) { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">ğŸ“Š NÃ­vel MÃ­nimo</div>
                            <p class="character-power-detail-value">NÃ­vel <%= poder.nivel_minimo %>+</p>
                          </div>
                        <% } %>
                        
                        <% if (poder.pre_requisitos) { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">ğŸ“‹ PrÃ©-requisitos</div>
                            <p class="character-power-detail-value"><%= poder.pre_requisitos %></p>
                          </div>
                        <% } %>
                        
                        <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">ğŸ’™ Custo</div>
                            <p class="character-power-detail-value"><%= poder.custo_pm %> PM</p>
                          </div>
                        <% } %>
                        
                        <% if (poder.alcance && poder.alcance !== 'Pessoal') { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">ğŸ¯ Alcance</div>
                            <p class="character-power-detail-value"><%= poder.alcance %></p>
                          </div>
                        <% } %>
                        
                        <% if (poder.duracao && poder.duracao !== 'InstantÃ¢neo') { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">â±ï¸ DuraÃ§Ã£o</div>
                            <p class="character-power-detail-value"><%= poder.duracao %></p>
                          </div>
                        <% } %>
                        
                        <% if (poder.efeito_especial) { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">âš¡ Efeito Especial</div>
                            <p class="character-power-detail-value"><%= poder.efeito_especial %></p>
                          </div>
                        <% } %>
                        
                        <% if (poder.observacoes) { %>
                          <div class="character-power-detail">
                            <div class="character-power-detail-label">ğŸ“ ObservaÃ§Ãµes</div>
                            <p class="character-power-detail-value"><%= poder.observacoes %></p>
                          </div>
                        <% } %>
                      </div>
                    <% } %>
                    
                    <!-- Tags informativos -->
                    <div class="power-tags" style="margin-top: 1rem;">
                      <span class="power-tag">
                        <%= sourceName.replace('Poderes ', '') %>
                      </span>
                      
                      <% if (poder.tipo && poder.tipo !== 'geral') { %>
                        <span class="power-tag" style="background: rgba(37, 40, 80, 0.6);">
                          <%= poder.tipo.charAt(0).toUpperCase() + poder.tipo.slice(1) %>
                        </span>
                      <% } %>
                      
                      <% if (poder.nivel_minimo) { %>
                        <span class="power-tag" style="background: rgba(255, 140, 0, 0.2); color: var(--warning-orange); border-color: var(--warning-orange);">
                          NÃ­vel <%= poder.nivel_minimo %>+
                        </span>
                      <% } %>
                      
                      <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                        <span class="power-tag cost">
                          <%= poder.custo_pm %> PM
                        </span>
                      <% } %>
                      
                      <% if (poder.pre_requisitos) { %>
                        <span class="power-tag requirement">
                          PrÃ©-requisitos
                        </span>
                      <% } %>
                      
                      <% if (poder.alcance && poder.alcance !== 'Pessoal') { %>
                        <span class="power-tag">
                          ğŸ¯ <%= poder.alcance %>
                        </span>
                      <% } %>

                      <% if (poder.created_at) { %>
                        <span class="power-tag" style="font-size: 0.7rem; opacity: 0.7;">
                          <%= new Date(poder.created_at).toLocaleDateString('pt-BR') %>
                        </span>
                      <% } %>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          <% } %>
        <% }); %>
      </div>
    <% } else { %>
      <!-- Lista simples (fallback se nÃ£o hÃ¡ organizaÃ§Ã£o por tipo) -->
      <div class="powers-list">
        <% poderes.forEach(poder => { %>
          <div class="character-power-card" 
               data-source="<%= poder.fonte %>" 
               data-type="<%= poder.tipo || 'geral' %>">
            
            <div class="character-power-header">
              <h5 class="character-power-name">
                <%= getPowerIcon(poder, poder.fonte || poder.tipo) %> <%= poder.nome %>
              </h5>
              
              <span class="character-power-source-badge">
                <% 
                  let sourceIcon = 'ğŸ“';
                  let sourceText = poder.fonte || 'geral';
                  switch(poder.fonte) {
                    case 'raca': sourceIcon = 'ğŸ§¬'; sourceText = 'Racial'; break;
                    case 'classe': sourceIcon = 'âš”ï¸'; sourceText = 'Classe'; break;
                    case 'escolha': sourceIcon = 'âš¡'; sourceText = 'Escolhido'; break;
                    case 'deus': sourceIcon = 'â­'; sourceText = 'Divino'; break;
                    default: sourceIcon = 'ğŸ“'; sourceText = 'Outro'; break;
                  }
                %>
                <%= sourceIcon %> <%= sourceText %>
              </span>
            </div>
            
            <div class="character-power-description">
              <%= poder.descricao || 'DescriÃ§Ã£o nÃ£o disponÃ­vel' %>
            </div>
            
            <% if (poder.observacoes || poder.nivel_minimo || poder.custo_pm) { %>
              <div class="character-power-details">
                <% if (poder.nivel_minimo) { %>
                  <div class="character-power-detail">
                    <div class="character-power-detail-label">ğŸ“Š NÃ­vel MÃ­nimo</div>
                    <p class="character-power-detail-value">NÃ­vel <%= poder.nivel_minimo %>+</p>
                  </div>
                <% } %>
                
                <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                  <div class="character-power-detail">
                    <div class="character-power-detail-label">ğŸ’™ Custo</div>
                    <p class="character-power-detail-value"><%= poder.custo_pm %> PM</p>
                  </div>
                <% } %>
                
                <% if (poder.observacoes) { %>
                  <div class="character-power-detail">
                    <div class="character-power-detail-label">ğŸ“ ObservaÃ§Ãµes</div>
                    <p class="character-power-detail-value"><%= poder.observacoes %></p>
                  </div>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
    <% } %>
    
    <!-- Resumo dos Poderes -->
    <div class="powers-summary" style="margin-top: 2rem; padding: 1.5rem; background: rgba(212, 175, 55, 0.1); border: 2px solid var(--accent-gold); border-radius: 12px;">
      <h4 style="color: var(--accent-gold); margin-bottom: 1rem; text-align: center;">
        ğŸ“Š Resumo dos Poderes
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <% 
          // Contar poderes por fonte
          const poderesPorFonte = {};
          if (poderes && poderes.length > 0) {
            poderes.forEach(poder => {
              const fonte = poder.fonte || 'geral';
              if (!poderesPorFonte[fonte]) {
                poderesPorFonte[fonte] = 0;
              }
              poderesPorFonte[fonte]++;
            });
          }
        %>
        
        <div class="summary-item" style="text-align: center; background: rgba(37, 40, 80, 0.6); padding: 1rem; border-radius: 8px;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“Š</div>
          <div style="color: var(--accent-gold); font-weight: bold; font-size: 1.8rem;"><%= poderes.length %></div>
          <div style="color: var(--text-muted); font-size: 0.9rem;">Total de Poderes</div>
        </div>
        
        <% if (Object.keys(poderesPorFonte).length > 0) { %>
          <% Object.entries(poderesPorFonte).forEach(([fonte, count]) => { %>
            <div class="summary-item" style="text-align: center; background: rgba(37, 40, 80, 0.6); padding: 1rem; border-radius: 8px;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                <% 
                  let sourceIcon = 'ğŸ“';
                  let sourceName = fonte;
                  switch(fonte) {
                    case 'raca': sourceIcon = 'ğŸ§¬'; sourceName = 'Raciais'; break;
                    case 'classe': sourceIcon = 'âš”ï¸'; sourceName = 'de Classe'; break;
                    case 'escolha': sourceIcon = 'âš¡'; sourceName = 'Escolhidos'; break;
                    case 'deus': sourceIcon = 'â­'; sourceName = 'Divinos'; break;
                  }
                %>
                <%= sourceIcon %>
              </div>
              <div style="color: var(--accent-gold); font-weight: bold; font-size: 1.8rem;"><%= count %></div>
              <div style="color: var(--text-muted); font-size: 0.9rem;"><%= sourceName %></div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>

  <!-- CASO 2: SEM PODERES -->
  <% } else { %>
    <div class="powers-empty-state">
      <div class="powers-empty-icon">ğŸ“œ</div>
      <h4 class="powers-empty-title">Nenhum Poder Ativo</h4>
      <p class="powers-empty-description">
        Este personagem ainda nÃ£o possui poderes especiais.
        <br>
        <% if (character && character.classe_nome) { %>
          <strong>Classe:</strong> <%= character.classe_nome %> - <strong>NÃ­vel:</strong> <%= character.nivel || 1 %>
          <br>
        <% } %>
        <strong>ğŸ’¡ Dica:</strong> Use a ediÃ§Ã£o para selecionar poderes de classe e outros poderes.
        <br>
        <a href="/personagens/<%= character.id %>/editar" style="color: var(--accent-gold); text-decoration: none;">
          âœï¸ Editar personagem para adicionar poderes
        </a>
      </p>

      <!-- AÃ§Ãµes rÃ¡pidas -->
      <div style="margin-top: 1rem;">
        <a href="/personagens/<%= character.id %>/editar" class="btn btn-secondary">
          âœï¸ Adicionar Poderes
        </a>
      </div>
    </div>
  <% } %>
</div>

<!-- Magias do Personagem (SUBSTITUIR a seÃ§Ã£o de magias existente em character-view.ejs) -->
<% if (magias && magias.length > 0) { %>
  <div class="character-spells-section">
    <div class="section-header">
      <h3>
        <span>ğŸ”®</span>
        Magias Conhecidas
        <span class="spells-count">(<%= magias.length %> <%= magias.length === 1 ? 'magia' : 'magias' %>)</span>
      </h3>
      
      <!-- Filtros para magias -->
      <div class="spells-filters">
        <button type="button" class="quick-filter-btn active" data-filter="all">
          âœ¨ Todas
        </button>
        <button type="button" class="quick-filter-btn" data-filter="arcana">
          ğŸ”® Arcana
        </button>
        <button type="button" class="quick-filter-btn" data-filter="divina">
          âœ¨ Divina
        </button>
        <button type="button" class="quick-filter-btn" data-filter="universal">
          ğŸŒŸ Universal
        </button>
      </div>
    </div>

    <!-- InformaÃ§Ãµes da Classe MÃ¡gica -->
    <div class="spellcaster-info">
      <div class="spellcaster-card">
        <h4>ğŸ“Š InformaÃ§Ãµes do Conjurador</h4>
        <div class="spellcaster-stats">
          <div class="spellcaster-stat">
            <span class="stat-icon">âš”ï¸</span>
            <span class="stat-label">Classe:</span>
            <span class="stat-value"><%= character.classe_nome || 'N/A' %></span>
          </div>
          <div class="spellcaster-stat">
            <span class="stat-icon">ğŸ“Š</span>
            <span class="stat-label">NÃ­vel:</span>
            <span class="stat-value"><%= character.nivel || 1 %></span>
          </div>
          <div class="spellcaster-stat">
            <span class="stat-icon">ğŸ’™</span>
            <span class="stat-label">PM DisponÃ­veis:</span>
            <span class="stat-value"><%= character.pontos_mana || 0 %></span>
          </div>
          <div class="spellcaster-stat">
            <span class="stat-icon">ğŸ”˜</span>
            <span class="stat-label">CÃ­rculos AcessÃ­veis:</span>
            <span class="stat-value">
              <% 
                const classe = character.classe_nome ? character.classe_nome.toLowerCase() : '';
                const nivel = character.nivel || 1;
                let maxCircle = 1;
                
                if (classe === 'arcanista' || classe === 'clÃ©rigo') {
                  if (nivel >= 17) maxCircle = 5;
                  else if (nivel >= 13) maxCircle = 4;
                  else if (nivel >= 9) maxCircle = 3;
                  else if (nivel >= 5) maxCircle = 2;
                  else maxCircle = 1;
                } else if (classe === 'bardo' || classe === 'druida') {
                  if (nivel >= 14) maxCircle = 4;
                  else if (nivel >= 10) maxCircle = 3;
                  else if (nivel >= 6) maxCircle = 2;
                  else maxCircle = 1;
                }
              %>
              1Âº ao <%= maxCircle %>Âº
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Container das Magias por CÃ­rculo -->
    <div class="spells-circles-container">
      <% Object.entries(magiasPorCirculo).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([circulo, magiasCirculo]) => { %>
        <% if (magiasCirculo && magiasCirculo.length > 0) { %>
          <div class="spell-circle-section" data-circle="<%= circulo %>">
            <div class="spell-circle-header">
              <h4 class="spell-circle-title">
                <span>ğŸ”˜</span>
                <%= circulo %>Âº CÃ­rculo
              </h4>
              <div class="spell-circle-count">(<%= magiasCirculo.length %> <%= magiasCirculo.length === 1 ? 'magia' : 'magias' %>)</div>
              <button type="button" class="spell-circle-toggle" data-target="<%= circulo %>">
                <span class="toggle-icon">ğŸ“‚</span>
              </button>
            </div>

            <div class="spells-grid" id="spellsGrid-<%= circulo %>">
              <% magiasCirculo.forEach(magia => { %>
                <div class="character-spell-card" 
                     data-spell-id="<%= magia.id %>" 
                     data-type="<%= magia.tipo.toLowerCase() %>"
                     data-circle="<%= circulo %>"
                     data-school="<%= magia.escola.toLowerCase() %>">
                  
                  <div class="spell-card-header">
                    <div class="spell-icon-container">
                      <% 
                        let spellIcon = 'âœ¨';
                        const nome = (magia.nome || '').toLowerCase();
                        
                        // Ãcones especÃ­ficos por nome e tipo
                        if (nome.includes('cura') || nome.includes('curar') || nome.includes('restaurar')) spellIcon = 'ğŸ’š';
                        else if (nome.includes('fogo') || nome.includes('chama') || nome.includes('incendiar')) spellIcon = 'ğŸ”¥';
                        else if (nome.includes('gelo') || nome.includes('frio') || nome.includes('congelar')) spellIcon = 'â„ï¸';
                        else if (nome.includes('raio') || nome.includes('relÃ¢mpago') || nome.includes('elÃ©trico')) spellIcon = 'âš¡';
                        else if (nome.includes('luz') || nome.includes('brilho') || nome.includes('clarÃ£o')) spellIcon = 'â˜€ï¸';
                        else if (nome.includes('trevas') || nome.includes('sombra') || nome.includes('escuridÃ£o')) spellIcon = 'ğŸŒ‘';
                        else if (nome.includes('proteÃ§Ã£o') || nome.includes('escudo') || nome.includes('barreira')) spellIcon = 'ğŸ›¡ï¸';
                        else if (nome.includes('ilusÃ£o') || nome.includes('invisibilidade') || nome.includes('disfarce')) spellIcon = 'ğŸ‘»';
                        else if (nome.includes('voo') || nome.includes('voar') || nome.includes('levitar')) spellIcon = 'ğŸ¦…';
                        else if (nome.includes('teleporte') || nome.includes('portal') || nome.includes('dimensÃ£o')) spellIcon = 'ğŸŒ€';
                        else if (nome.includes('invocaÃ§Ã£o') || nome.includes('convocar') || nome.includes('conjurar')) spellIcon = 'ğŸ‘¤';
                        else if (nome.includes('detecÃ§Ã£o') || nome.includes('detectar') || nome.includes('sentir')) spellIcon = 'ğŸ‘ï¸';
                        else if (nome.includes('transformaÃ§Ã£o') || nome.includes('forma') || nome.includes('metamorfose')) spellIcon = 'ğŸ”„';
                        else if (nome.includes('explosÃ£o') || nome.includes('Ã¡rea') || nome.includes('rajada')) spellIcon = 'ğŸ’¥';
                        else if (nome.includes('mÃ­ssil') || nome.includes('projÃ©til') || nome.includes('dardo')) spellIcon = 'ğŸ¯';
                        else if (nome.includes('sono') || nome.includes('dormir') || nome.includes('adormecer')) spellIcon = 'ğŸ˜´';
                        else if (nome.includes('medo') || nome.includes('terror') || nome.includes('pÃ¢nico')) spellIcon = 'ğŸ˜±';
                        else if (nome.includes('charme') || nome.includes('seduÃ§Ã£o') || nome.includes('fascinar')) spellIcon = 'ğŸ˜';
                        else if (nome.includes('forÃ§a') || nome.includes('potÃªncia') || nome.includes('poder')) spellIcon = 'ğŸ’ª';
                        else if (nome.includes('velocidade') || nome.includes('pressa') || nome.includes('rapidez')) spellIcon = 'ğŸ’¨';
                        else if (nome.includes('Ã¡gua') || nome.includes('aquÃ¡tico') || nome.includes('maremoto')) spellIcon = 'ğŸ’§';
                        else if (nome.includes('terra') || nome.includes('pedra') || nome.includes('rocha')) spellIcon = 'ğŸŒ';
                        else if (nome.includes('vento') || nome.includes('ar') || nome.includes('brisa')) spellIcon = 'ğŸ’¨';
                        else if (nome.includes('Ã¡cido') || nome.includes('corrosÃ£o') || nome.includes('dissolver')) spellIcon = 'ğŸ§ª';
                        else if (nome.includes('veneno') || nome.includes('tÃ³xico') || nome.includes('envenenar')) spellIcon = 'â˜£ï¸';
                        else if (nome.includes('maldiÃ§Ã£o') || nome.includes('amaldiÃ§oar') || nome.includes('azarar')) spellIcon = 'ğŸ–¤';
                        else if (nome.includes('bÃªnÃ§Ã£o') || nome.includes('abenÃ§oar') || nome.includes('sagrar')) spellIcon = 'ğŸ™';
                        else if (nome.includes('comunicaÃ§Ã£o') || nome.includes('falar') || nome.includes('lÃ­nguas')) spellIcon = 'ğŸ’¬';
                        else if (nome.includes('reparar') || nome.includes('consertar') || nome.includes('restaurar')) spellIcon = 'ğŸ”§';
                        else if (nome.includes('criar') || nome.includes('criaÃ§Ã£o') || nome.includes('fabricar')) spellIcon = 'ğŸ¨';
                        else if (nome.includes('destruir') || nome.includes('destruiÃ§Ã£o') || nome.includes('aniquilar')) spellIcon = 'ğŸ’€';
                        else if (nome.includes('tempo') || nome.includes('temporal') || nome.includes('cronologia')) spellIcon = 'â°';
                        else if (nome.includes('espaÃ§o') || nome.includes('espacial') || nome.includes('dimensional')) spellIcon = 'ğŸŒŒ';
                        else if (nome.includes('moral') || nome.includes('espÃ­rito') || nome.includes('Ã¢nimo')) spellIcon = 'ğŸ’«';
                        else if (nome.includes('resistÃªncia') || nome.includes('tolerÃ¢ncia') || nome.includes('imunidade')) spellIcon = 'ğŸ›¡ï¸';
                        else if (magia.tipo === 'Divina') spellIcon = 'âœ¨';
                        else if (magia.tipo === 'Arcana') spellIcon = 'ğŸ”®';
                        else if (magia.tipo === 'Universal') spellIcon = 'ğŸŒŸ';
                      %>
                      <div class="spell-icon"><%= spellIcon %></div>
                      
                      <!-- Status Indicators -->
                      <div class="spell-status-indicators">
                        <% if (magia.fonte === 'classe') { %>
                          <span class="spell-status-badge class" title="Magia de Classe">âš”ï¸</span>
                        <% } else { %>
                          <span class="spell-status-badge chosen" title="Magia Escolhida">âš¡</span>
                        <% } %>
                        
                        <% if (magia.custo_pm && magia.custo_pm > 0) { %>
                          <span class="spell-status-badge cost" title="<%= magia.custo_pm %> PM">ğŸ’™</span>
                        <% } %>
                        
                        <span class="spell-status-badge circle" title="<%= circulo %>Âº CÃ­rculo">ğŸ”˜</span>
                      </div>
                    </div>

                    <div class="spell-info">
                      <h5 class="spell-name"><%= magia.nome %></h5>
                      <p class="spell-school-type">
                        <%= magia.escola %> â€¢ <%= magia.tipo %>
                      </p>
                    </div>

                    <div class="spell-cost-info">
                      <% if (magia.custo_pm && magia.custo_pm > 0) { %>
                        <div class="spell-cost <%= magia.custo_pm > (character.pontos_mana || 0) ? 'insufficient' : 'available' %>">
                          <div class="cost-value"><%= magia.custo_pm %></div>
                          <small class="cost-label">PM</small>
                        </div>
                      <% } else { %>
                        <div class="spell-cost free">
                          <div class="cost-value">0</div>
                          <small class="cost-label">PM</small>
                        </div>
                      <% } %>
                    </div>
                  </div>

                  <div class="spell-card-content">
                    <p class="spell-description"><%= magia.descricao %></p>

                    <!-- Detalhes da Magia -->
                    <div class="spell-mechanics">
                      <% if (magia.execucao) { %>
                        <div class="spell-mechanic">
                          <span class="mechanic-icon">â°</span>
                          <span class="mechanic-label">ExecuÃ§Ã£o:</span>
                          <span class="mechanic-value"><%= magia.execucao %></span>
                        </div>
                      <% } %>
                      
                      <% if (magia.alcance) { %>
                        <div class="spell-mechanic">
                          <span class="mechanic-icon">ğŸ¯</span>
                          <span class="mechanic-label">Alcance:</span>
                          <span class="mechanic-value"><%= magia.alcance %></span>
                        </div>
                      <% } %>
                      
                      <% if (magia.duracao) { %>
                        <div class="spell-mechanic">
                          <span class="mechanic-icon">â±ï¸</span>
                          <span class="mechanic-label">DuraÃ§Ã£o:</span>
                          <span class="mechanic-value"><%= magia.duracao %></span>
                        </div>
                      <% } %>
                    </div>

                    <!-- Tags da Magia -->
                    <div class="spell-tags">
                      <span class="spell-tag circle"><%= circulo %>Âº CÃ­rculo</span>
                      <span class="spell-tag type <%= magia.tipo.toLowerCase() %>">
                        <%= magia.tipo %>
                      </span>
                      <span class="spell-tag school"><%= magia.escola %></span>
                      
                      <% if (magia.fonte === 'classe') { %>
                        <span class="spell-tag source-class">Classe</span>
                      <% } else { %>
                        <span class="spell-tag source-choice">Escolhida</span>
                      <% } %>
                      
                      <% if (magia.custo_pm && magia.custo_pm > 0) { %>
                        <span class="spell-tag cost">
                          <%= magia.custo_pm %> PM
                        </span>
                      <% } else { %>
                        <span class="spell-tag free">Gratuita</span>
                      <% } %>
                    </div>

                    <!-- Origem da Magia -->
                    <% if (magia.observacoes) { %>
                      <div class="spell-origin">
                        <small><strong>Origem:</strong> <%= magia.observacoes %></small>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% } %>
      <% }); %>
    </div>

    <!-- Resumo das Magias -->
    <div class="spells-summary">
      <div class="summary-card">
        <h4>ğŸ“Š Resumo das Magias</h4>
        <div class="summary-stats">
          <div class="summary-stat">
            <span class="stat-icon">ğŸ”®</span>
            <span class="stat-label">Total:</span>
            <span class="stat-value"><%= magias.length %></span>
          </div>
          
          <% 
            const magiasArcanas = magias.filter(m => m.tipo === 'Arcana').length;
            const magiasDivinas = magias.filter(m => m.tipo === 'Divina').length;
            const magiasUniversais = magias.filter(m => m.tipo === 'Universal').length;
            const magiasClasse = magias.filter(m => m.fonte === 'classe').length;
            const magiasEscolhidas = magias.filter(m => m.fonte === 'escolha').length;
            const custoTotal = magias.reduce((total, m) => total + (m.custo_pm || 0), 0);
          %>
          
          <% if (magiasArcanas > 0) { %>
            <div class="summary-stat">
              <span class="stat-icon">ğŸ”®</span>
              <span class="stat-label">Arcanas:</span>
              <span class="stat-value"><%= magiasArcanas %></span>
            </div>
          <% } %>
          
          <% if (magiasDivinas > 0) { %>
            <div class="summary-stat">
              <span class="stat-icon">âœ¨</span>
              <span class="stat-label">Divinas:</span>
              <span class="stat-value"><%= magiasDivinas %></span>
            </div>
          <% } %>
          
          <% if (magiasUniversais > 0) { %>
            <div class="summary-stat">
              <span class="stat-icon">ğŸŒŸ</span>
              <span class="stat-label">Universais:</span>
              <span class="stat-value"><%= magiasUniversais %></span>
            </div>
          <% } %>
          
          <div class="summary-stat">
            <span class="stat-icon">âš”ï¸</span>
            <span class="stat-label">De Classe:</span>
            <span class="stat-value"><%= magiasClasse %></span>
          </div>
          
          <div class="summary-stat">
            <span class="stat-icon">âš¡</span>
            <span class="stat-label">Escolhidas:</span>
            <span class="stat-value"><%= magiasEscolhidas %></span>
          </div>
          
          <div class="summary-stat">
            <span class="stat-icon">ğŸ’™</span>
            <span class="stat-label">Custo Total:</span>
            <span class="stat-value"><%= custoTotal %> PM</span>
          </div>
        </div>
      </div>
    </div>
  </div>
<% } else if (character.classe_nome && ['Arcanista', 'Bardo', 'ClÃ©rigo', 'Druida'].includes(character.classe_nome)) { %>
  <!-- Classe mÃ¡gica sem magias -->
  <div class="no-spells-message magical-class">
    <div class="no-spells-icon">ğŸ”®</div>
    <h4>Nenhuma Magia Conhecida</h4>
    <p>
      Este personagem Ã© da classe mÃ¡gica <strong><%= character.classe_nome %></strong> mas ainda nÃ£o possui magias registradas.
      <br>
      <strong>NÃ­vel:</strong> <%= character.nivel || 1 %> â€¢ <strong>PM DisponÃ­veis:</strong> <%= character.pontos_mana || 0 %>
    </p>
    <div class="spell-recommendations">
      <p><strong>ğŸ’¡ Dica:</strong> Use a ediÃ§Ã£o para adicionar magias da sua classe.</p>
      <a href="/personagens/<%= character.id %>/editar" class="btn btn-secondary">
        âœï¸ Adicionar Magias
      </a>
    </div>
  </div>
<% } else { %>
  <!-- Classe nÃ£o-mÃ¡gica -->
  <div class="no-spells-message non-magical-class">
    <div class="no-spells-icon">âš”ï¸</div>
    <h4>Classe NÃ£o-MÃ¡gica</h4>
    <p>
      A classe <strong><%= character.classe_nome || 'do personagem' %></strong> nÃ£o possui acesso a magias.
      <br>
      <strong>Classes MÃ¡gicas disponÃ­veis:</strong> Arcanista, Bardo, ClÃ©rigo, Druida
    </p>
  </div>
<% } %>

    <!-- HistÃ³ria e Personalidade -->
    <% if (character.historia_pessoal || character.personalidade || character.objetivos) { %>
      <div class="background-section">
        <h3>ğŸ“œ HistÃ³ria e Personalidade</h3>
        <div class="background-grid">
          <% if (character.historia_pessoal) { %>
            <div class="background-card">
              <h4>ğŸ“– HistÃ³ria Pessoal</h4>
              <div class="background-content">
                <p><%= character.historia_pessoal %></p>
              </div>
            </div>
          <% } %>
          
          <% if (character.personalidade) { %>
            <div class="background-card">
              <h4>ğŸ­ Personalidade</h4>
              <div class="background-content">
                <p><%= character.personalidade %></p>
              </div>
            </div>
          <% } %>
          
          <% if (character.objetivos) { %>
            <div class="background-card">
              <h4>ğŸ¯ Objetivos e MotivaÃ§Ãµes</h4>
              <div class="background-content">
                <p><%= character.objetivos %></p>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    <% } %>

    <!-- InformaÃ§Ãµes TÃ©cnicas -->
    <div class="technical-info">
      <h3>â„¹ï¸ InformaÃ§Ãµes do Sistema</h3>
      <div class="tech-grid">
        <div class="tech-card">
          <h4>ğŸ“… CriaÃ§Ã£o</h4>
          <p><%= new Date(character.created_at).toLocaleDateString('pt-BR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) %></p>
        </div>
        
        <% if (character.updated_at && character.updated_at !== character.created_at) { %>
          <div class="tech-card">
            <h4>âœï¸ Ãšltima EdiÃ§Ã£o</h4>
            <p><%= new Date(character.updated_at).toLocaleDateString('pt-BR', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) %></p>
          </div>
        <% } %>
        
        <div class="tech-card">
          <h4>ğŸ†” ID do Personagem</h4>
          <p><code>#<%= character.id %></code></p>
        </div>
      </div>
    </div>

    <!-- AÃ§Ãµes Adicionais -->
    <div class="additional-actions">
      <div class="actions-card">
        <h3>ğŸ› ï¸ AÃ§Ãµes DisponÃ­veis</h3>
        <div class="actions-grid">
          <button class="action-btn utility-btn" onclick="window.print()">
            ğŸ–¨ï¸ Imprimir Ficha
          </button>
          
          <button class="action-btn utility-btn" onclick="exportCharacter()">
            ğŸ“¥ Exportar Dados
          </button>
          
          <button class="action-btn utility-btn" onclick="shareCharacter()">
            ğŸ“¤ Compartilhar
          </button>
          
          <button class="action-btn danger-btn" onclick="confirmDelete()">
            ğŸ—‘ï¸ Excluir Personagem
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal de ConfirmaÃ§Ã£o de ExclusÃ£o -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âš ï¸ Confirmar ExclusÃ£o</h3>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir o personagem <strong><%= character.nome %></strong>?</p>
        <p class="warning-text">Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
        <button class="btn btn-danger" onclick="deleteCharacter()">ğŸ—‘ï¸ Excluir Personagem</button>
      </div>
    </div>
  </div>

<% } else { %>
  <!-- Personagem nÃ£o encontrado -->
  <section class="content-section active">
    <div class="error-state">
      <div class="error-card">
        <div class="error-icon">ğŸ˜”</div>
        <h2>Personagem NÃ£o Encontrado</h2>
        <p>O personagem que vocÃª estÃ¡ procurando nÃ£o existe ou vocÃª nÃ£o tem permissÃ£o para visualizÃ¡-lo.</p>
        <div class="error-actions">
          <a href="/personagens" class="nav-btn">ğŸ“‹ Meus Personagens</a>
          <a href="/personagens/criar" class="btn btn-secondary">âœ¨ Criar Novo</a>
        </div>
      </div>
    </div>
  </section>
<% } %>

<!-- Script especÃ­fico para visualizaÃ§Ã£o de personagem -->
<script src="/scripts/character-view.js"></script>

<%- include('../partials/footer') %>