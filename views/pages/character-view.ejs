<%- include('../partials/header', { 
  title: (typeof character !== 'undefined' && character) ? `${character.nome} - Ficha` : 'Personagem - Ficha', 
  activePage: 'characterView' 
}) %>

<% if (typeof character !== 'undefined' && character) { %>
  <section class="content-section active character-sheet">
    <!-- Header do Personagem -->
    <div class="character-header-section">
      <div class="character-main-info">
        <div class="character-portrait">
          <% 
            // Ícone baseado na classe
            let classeIcon = '⚔️';
            if (character.classe_nome) {
              switch(character.classe_nome.toLowerCase()) {
                case 'guerreiro': classeIcon = '⚔️'; break;
                case 'ladino': classeIcon = '🗡️'; break;
                case 'arcanista': classeIcon = '🔮'; break;
                case 'clérico': classeIcon = '✨'; break;
                case 'bárbaro': classeIcon = '🪓'; break;
                case 'bardo': classeIcon = '🎵'; break;
                default: classeIcon = '⚔️';
              }
            }
          %>
          <div class="portrait-icon"><%= classeIcon %></div>
          <div class="level-badge">Nível <%= character.nivel || 1 %></div>
        </div>
        
        <div class="character-identity">
          <h1 class="character-name"><%= character.nome %></h1>
          <p class="character-class-race">
            <%= character.classe_nome || 'Classe' %> <%= character.raca_nome || 'Raça' %>
          </p>
          <% if (character.deus_nome) { %>
            <p class="character-deity">⭐ Devoto de <%= character.deus_nome %></p>
          <% } %>
          <% if (character.experiencia && character.experiencia > 0) { %>
            <p class="character-xp">🌟 <%= character.experiencia %> XP</p>
          <% } %>
        </div>
        
        <div class="character-actions">
          <a href="/personagens/<%= character.id %>/editar" class="action-btn edit-btn">
            ✏️ Editar Personagem
          </a>
          <a href="/personagens" class="action-btn back-btn">
            ← Meus Personagens
          </a>
        </div>
      </div>
    </div>

    <!-- Características Principais -->
    <div class="main-characteristics">
      <div class="characteristic-card vital-stats">
        <h3>💙 Características Vitais</h3>
        <div class="vital-grid">
          <div class="vital-item pv">
            <div class="vital-icon">❤️</div>
            <div class="vital-info">
              <span class="vital-value"><%= character.pontos_vida || 0 %></span>
              <span class="vital-label">Pontos de Vida</span>
            </div>
          </div>
          
          <% if (character.pontos_mana && character.pontos_mana > 0) { %>
            <div class="vital-item pm">
              <div class="vital-icon">🔵</div>
              <div class="vital-info">
                <span class="vital-value"><%= character.pontos_mana %></span>
                <span class="vital-label">Pontos de Mana</span>
              </div>
            </div>
          <% } %>
          
          <div class="vital-item ca">
            <div class="vital-icon">🛡️</div>
            <div class="vital-info">
              <span class="vital-value"><%= character.ca || 10 %></span>
              <span class="vital-label">Classe de Armadura</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Atributos -->
    <div class="attributes-section">
      <h3>💪 Atributos</h3>
      <div class="attributes-grid">
        <div class="attribute-card">
          <div class="attr-icon">💪</div>
          <div class="attr-info">
            <span class="attr-name">Força</span>
            <span class="attr-value"><%= character.forca || 10 %></span>
            <span class="attr-modifier">
              <% 
                const forcaMod = Math.floor(((character.forca || 10) - 10) / 2);
                const forcaModText = forcaMod >= 0 ? '+' + forcaMod : forcaMod;
              %>
              (<%= forcaModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">🏃</div>
          <div class="attr-info">
            <span class="attr-name">Destreza</span>
            <span class="attr-value"><%= character.destreza || 10 %></span>
            <span class="attr-modifier">
              <% 
                const destrezaMod = Math.floor(((character.destreza || 10) - 10) / 2);
                const destrezaModText = destrezaMod >= 0 ? '+' + destrezaMod : destrezaMod;
              %>
              (<%= destrezaModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">❤️‍🔥</div>
          <div class="attr-info">
            <span class="attr-name">Constituição</span>
            <span class="attr-value"><%= character.constituicao || 10 %></span>
            <span class="attr-modifier">
              <% 
                const constMod = Math.floor(((character.constituicao || 10) - 10) / 2);
                const constModText = constMod >= 0 ? '+' + constMod : constMod;
              %>
              (<%= constModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">🧠</div>
          <div class="attr-info">
            <span class="attr-name">Inteligência</span>
            <span class="attr-value"><%= character.inteligencia || 10 %></span>
            <span class="attr-modifier">
              <% 
                const intMod = Math.floor(((character.inteligencia || 10) - 10) / 2);
                const intModText = intMod >= 0 ? '+' + intMod : intMod;
              %>
              (<%= intModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">🧙</div>
          <div class="attr-info">
            <span class="attr-name">Sabedoria</span>
            <span class="attr-value"><%= character.sabedoria || 10 %></span>
            <span class="attr-modifier">
              <% 
                const sabMod = Math.floor(((character.sabedoria || 10) - 10) / 2);
                const sabModText = sabMod >= 0 ? '+' + sabMod : sabMod;
              %>
              (<%= sabModText %>)
            </span>
          </div>
        </div>
        
        <div class="attribute-card">
          <div class="attr-icon">😎</div>
          <div class="attr-info">
            <span class="attr-name">Carisma</span>
            <span class="attr-value"><%= character.carisma || 10 %></span>
            <span class="attr-modifier">
              <% 
                const carMod = Math.floor(((character.carisma || 10) - 10) / 2);
                const carModText = carMod >= 0 ? '+' + carMod : carMod;
              %>
              (<%= carModText %>)
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Poderes -->
    <!-- Seção de Poderes Melhorada para Character View -->
<% if (typeof poderes !== 'undefined' && poderes && poderes.length > 0) { %>
  <div class="character-powers-section">
    <div class="character-powers-header">
      <h3 class="character-powers-title">
        <span>✨</span>
        Poderes do Personagem
        <span>✨</span>
      </h3>
      <p class="character-powers-count">
        <%= poderes.length %> <%= poderes.length === 1 ? 'poder ativo' : 'poderes ativos' %>
      </p>
    </div>
    
    <!-- Filtros para Visualização -->
    <div class="powers-quick-filters" style="margin-bottom: 2rem;">
      <div class="quick-filters-title">🎯 Filtrar por Fonte</div>
      <div class="quick-filters-buttons">
        <button type="button" class="quick-filter-btn active" data-filter="all">
          ✨ Todos
        </button>
        <button type="button" class="quick-filter-btn" data-filter="raca">
          🧬 Raciais
        </button>
        <button type="button" class="quick-filter-btn" data-filter="escolha">
          ⚡ Escolhidos
        </button>
        <button type="button" class="quick-filter-btn" data-filter="classe">
          ⚔️ Classe
        </button>
        <button type="button" class="quick-filter-btn" data-filter="deus">
          ⭐ Divinos
        </button>
      </div>
    </div>
    
    <% if (typeof poderesPorTipo !== 'undefined' && poderesPorTipo && Object.keys(poderesPorTipo).length > 0) { %>
      <!-- Organização por Tipo -->
      <div class="powers-by-type">
        <% Object.entries(poderesPorTipo).forEach(([tipo, poderesTipo]) => { %>
          <div class="character-power-type-section" data-type="<%= tipo %>">
            <div class="power-type-header">
              <h4 class="character-power-type-title">
                <% 
                  let tipoIcon = '✨';
                  let tipoNome = tipo;
                  switch(tipo) {
                    case 'racial': tipoIcon = '🧬'; tipoNome = 'Poderes Raciais'; break;
                    case 'geral': tipoIcon = '⚡'; tipoNome = 'Poderes Gerais'; break;
                    case 'combate': tipoIcon = '⚔️'; tipoNome = 'Poderes de Combate'; break;
                    case 'destino': tipoIcon = '🌟'; tipoNome = 'Poderes de Destino'; break;
                    case 'magia': tipoIcon = '🔮'; tipoNome = 'Poderes de Magia'; break;
                    case 'concedido': tipoIcon = '⭐'; tipoNome = 'Poderes Concedidos'; break;
                    case 'tormenta': tipoIcon = '💀'; tipoNome = 'Poderes da Tormenta'; break;
                  }
                %>
                <span><%= tipoIcon %></span>
                <%= tipoNome %>
              </h4>
              <div class="power-type-count">
                (<%= poderesTipo.length %> <%= poderesTipo.length === 1 ? 'poder' : 'poderes' %>)
              </div>
              <button type="button" class="power-type-toggle" data-target="<%= tipo %>">
                <span class="toggle-icon">📂</span>
              </button>
            </div>
            
            <div class="powers-list" id="powersGrid-<%= tipo %>">
              <% poderesTipo.forEach(poder => { %>
                <div class="character-power-card" 
                     data-source="<%= poder.fonte %>" 
                     data-type="<%= poder.tipo %>">
                  
                  <div class="character-power-header">
                    <h5 class="character-power-name">
                      <% 
                        // Ícone baseado no tipo ou nome do poder
                        let poderIcon = '✨';
                        if (poder.tipo === 'combate' || poder.nome.toLowerCase().includes('ataque')) poderIcon = '⚔️';
                        else if (poder.tipo === 'magia' || poder.nome.toLowerCase().includes('magia')) poderIcon = '🔮';
                        else if (poder.tipo === 'destino') poderIcon = '🌟';
                        else if (poder.tipo === 'racial') poderIcon = '🧬';
                        else if (poder.nome.toLowerCase().includes('defesa') || poder.nome.toLowerCase().includes('armadura')) poderIcon = '🛡️';
                        else if (poder.nome.toLowerCase().includes('movimento') || poder.nome.toLowerCase().includes('voo')) poderIcon = '🏃';
                        else if (poder.nome.toLowerCase().includes('cura') || poder.nome.toLowerCase().includes('vida')) poderIcon = '💚';
                        else if (poder.tipo === 'geral') poderIcon = '⚡';
                      %>
                      <%= poderIcon %> <%= poder.nome %>
                    </h5>
                    
                    <span class="character-power-source-badge">
                      <% 
                        let sourceIcon = '📝';
                        let sourceText = poder.fonte;
                        switch(poder.fonte) {
                          case 'raca': sourceIcon = '🧬'; sourceText = 'Racial'; break;
                          case 'escolha': sourceIcon = '⚡'; sourceText = 'Escolhido'; break;
                          case 'classe': sourceIcon = '⚔️'; sourceText = 'Classe'; break;
                          case 'deus': sourceIcon = '⭐'; sourceText = 'Divino'; break;
                        }
                      %>
                      <%= sourceIcon %> <%= sourceText %>
                    </span>
                  </div>
                  
                  <div class="character-power-description">
                    <%= poder.descricao %>
                  </div>
                  
                  <% if (poder.pre_requisitos || poder.custo_pm || poder.efeito_especial || poder.observacoes) { %>
                    <div class="character-power-details">
                      <% if (poder.pre_requisitos) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">📋 Pré-requisitos</div>
                          <p class="character-power-detail-value"><%= poder.pre_requisitos %></p>
                        </div>
                      <% } %>
                      
                      <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">💙 Custo</div>
                          <p class="character-power-detail-value"><%= poder.custo_pm %> PM</p>
                        </div>
                      <% } %>
                      
                      <% if (poder.alcance && poder.alcance !== 'Pessoal') { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">🎯 Alcance</div>
                          <p class="character-power-detail-value"><%= poder.alcance %></p>
                        </div>
                      <% } %>
                      
                      <% if (poder.duracao && poder.duracao !== 'Instantâneo') { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">⏱️ Duração</div>
                          <p class="character-power-detail-value"><%= poder.duracao %></p>
                        </div>
                      <% } %>
                      
                      <% if (poder.efeito_especial) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">⚡ Efeito Especial</div>
                          <p class="character-power-detail-value"><%= poder.efeito_especial %></p>
                        </div>
                      <% } %>
                      
                      <% if (poder.observacoes) { %>
                        <div class="character-power-detail">
                          <div class="character-power-detail-label">📝 Observações</div>
                          <p class="character-power-detail-value"><%= poder.observacoes %></p>
                        </div>
                      <% } %>
                    </div>
                  <% } %>
                  
                  <!-- Tags informativos -->
                  <div class="power-tags" style="margin-top: 1rem;">
                    <span class="power-tag">
                      <%= tipoNome.replace('Poderes ', '') %>
                    </span>
                    
                    <span class="power-tag" style="background: rgba(37, 40, 80, 0.6);">
                      <%= sourceText %>
                    </span>
                    
                    <% if (poder.custo_pm && poder.custo_pm > 0) { %>
                      <span class="power-tag cost">
                        <%= poder.custo_pm %> PM
                      </span>
                    <% } %>
                    
                    <% if (poder.pre_requisitos) { %>
                      <span class="power-tag requirement">
                        Pré-requisitos
                      </span>
                    <% } %>
                    
                    <% if (poder.alcance && poder.alcance !== 'Pessoal') { %>
                      <span class="power-tag">
                        🎯 <%= poder.alcance %>
                      </span>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } else { %>
      <!-- Lista simples caso não tenha agrupamento por tipo -->
      <div class="powers-list">
        <% poderes.forEach(poder => { %>
          <div class="character-power-card" 
               data-source="<%= poder.fonte %>" 
               data-type="<%= poder.tipo || 'geral' %>">
            
            <div class="character-power-header">
              <h5 class="character-power-name">
                <% 
                  // Ícone baseado na fonte
                  let poderIcon = '✨';
                  switch(poder.fonte) {
                    case 'raca': poderIcon = '🧬'; break;
                    case 'escolha': poderIcon = '⚡'; break;
                    case 'classe': poderIcon = '⚔️'; break;
                    case 'deus': poderIcon = '⭐'; break;
                  }
                %>
                <%= poderIcon %> <%= poder.nome %>
              </h5>
              
              <span class="character-power-source-badge">
                <% 
                  let sourceIcon = '📝';
                  let sourceText = poder.fonte;
                  switch(poder.fonte) {
                    case 'raca': sourceIcon = '🧬'; sourceText = 'Racial'; break;
                    case 'escolha': sourceIcon = '⚡'; sourceText = 'Escolhido'; break;
                    case 'classe': sourceIcon = '⚔️'; sourceText = 'Classe'; break;
                    case 'deus': sourceIcon = '⭐'; sourceText = 'Divino'; break;
                  }
                %>
                <%= sourceIcon %> <%= sourceText %>
              </span>
            </div>
            
            <div class="character-power-description">
              <%= poder.descricao %>
            </div>
            
            <% if (poder.observacoes) { %>
              <div class="character-power-details">
                <div class="character-power-detail">
                  <div class="character-power-detail-label">📝 Observações</div>
                  <p class="character-power-detail-value"><%= poder.observacoes %></p>
                </div>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
    <% } %>
    
    <!-- Resumo dos Poderes -->
    <div class="powers-summary" style="margin-top: 2rem; padding: 1.5rem; background: rgba(212, 175, 55, 0.1); border: 2px solid var(--accent-gold); border-radius: 12px;">
      <h4 style="color: var(--accent-gold); margin-bottom: 1rem; text-align: center;">
        📊 Resumo dos Poderes
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <% 
          // Contar poderes por fonte
          const poderesPorFonte = {};
          poderes.forEach(poder => {
            if (!poderesPorFonte[poder.fonte]) {
              poderesPorFonte[poder.fonte] = 0;
            }
            poderesPorFonte[poder.fonte]++;
          });
          
          // Contar poderes por tipo (se disponível)
          const poderesPorTipoCount = {};
          poderes.forEach(poder => {
            const tipo = poder.tipo || 'geral';
            if (!poderesPorTipoCount[tipo]) {
              poderesPorTipoCount[tipo] = 0;
            }
            poderesPorTipoCount[tipo]++;
          });
        %>
        
        <div class="summary-item" style="text-align: center; background: rgba(37, 40, 80, 0.6); padding: 1rem; border-radius: 8px;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
          <div style="color: var(--accent-gold); font-weight: bold; font-size: 1.8rem;"><%= poderes.length %></div>
          <div style="color: var(--text-muted); font-size: 0.9rem;">Total de Poderes</div>
        </div>
        
        <% Object.entries(poderesPorFonte).forEach(([fonte, count]) => { %>
          <div class="summary-item" style="text-align: center; background: rgba(37, 40, 80, 0.6); padding: 1rem; border-radius: 8px;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">
              <% 
                let sourceIcon = '📝';
                let sourceName = fonte;
                switch(fonte) {
                  case 'raca': sourceIcon = '🧬'; sourceName = 'Raciais'; break;
                  case 'escolha': sourceIcon = '⚡'; sourceName = 'Escolhidos'; break;
                  case 'classe': sourceIcon = '⚔️'; sourceName = 'de Classe'; break;
                  case 'deus': sourceIcon = '⭐'; sourceName = 'Divinos'; break;
                }
              %>
              <%= sourceIcon %>
            </div>
            <div style="color: var(--accent-gold); font-weight: bold; font-size: 1.8rem;"><%= count %></div>
            <div style="color: var(--text-muted); font-size: 0.9rem;"><%= sourceName %></div>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
<% } else { %>
  <!-- Estado sem poderes -->
  <div class="character-powers-section">
    <div class="powers-empty-state">
      <div class="powers-empty-icon">📜</div>
      <h4 class="powers-empty-title">Nenhum Poder Ativo</h4>
      <p class="powers-empty-description">
        Este personagem ainda não possui poderes especiais.
        <br>
        <a href="/personagens/<%= character.id %>/editar" style="color: var(--accent-gold); text-decoration: none;">
          ✏️ Editar personagem para adicionar poderes
        </a>
      </p>
    </div>
  </div>
<% } %>

<!-- Script para funcionalidade de visualização -->
<script>
document.addEventListener('DOMContentLoaded', function() {

});
</script>
    <!-- História e Personalidade -->
    <% if (character.historia_pessoal || character.personalidade || character.objetivos) { %>
      <div class="background-section">
        <h3>📜 História e Personalidade</h3>
        <div class="background-grid">
          <% if (character.historia_pessoal) { %>
            <div class="background-card">
              <h4>📖 História Pessoal</h4>
              <div class="background-content">
                <p><%= character.historia_pessoal %></p>
              </div>
            </div>
          <% } %>
          
          <% if (character.personalidade) { %>
            <div class="background-card">
              <h4>🎭 Personalidade</h4>
              <div class="background-content">
                <p><%= character.personalidade %></p>
              </div>
            </div>
          <% } %>
          
          <% if (character.objetivos) { %>
            <div class="background-card">
              <h4>🎯 Objetivos e Motivações</h4>
              <div class="background-content">
                <p><%= character.objetivos %></p>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    <% } %>

    <!-- Informações Técnicas -->
    <div class="technical-info">
      <h3>ℹ️ Informações do Sistema</h3>
      <div class="tech-grid">
        <div class="tech-card">
          <h4>📅 Criação</h4>
          <p><%= new Date(character.created_at).toLocaleDateString('pt-BR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) %></p>
        </div>
        
        <% if (character.updated_at && character.updated_at !== character.created_at) { %>
          <div class="tech-card">
            <h4>✏️ Última Edição</h4>
            <p><%= new Date(character.updated_at).toLocaleDateString('pt-BR', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) %></p>
          </div>
        <% } %>
        
        <div class="tech-card">
          <h4>🆔 ID do Personagem</h4>
          <p><code>#<%= character.id %></code></p>
        </div>
      </div>
    </div>

    <!-- Ações Adicionais -->
    <div class="additional-actions">
      <div class="actions-card">
        <h3>🛠️ Ações Disponíveis</h3>
        <div class="actions-grid">
          <button class="action-btn utility-btn" onclick="window.print()">
            🖨️ Imprimir Ficha
          </button>
          
          <button class="action-btn utility-btn" onclick="exportCharacter()">
            📥 Exportar Dados
          </button>
          
          <button class="action-btn utility-btn" onclick="shareCharacter()">
            📤 Compartilhar
          </button>
          
          <button class="action-btn danger-btn" onclick="confirmDelete()">
            🗑️ Excluir Personagem
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal de Confirmação de Exclusão -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>⚠️ Confirmar Exclusão</h3>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir o personagem <strong><%= character.nome %></strong>?</p>
        <p class="warning-text">Esta ação não pode ser desfeita!</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
        <button class="btn btn-danger" onclick="deleteCharacter()">🗑️ Excluir Personagem</button>
      </div>
    </div>
  </div>

<% } else { %>
  <!-- Personagem não encontrado -->
  <section class="content-section active">
    <div class="error-state">
      <div class="error-card">
        <div class="error-icon">😔</div>
        <h2>Personagem Não Encontrado</h2>
        <p>O personagem que você está procurando não existe ou você não tem permissão para visualizá-lo.</p>
        <div class="error-actions">
          <a href="/personagens" class="nav-btn">📋 Meus Personagens</a>
          <a href="/personagens/criar" class="btn btn-secondary">✨ Criar Novo</a>
        </div>
      </div>
    </div>
  </section>
<% } %>

<!-- Script específico para visualização de personagem -->
<script src="/scripts/character-view.js"></script>

<%- include('../partials/footer') %>